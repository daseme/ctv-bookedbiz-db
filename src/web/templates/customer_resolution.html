{% extends "base.html" %}

{% block title %}Customer Resolution - SpotOps{% endblock %}
{% block header_title %}Customer Resolution{% endblock %}
{% block header_subtitle %}Create customer records for unmatched bill codes{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">›</span>
<span>Data Management</span>
<span class="breadcrumb-separator">›</span>
<a href="/entity-resolution">Entity Resolution</a>
<span class="breadcrumb-separator">›</span>
<span class="breadcrumb-current">Customer Resolution</span>
{% endblock %}

{% block extra_styles %}
<style>
  .stats-row{display:flex;gap:16px;margin-bottom:20px}
  .stat{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:14px 18px}
  .stat .val{font-size:24px;font-weight:700}
  .stat .lbl{font-size:12px;color:#64748b;margin-top:2px}
  .stat.good{background:#ecfdf5;border-color:#34d399}
  .stat.warn{background:#fef3c7;border-color:#f59e0b}
  
  .filter-bar{display:flex;gap:12px;margin-bottom:16px;align-items:center}
  .filter-bar input,.filter-bar select{padding:8px 12px;border:1px solid #cbd5e1;border-radius:6px}
  .filter-bar button{padding:8px 16px;border-radius:6px;cursor:pointer;border:1px solid #e2e8f0;background:#fff}
  .filter-bar button:hover{background:#f8fafc}
  
  .resolution-table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden}
  .resolution-table th{background:#f8fafc;padding:12px;text-align:left;font-weight:600;font-size:13px;border-bottom:1px solid #e2e8f0}
  .resolution-table td{padding:12px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
  .resolution-table tr:hover{background:#fafafa}
  .resolution-table tr.resolved{opacity:0.4;background:#f0fdf4}
  
  .bill-code{font-family:ui-monospace,monospace;font-size:13px;color:#334155}
  .normalized{font-size:13px;color:#0f172a}
  .normalized .diff{color:#0ea5e9;font-weight:500}
  .meta{font-size:11px;color:#94a3b8}
  
  .revenue{font-weight:600;text-align:right}
  .revenue.negative{color:#ef4444}
  
  .actions{display:flex;gap:6px}
  .actions button{padding:6px 12px;border-radius:5px;font-size:12px;cursor:pointer;border:1px solid}
  .btn-create{background:#0ea5e9;border-color:#0284c7;color:#fff}
  .btn-create:hover{background:#0284c7}
  .btn-link{background:#fff;border-color:#e2e8f0;color:#334155}
  .btn-link:hover{background:#f8fafc}
  .btn-skip{background:transparent;border-color:transparent;color:#94a3b8}
  
  .link-form{display:none;margin-top:8px}
  .link-form.active{display:flex;gap:8px;align-items:center}
  .link-form input{padding:6px 10px;border:1px solid #cbd5e1;border-radius:5px;font-size:12px;width:200px}
  .normalized-input{padding:4px 8px;border:1px solid #e2e8f0;border-radius:4px;font-size:13px;width:300px}
.normalized-input:focus{border-color:#0ea5e9;outline:none}
  .empty{text-align:center;padding:40px;color:#64748b}

  /* Similar-customer warning overlay */
  .similar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;align-items:center;justify-content:center}
  .similar-overlay.active{display:flex}
  .similar-box{background:#fff;border-radius:10px;padding:24px;max-width:520px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,.18)}
  .similar-box h3{margin:0 0 12px;font-size:16px;color:#0f172a}
  .similar-box .match{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid #e2e8f0;border-radius:6px;margin-bottom:8px;cursor:pointer}
  .similar-box .match:hover{background:#f0f9ff;border-color:#0ea5e9}
  .similar-box .match .name{font-weight:600;font-size:14px}
  .similar-box .match .info{font-size:12px;color:#64748b}
  .similar-box .match .score{font-size:13px;font-weight:600;color:#0ea5e9}
  .similar-box .btns{display:flex;gap:8px;margin-top:16px;justify-content:flex-end}
  .similar-box .btns button{padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;border:1px solid}
  .btn-proceed{background:#f59e0b;border-color:#d97706;color:#fff}
  .btn-proceed:hover{background:#d97706}
  .btn-cancel-similar{background:#fff;border-color:#e2e8f0;color:#334155}
  .btn-cancel-similar:hover{background:#f8fafc}
</style>
{% endblock %}

{% block content %}
<div class="stats-row" id="stats"></div>

<div class="filter-bar">
  <input type="text" id="search" placeholder="Search bill codes...">
  <select id="min-revenue">
    <option value="0">All revenue</option>
    <option value="100">≥ $100</option>
    <option value="500" selected>≥ $500</option>
    <option value="1000">≥ $1,000</option>
    <option value="5000">≥ $5,000</option>
  </select>
  <button id="refresh">↻ Refresh</button>
  <a href="/customer-aliases">Customer Aliases</a>
</div>

<table class="resolution-table">
  <thead>
    <tr>
      <th style="width:35%">Bill Code → Normalized Name</th>
      <th style="width:15%">Revenue</th>
      <th style="width:10%">Spots</th>
      <th style="width:15%">Date Range</th>
      <th style="width:25%">Actions</th>
    </tr>
  </thead>
  <tbody id="tbody">
    <tr><td colspan="5" class="empty">Loading...</td></tr>
  </tbody>
</table>
<div class="similar-overlay" id="similar-overlay">
  <div class="similar-box">
    <h3>Similar customers found</h3>
    <p style="font-size:13px;color:#64748b;margin:0 0 12px">Did you mean one of these? Click a match to link instead.</p>
    <div id="similar-matches"></div>
    <div class="btns">
      <button class="btn-cancel-similar" id="similar-cancel">Cancel</button>
      <button class="btn-proceed" id="similar-proceed">Create Anyway</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const API = '/api/customer-resolution';
  
  async function loadStats() {
    const r = await fetch(`${API}/stats`);
    const s = await r.json();
    document.getElementById('stats').innerHTML = `
      <div class="stat good">
        <div class="val">${s.resolution_rate}%</div>
        <div class="lbl">Resolution rate</div>
      </div>
      <div class="stat">
        <div class="val">${s.resolved.toLocaleString()}</div>
        <div class="lbl">Resolved</div>
      </div>
      <div class="stat warn">
        <div class="val">${s.unresolved.toLocaleString()}</div>
        <div class="lbl">Unresolved</div>
      </div>
      <div class="stat warn">
        <div class="val">$${s.unresolved_revenue.toLocaleString(undefined, {maximumFractionDigits:0})}</div>
        <div class="lbl">Unresolved revenue</div>
      </div>
    `;
  }
  
  async function loadTable() {
    const minRev = document.getElementById('min-revenue').value;
    const search = document.getElementById('search').value.trim();
    const tbody = document.getElementById('tbody');
    
    const r = await fetch(`${API}/unresolved?min_revenue=${minRev}`);
    let items = await r.json();
    
    if (search) {
      const q = search.toLowerCase();
      items = items.filter(i => 
        i.bill_code.toLowerCase().includes(q) || 
        i.normalized_name.toLowerCase().includes(q)
      );
    }
    
    if (!items.length) {
      tbody.innerHTML = `<tr><td colspan="5" class="empty">
        <div style="padding:20px">
          <div style="font-size:18px;margin-bottom:8px">All customers resolved!</div>
          <div style="color:#64748b;font-size:14px">No unmatched bill codes found matching your filters.</div>
          <div style="margin-top:16px"><a href="/customer-aliases" style="color:#0ea5e9">Manage existing customers and aliases &rarr;</a></div>
        </div>
      </td></tr>`;
      return;
    }
    
    tbody.innerHTML = items.map(i => renderRow(i)).join('');
    attachHandlers();
  }
  
  function renderRow(item) {
    const isDifferent = item.bill_code !== item.normalized_name;
    const normalizedDisplay = `<span class="diff">→</span> <input type="text" class="normalized-input" value="${esc(item.normalized_name)}">`;
    
    const revClass = item.revenue < 0 ? 'revenue negative' : 'revenue';
    
    return `
      <tr data-bill-code="${esc(item.bill_code)}" data-normalized="${esc(item.normalized_name)}">
        <td>
          <div class="bill-code">${esc(item.bill_code)}</div>
          <div class="normalized">${normalizedDisplay}</div>
        </td>
        <td class="${revClass}">$${item.revenue.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
        <td>${item.spot_count}</td>
        <td class="meta">${item.first_seen || '?'} – ${item.last_seen || '?'}</td>
        <td>
          <div class="actions">
            <button class="btn-create" title="Create customer with normalized name">Create Customer</button>
            <button class="btn-link" title="Link to different existing customer">Link...</button>
            <button class="btn-skip" title="Skip for now">Skip</button>
          </div>
          <div class="link-form">
            <input type="text" placeholder="Search customers..." list="cust-list-${esc(item.bill_code)}">
            <datalist id="cust-list-${esc(item.bill_code)}"></datalist>
            <input type="hidden" class="cust-id">
            <button class="btn-create">Link</button>
            <button class="btn-skip">Cancel</button>
          </div>
        </td>
      </tr>
    `;
  }
  
  function attachHandlers() {
    // Create button
    document.querySelectorAll('.btn-create').forEach(btn => {
      if (btn.closest('.link-form')) return;
      btn.addEventListener('click', async function() {
        const row = this.closest('tr');
        const billCode = row.dataset.billCode;
        const normalized = row.querySelector('.normalized-input').value.trim();
        if (!normalized) { alert('Normalized name cannot be empty'); return; }
        await createCustomer(row, billCode, normalized);
      });
    });
    
    // Link button (show form)
    document.querySelectorAll('.btn-link').forEach(btn => {
      btn.addEventListener('click', function() {
        const row = this.closest('tr');
        row.querySelector('.actions').style.display = 'none';
        row.querySelector('.link-form').classList.add('active');
        row.querySelector('.link-form input[type="text"]').focus();
      });
    });
    
    // Link form search
    document.querySelectorAll('.link-form input[type="text"]').forEach(input => {
      let timeout;
      input.addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(async () => {
          const q = input.value.trim();
          if (q.length < 2) return;
          const r = await fetch(`${API}/search?q=${encodeURIComponent(q)}`);
          const customers = await r.json();
          const dl = input.nextElementSibling;
          dl.innerHTML = customers.map(c => 
            `<option value="${esc(c.normalized_name)}" data-id="${c.customer_id}">`
          ).join('');
        }, 200);
      });
      input.addEventListener('change', () => {
        const dl = input.nextElementSibling;
        const opt = dl.querySelector(`option[value="${input.value}"]`);
        if (opt) {
          input.closest('.link-form').querySelector('.cust-id').value = opt.dataset.id;
        }
      });
    });
    
    // Link form submit
    document.querySelectorAll('.link-form .btn-create').forEach(btn => {
      btn.addEventListener('click', async function() {
        const row = this.closest('tr');
        const billCode = row.dataset.billCode;
        const custId = row.querySelector('.cust-id').value;
        if (!custId) { alert('Select a customer first'); return; }
        await linkCustomer(row, billCode, parseInt(custId));
      });
    });
    
    // Cancel link / Skip
    document.querySelectorAll('.btn-skip').forEach(btn => {
      btn.addEventListener('click', function() {
        const row = this.closest('tr');
        const linkForm = row.querySelector('.link-form');
        if (linkForm.classList.contains('active')) {
          linkForm.classList.remove('active');
          row.querySelector('.actions').style.display = 'flex';
        } else {
          row.style.display = 'none';
        }
      });
    });
  }
  
  async function createCustomer(row, billCode, normalized) {
    row.style.opacity = '0.5';
    try {
      // Pre-creation similarity check
      const chk = await fetch(`${API}/check-similar`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ normalized_name: normalized })
      });
      const chkData = await chk.json();

      if (chkData.similar && chkData.similar.length > 0) {
        row.style.opacity = '1';
        const choice = await showSimilarWarning(chkData.similar, billCode, normalized);
        if (choice === 'cancel') return;
        if (choice && choice !== 'proceed') {
          // User chose to link to an existing customer
          await linkCustomer(row, billCode, parseInt(choice));
          return;
        }
        row.style.opacity = '0.5';
      }

      const r = await fetch(`${API}/create`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ bill_code: billCode, normalized_name: normalized })
      });
      const result = await r.json();
      if (!r.ok || !result.success) throw new Error(result.error || 'Failed');

      row.classList.add('resolved');
      row.querySelector('.actions').innerHTML = `<span class="meta">✓ Created${result.alias_created ? ' + alias' : ''}</span>`;
      loadStats();
    } catch (e) {
      row.style.opacity = '1';
      alert('Error: ' + e.message);
    }
  }

  function showSimilarWarning(matches, billCode, normalized) {
    return new Promise(resolve => {
      const overlay = document.getElementById('similar-overlay');
      const container = document.getElementById('similar-matches');
      container.innerHTML = matches.map(m => `
        <div class="match" data-id="${m.customer_id}">
          <div>
            <div class="name">${esc(m.normalized_name)}</div>
            <div class="info">${m.match_type} match &middot; ID ${m.customer_id}</div>
          </div>
          <div class="score">${Math.round(m.score * 100)}%</div>
        </div>
      `).join('');
      overlay.classList.add('active');

      function cleanup() {
        overlay.classList.remove('active');
        document.getElementById('similar-cancel').removeEventListener('click', onCancel);
        document.getElementById('similar-proceed').removeEventListener('click', onProceed);
        container.querySelectorAll('.match').forEach(el => el.removeEventListener('click', onMatch));
      }
      function onCancel() { cleanup(); resolve('cancel'); }
      function onProceed() { cleanup(); resolve('proceed'); }
      function onMatch(e) {
        const id = e.currentTarget.dataset.id;
        cleanup();
        resolve(id);
      }
      document.getElementById('similar-cancel').addEventListener('click', onCancel);
      document.getElementById('similar-proceed').addEventListener('click', onProceed);
      container.querySelectorAll('.match').forEach(el => el.addEventListener('click', onMatch));
    });
  }
  
  async function linkCustomer(row, billCode, customerId) {
    row.style.opacity = '0.5';
    try {
      const r = await fetch(`${API}/link`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ bill_code: billCode, customer_id: customerId })
      });
      const result = await r.json();
      if (!r.ok || !result.success) throw new Error(result.error || 'Failed');
      
      row.classList.add('resolved');
      row.querySelector('.link-form').classList.remove('active');
      row.querySelector('.actions').style.display = 'flex';
      row.querySelector('.actions').innerHTML = `<span class="meta">✓ Linked to ${esc(result.normalized_name)}</span>`;
      loadStats();
    } catch (e) {
      row.style.opacity = '1';
      alert('Error: ' + e.message);
    }
  }
  
  function esc(s) {
    return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  
  document.getElementById('refresh').addEventListener('click', () => { loadStats(); loadTable(); });
  document.getElementById('min-revenue').addEventListener('change', loadTable);
  document.getElementById('search').addEventListener('input', loadTable);
  
  loadStats();
  loadTable();
})();
</script>
{% endblock %}
