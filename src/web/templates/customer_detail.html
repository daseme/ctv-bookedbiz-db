{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">›</span>
<span>Reporting</span>
<span class="breadcrumb-separator">›</span>
<span class="breadcrumb-current">Customer Detail</span>
{% endblock %}

{% block header_title %}{{ report.summary.normalized_name }}{% endblock %}
{% block header_subtitle %}Customer Revenue Analysis and Performance Tracking{% endblock %}

{% block extra_styles %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
    .customer-meta-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        margin-bottom: 24px;
        padding: 16px 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #4a5568;
    }
    
    .meta-label {
        font-weight: 500;
        color: #718096;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .badge-sector { background: var(--nord10); color: white; }
    .badge-agency { background: var(--nord15); color: white; }
    .badge-active { background: var(--nord14); color: white; }
    .badge-inactive { background: var(--nord11); color: white; }
    
    .activity-dates {
        margin-left: auto;
        text-align: right;
        font-size: 13px;
        color: #718096;
    }
    
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    
    .kpi-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border-left: 4px solid var(--nord8);
    }
    
    .kpi-card.positive { border-left-color: var(--nord14); }
    .kpi-card.negative { border-left-color: var(--nord11); }
    
    .kpi-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--nord0);
        margin-bottom: 4px;
    }
    
    .kpi-label {
        font-size: 11px;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .kpi-sub {
        font-size: 12px;
        color: #718096;
        margin-top: 4px;
    }
    
    .kpi-change {
        font-size: 13px;
        font-weight: 600;
        margin-top: 4px;
    }
    .kpi-change.positive { color: var(--nord14); }
    .kpi-change.negative { color: var(--nord11); }
    
    .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }
    
    @media (max-width: 1000px) {
        .content-grid { grid-template-columns: 1fr; }
    }
    
    .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .card-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e2e8f0;
        font-weight: 600;
        color: var(--nord0);
        font-size: 14px;
    }
    
    .card-body {
        padding: 20px;
    }
    
    .card-body.no-padding {
        padding: 0;
    }
    
    .chart-container {
        position: relative;
        height: 280px;
        padding: 16px;
    }
    
    .breakdown-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .breakdown-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .breakdown-item:last-child {
        border-bottom: none;
    }
    
    .breakdown-item:hover {
        background: #f8fafc;
    }
    
    .breakdown-name {
        font-weight: 500;
        color: var(--nord0);
    }
    
    .breakdown-stats {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .breakdown-value {
        font-weight: 600;
        color: var(--nord0);
        font-variant-numeric: tabular-nums;
    }
    
    .breakdown-pct {
        font-size: 13px;
        color: #718096;
        min-width: 50px;
        text-align: right;
    }
    
    .breakdown-bar {
        width: 60px;
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        overflow: hidden;
    }
    
    .breakdown-bar-fill {
        height: 100%;
        background: var(--nord8);
        border-radius: 3px;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    
    .data-table th {
        background: var(--nord5);
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #718096;
    }
    
    .data-table th.number { text-align: right; }
    
    .data-table td {
        padding: 10px 16px;
        border-bottom: 1px solid #f1f5f9;
        color: #4a5568;
    }
    
    .data-table td.number {
        text-align: right;
        font-variant-numeric: tabular-nums;
    }
    
    .data-table tr:hover td {
        background: #f8fafc;
    }
    
    .alias-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 16px 20px;
    }
    
    .alias-tag {
        background: var(--nord5);
        color: var(--nord0);
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 13px;
        font-family: monospace;
    }
    
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--nord10);
        text-decoration: none;
        font-size: 14px;
        margin-bottom: 16px;
    }
    
    .back-link:hover {
        color: var(--nord9);
        text-decoration: underline;
    }

    .date-filter-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 16px;
        padding: 12px 20px;
        background: var(--nord0);
        border-radius: 8px;
    }

    .date-filter-bar label {
        font-size: 14px;
        color: white;
        font-weight: 500;
        white-space: nowrap;
    }

    .date-filter-bar input[type="date"] {
        padding: 6px 12px;
        border: 1px solid rgba(255,255,255,0.5);
        border-radius: 4px;
        background: white;
        color: #2d3748;
        font-size: 14px;
    }

    .date-filter-bar button {
        padding: 6px 16px;
        border: none;
        border-radius: 4px;
        background: var(--nord10);
        color: white;
        font-size: 14px;
        cursor: pointer;
        font-weight: 500;
    }

    .date-filter-bar button:hover {
        background: var(--nord9);
    }

    .date-filter-bar .reset-link {
        padding: 6px 16px;
        border: 1px solid rgba(255,255,255,0.5);
        border-radius: 4px;
        background: transparent;
        color: white;
        font-size: 14px;
        text-decoration: none;
        font-weight: 500;
    }

    .date-filter-bar .reset-link:hover {
        background: rgba(255,255,255,0.1);
    }

    .date-range-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        background: var(--nord10);
        color: white;
        margin-left: auto;
    }
</style>
{% endblock %}

{% block content %}
<a href="javascript:history.back()" class="back-link">← Back</a>

<form method="GET" class="date-filter-bar">
    <label for="start_date">Start Date:</label>
    <input type="date" id="start_date" name="start_date" value="{{ start_date }}">
    <label for="end_date">End Date:</label>
    <input type="date" id="end_date" name="end_date" value="{{ end_date }}">
    <button type="submit">Apply</button>
    <a href="{{ request.path }}" class="reset-link">Reset</a>
    {% if report.date_range_label %}
    <span class="date-range-badge">{{ report.date_range_label }}</span>
    {% endif %}
</form>

<div class="customer-meta-bar">
    {% if report.summary.sector_name %}
    <div class="meta-item">
        <span class="badge badge-sector">{{ report.summary.sector_code }}</span>
        <span>{{ report.summary.sector_name }}</span>
    </div>
    {% endif %}
    
    {% if report.summary.agency_name %}
    <div class="meta-item">
        <span class="badge badge-agency">Agency</span>
        <span>{{ report.summary.agency_name }}</span>
    </div>
    {% endif %}
    
    {% if report.summary.primary_ae %}
    <div class="meta-item">
        <span class="meta-label">Primary AE:</span>
        <strong>{{ report.summary.primary_ae }}</strong>
    </div>
    {% endif %}
    
    <div class="meta-item">
        <span class="badge {{ 'badge-active' if report.summary.is_active else 'badge-inactive' }}">
            {{ 'Active' if report.summary.is_active else 'Inactive' }}
        </span>
    </div>
    
    <div class="activity-dates">
        {% if report.summary.first_air_date %}
        <div>First activity: {{ report.summary.first_air_date }}</div>
        {% endif %}
        {% if report.summary.last_air_date %}
        <div>Last activity: {{ report.summary.last_air_date }}</div>
        {% endif %}
    </div>
</div>

<div class="kpi-grid">
    <div class="kpi-card">
        <div class="kpi-value">${{ "{:,.0f}".format(report.summary.lifetime_gross) }}</div>
        <div class="kpi-label">{{ "Gross Revenue" if report.has_date_filter else "Lifetime Gross Revenue" }}</div>
        <div class="kpi-sub">{{ "{:,}".format(report.summary.lifetime_spots) }} spots</div>
    </div>

    {% if not report.has_date_filter %}
    <div class="kpi-card">
        <div class="kpi-value">${{ "{:,.0f}".format(report.period_comparison.current_year_gross) }}</div>
        <div class="kpi-label">{{ report.period_comparison.current_year }} YTD</div>
        {% if report.period_comparison.gross_change_pct is not none %}
        <div class="kpi-change {{ 'positive' if report.period_comparison.gross_change_pct >= 0 else 'negative' }}">
            {{ "▲" if report.period_comparison.gross_change_pct >= 0 else "▼" }}
            {{ "{:.1f}".format(report.period_comparison.gross_change_pct|abs) }}% vs {{ report.period_comparison.current_year - 1 }}
        </div>
        {% endif %}
    </div>

    <div class="kpi-card">
        <div class="kpi-value">${{ "{:,.0f}".format(report.period_comparison.prior_year_gross) }}</div>
        <div class="kpi-label">{{ report.period_comparison.current_year - 1 }} Full Year</div>
        <div class="kpi-sub">{{ "{:,}".format(report.period_comparison.prior_year_spots) }} spots</div>
    </div>
    {% endif %}

    <div class="kpi-card">
        <div class="kpi-value">${{ "{:,.0f}".format(report.summary.lifetime_net) }}</div>
        <div class="kpi-label">{{ "Net Revenue" if report.has_date_filter else "Lifetime Net Revenue" }}</div>
        <div class="kpi-sub">{{ "{:,}".format(report.summary.lifetime_spots) }} spots</div>
    </div>

    <div class="kpi-card">
        <div class="kpi-value">${{ "{:,.2f}".format(report.summary.avg_spot_rate) }}</div>
        <div class="kpi-label">Avg Spot Rate</div>
        <div class="kpi-sub">{{ "filtered range" if report.has_date_filter else "lifetime average" }}</div>
    </div>
</div>

<div class="content-grid">
    <div class="card">
        <div class="card-header">Monthly Gross Revenue</div>
        <div class="chart-container">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">Revenue by Language</div>
        <div class="card-body no-padding">
            {% if report.language_breakdown %}
            <ul class="breakdown-list">
                {% for lang in report.language_breakdown[:6] %}
                <li class="breakdown-item">
                    <span class="breakdown-name">{{ lang.language_name or lang.language_code }}</span>
                    <div class="breakdown-stats">
                        <div class="breakdown-bar">
                            <div class="breakdown-bar-fill" style="width: {{ lang.pct_of_total }}%"></div>
                        </div>
                        <span class="breakdown-value">${{ "{:,.0f}".format(lang.gross_revenue) }}</span>
                        <span class="breakdown-pct">{{ "{:.1f}".format(lang.pct_of_total) }}%</span>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p style="padding: 20px; color: #718096;">No language data available</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="content-grid">
    <div class="card">
        <div class="card-header">Revenue by Account Executive</div>
        <div class="card-body no-padding">
            {% if report.ae_breakdown %}
            <ul class="breakdown-list">
                {% for ae in report.ae_breakdown[:6] %}
                <li class="breakdown-item">
                    <span class="breakdown-name">{{ ae.ae_name }}</span>
                    <div class="breakdown-stats">
                        <div class="breakdown-bar">
                            <div class="breakdown-bar-fill" style="width: {{ ae.pct_of_total }}%"></div>
                        </div>
                        <span class="breakdown-value">${{ "{:,.0f}".format(ae.gross_revenue) }}</span>
                        <span class="breakdown-pct">{{ "{:.1f}".format(ae.pct_of_total) }}%</span>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p style="padding: 20px; color: #718096;">No AE data available</p>
            {% endif %}
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">Revenue by Market</div>
        <div class="card-body no-padding">
            {% if report.market_breakdown %}
            <ul class="breakdown-list">
                {% for mkt in report.market_breakdown[:6] %}
                <li class="breakdown-item">
                    <span class="breakdown-name">{{ mkt.market_name }} <span style="color: #718096;">({{ mkt.market_code }})</span></span>
                    <div class="breakdown-stats">
                        <div class="breakdown-bar">
                            <div class="breakdown-bar-fill" style="width: {{ mkt.pct_of_total }}%"></div>
                        </div>
                        <span class="breakdown-value">${{ "{:,.0f}".format(mkt.gross_revenue) }}</span>
                        <span class="breakdown-pct">{{ "{:.1f}".format(mkt.pct_of_total) }}%</span>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p style="padding: 20px; color: #718096;">No market data available</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">Recent Activity</div>
    <div class="card-body no-padding">
        {% if report.recent_spots %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Air Date</th>
                    <th>Month</th>
                    <th>Time</th>
                    <th>Length</th>
                    <th>Language</th>
                    <th>Market</th>
                    <th>AE</th>
                    <th class="number">Gross</th>
                    <th class="number">Net</th>
                </tr>
            </thead>
            <tbody>
                {% for spot in report.recent_spots %}
                <tr>
                    <td>{{ spot.air_date }}</td>
                    <td>{{ spot.broadcast_month }}</td>
                    <td style="font-family: monospace;">{{ spot.time_in or '-' }}</td>
                    <td>{{ spot.length_seconds or '-' }}</td>
                    <td>{{ spot.language_code or '-' }}</td>
                    <td>{{ spot.market_code or '-' }}</td>
                    <td>{{ spot.sales_person or '-' }}</td>
                    <td class="number">${{ "{:,.2f}".format(spot.gross_rate) }}</td>
                    <td class="number">${{ "{:,.2f}".format(spot.station_net) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="padding: 20px; color: #718096;">No recent activity</p>
        {% endif %}
    </div>
</div>

{% if report.bill_code_aliases %}
<div class="card">
    <div class="card-header">Bill Code Aliases ({{ report.bill_code_aliases|length }})</div>
    <div class="alias-list">
        {% for alias in report.bill_code_aliases %}
        <span class="alias-tag">{{ alias.alias_name }}</span>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('revenueChart');
    if (!ctx) return;
    
    const monthlyData = {{ report.monthly_trend | tojson }};
    const labels = monthlyData.map(m => m.broadcast_month);
    const grossData = monthlyData.map(m => parseFloat(m.gross_revenue));
    
    new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Gross Revenue',
                data: grossData,
                backgroundColor: 'rgba(94, 129, 172, 0.8)',
                borderColor: '#5E81AC',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    ticks: { maxRotation: 45 },
                    grid: { display: false }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    },
                    grid: { color: '#f1f5f9' }
                }
            }
        }
    });
});
</script>
{% endblock %}