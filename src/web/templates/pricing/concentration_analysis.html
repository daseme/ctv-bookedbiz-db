{# src/web/templates/pricing/concentration_analysis.html #}
{# Refactored to use unified layout with existing Bootstrap-like classes #}
{% extends "pricing/_pricing_layout.html" %}

{% block pricing_title %}Revenue Concentration{% endblock %}

{% block pricing_subtitle %}Analyze customer diversification with Herfindahl-Hirschman Index{% endblock %}

{% block pricing_header_extra %}
<span class="badge bg-primary dimension-badge">{{ year }}</span>
{% endblock %}

{% block pricing_content %}
{# Controls - using existing card/form classes #}
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <form method="GET" class="row g-3">
          <div class="col-md-4">
            <label for="year" class="form-label">Analysis Year</label>
            <select name="year" id="year" class="form-select">
              {% for y in available_years %}
              <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-arrow-clockwise"></i> Update Analysis
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% if not metrics %}
{# No Data - using existing alert classes #}
<div class="row">
  <div class="col-12">
    <div class="alert alert-warning">
      <h5 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> No Concentration Data Available</h5>
      <p class="mb-0">No revenue data found for {{ year }}. Try selecting a different year with closed months.</p>
    </div>
  </div>
</div>
{% else %}

{# Key Metrics - using existing stats-row classes #}
<div class="stats-row">
  <div class="stat-card {{ 'negative' if metrics.herfindahl_index > 0.25 else ('neutral' if metrics.herfindahl_index > 0.15 else 'positive') }}">
    <div class="stat-value">{{ metrics.hhi_formatted }}</div>
    <div class="stat-label">Herfindahl Index (HHI)</div>
    <div class="stat-change">
      <span class="badge {{ 'bg-danger' if metrics.herfindahl_index > 0.25 else ('bg-warning' if metrics.herfindahl_index > 0.15 else 'bg-success') }}">
        {{ metrics.concentration_risk }}
      </span>
    </div>
  </div>
  
  <div class="stat-card">
    <div class="stat-value text-danger">{{ metrics.top_10_percentage|round(1) }}%</div>
    <div class="stat-label">Top 10 Customers</div>
    <div class="stat-change">${{ (metrics.top_10_revenue / 1000)|round(1) }}K</div>
  </div>
  
  <div class="stat-card">
    <div class="stat-value text-warning">{{ metrics.top_20_percentage|round(1) }}%</div>
    <div class="stat-label">Top 20 Customers</div>
    <div class="stat-change">${{ (metrics.top_20_revenue / 1000)|round(1) }}K</div>
  </div>
  
  <div class="stat-card neutral">
    <div class="stat-value">{{ metrics.total_customers }}</div>
    <div class="stat-label">Active Customers</div>
    <div class="stat-change">${{ (metrics.total_revenue / 1000)|round(1) }}K total</div>
  </div>
</div>

{# HHI Guide - using existing card classes #}
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-info-circle"></i> Understanding the Herfindahl-Hirschman Index</h5>
        <p class="card-text mb-3">
          HHI measures concentration by summing squared market shares. Range: 0 (perfect diversity) to 1 (monopoly).
        </p>
        <div class="row">
          <div class="col-md-4">
            <div class="alert alert-success mb-0 py-2">
              <strong>HHI &lt; 0.15: Well Diversified</strong>
              <br><small>Low concentration risk</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="alert alert-warning mb-0 py-2">
              <strong>HHI 0.15-0.25: Moderate Risk</strong>
              <br><small>Monitor top customers</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="alert mb-0 py-2" style="background: rgba(191, 97, 106, 0.15); border-color: var(--nord11);">
              <strong class="text-danger">HHI &gt; 0.25: High Risk</strong>
              <br><small>Revenue heavily dependent on few</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{# Trend Chart #}
{% if trend and trend|length > 1 %}
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Concentration Trend Over Time</h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="concentrationTrendChart"></canvas>
        </div>
        <p class="text-muted text-center small mt-2">
          <i class="bi bi-info-circle"></i> Lower HHI values indicate improving diversification
        </p>
      </div>
    </div>
  </div>
</div>
{% endif %}

{# Top Customers Table - using existing table classes #}
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-people"></i> Top 50 Customers by Revenue</h5>
        <button class="btn btn-sm btn-outline-light" onclick="exportTableToCSV()">
          <i class="bi bi-download"></i> Export
        </button>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 500px;">
          <table class="table table-hover mb-0" id="customersTable">
            <thead class="table-light" style="position: sticky; top: 0;">
              <tr>
                <th style="width: 70px;" class="text-center">Rank</th>
                <th>Customer</th>
                <th class="text-end" style="width: 120px;">Revenue</th>
                <th style="width: 220px;">% of Total</th>
                <th class="text-end" style="width: 100px;">Cumulative</th>
              </tr>
            </thead>
            <tbody>
              {% set cumulative = namespace(value=0) %}
              {% for customer in top_customers %}
              {% set cumulative.value = cumulative.value + customer.percentage_of_total %}
              <tr>
                <td class="text-center">
                  <span class="rank-badge {{ 'rank-top10' if customer.rank <= 10 else ('rank-top20' if customer.rank <= 20 else 'rank-other') }}">
                    {{ customer.rank }}
                  </span>
                </td>
                <td><strong>{{ customer.customer_name }}</strong></td>
                <td class="text-end">{{ customer.revenue_formatted }}</td>
                <td>
                  <div class="revenue-bar-container">
                    <div class="revenue-bar" style="width: {{ [customer.percentage_of_total * 10, 100]|min }}%;">
                      {{ customer.percentage_formatted }}
                    </div>
                  </div>
                </td>
                <td class="text-end {{ 'text-warning fw-bold' if cumulative.value >= 80 else '' }}">
                  {{ cumulative.value|round(1) }}%
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer">
        <strong>80/20 Rule:</strong> 
        {% set top_for_80 = namespace(count=0, cumulative=0) %}
        {% for customer in top_customers %}
          {% set top_for_80.cumulative = top_for_80.cumulative + customer.percentage_of_total %}
          {% if top_for_80.cumulative < 80 %}
            {% set top_for_80.count = top_for_80.count + 1 %}
          {% endif %}
        {% endfor %}
        Top {{ top_for_80.count }} customers represent 80% of revenue
      </div>
    </div>
  </div>
</div>

{# Insights - using existing card classes with border styling #}
<div class="row g-4">
  <div class="col-md-6">
    <div class="card shadow-sm h-100 border-start border-success border-4">
      <div class="card-body">
        <h5 class="card-title text-success"><i class="bi bi-check-circle"></i> Healthy Indicators</h5>
        <ul class="list-unstyled mb-0">
          <li class="mb-2"><i class="bi bi-check text-success"></i> HHI below 0.15 indicates excellent diversification</li>
          <li class="mb-2"><i class="bi bi-check text-success"></i> Top 10 customers representing less than 30% of revenue</li>
          <li class="mb-2"><i class="bi bi-check text-success"></i> No single customer exceeding 10% of total revenue</li>
          <li class="mb-2"><i class="bi bi-check text-success"></i> Steady or growing total customer count YoY</li>
        </ul>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm h-100 border-start border-danger border-4">
      <div class="card-body">
        <h5 class="card-title text-danger"><i class="bi bi-exclamation-triangle"></i> Warning Signs</h5>
        <ul class="list-unstyled mb-0">
          <li class="mb-2"><i class="bi bi-x text-danger"></i> HHI above 0.25 signals dangerous concentration</li>
          <li class="mb-2"><i class="bi bi-x text-danger"></i> Top 3 customers exceeding 50% of total revenue</li>
          <li class="mb-2"><i class="bi bi-x text-danger"></i> Any single customer representing over 15% of revenue</li>
          <li class="mb-2"><i class="bi bi-x text-danger"></i> Increasing HHI trend over time</li>
        </ul>
      </div>
    </div>
  </div>
</div>

{% endif %}
{% endblock %}

{% block pricing_scripts %}
{% if trend and trend|length > 1 %}
<script>
const trendData = {
  labels: {{ trend|map(attribute='period')|list|tojson }},
  datasets: [{
    label: 'Herfindahl Index',
    data: {{ trend|map(attribute='herfindahl_index')|list|tojson }},
    borderColor: '#5e81ac',
    backgroundColor: 'rgba(94, 129, 172, 0.1)',
    borderWidth: 3,
    tension: 0.4,
    fill: true,
    pointRadius: 6,
    pointBackgroundColor: '#5e81ac',
    pointBorderColor: '#fff',
    pointBorderWidth: 2
  }]
};

new Chart(document.getElementById('concentrationTrendChart'), {
  type: 'line',
  data: trendData,
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        callbacks: {
          label: ctx => {
            let risk = ctx.parsed.y > 0.25 ? ' (High Risk)' : ctx.parsed.y > 0.15 ? ' (Moderate)' : ' (Well Diversified)';
            return 'HHI: ' + ctx.parsed.y.toFixed(4) + risk;
          }
        }
      }
    },
    scales: {
      x: { grid: { display: false } },
      y: { beginAtZero: true, max: 0.5, ticks: { callback: v => v.toFixed(2) } }
    }
  }
});
</script>
{% endif %}

<script>
function exportTableToCSV() {
  const table = document.getElementById('customersTable');
  if (!table) return;
  let csv = [];
  table.querySelectorAll('tr').forEach(row => {
    const cells = [];
    row.querySelectorAll('th, td').forEach(cell => {
      cells.push('"' + cell.textContent.trim().replace(/"/g, '""') + '"');
    });
    csv.push(cells.join(','));
  });
  const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'concentration_{{ year }}.csv';
  a.click();
}
</script>
{% endblock %}