<!-- src/web/templates/customer_normalization_manager.html -->
{% extends "base.html" %}

{% block title %}Customer Normalization Audit - CTV Reports{% endblock %}
{% block header_title %}Customer Normalization Audit{% endblock %}
{% block header_subtitle %}Raw bill codes ‚Üí canonical normalized names (IAS + Branded Content); PROD/PRODUCTION stripped{% endblock %}

{% block extra_styles %}
<style>
  .norm-wrap{display:flex;flex-direction:column;gap:16px}
  .stats-bar{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
  .stat{padding:12px;border:1px solid #e2e8f0;border-radius:8px;background:#fff}
  .stat .v{font-size:20px;font-weight:700}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .controls input,.controls select,.controls button{padding:8px 10px;border:1px solid #cbd5e1;border-radius:6px;background:#fff;cursor:pointer}
  .table-container{border:1px solid #e2e8f0;border-radius:8px;overflow:auto;max-height:70vh;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid #e2e8f0;padding:10px;text-align:left;font-weight:600}
  tbody td{border-bottom:1px solid #f1f5f9;padding:8px;vertical-align:top;white-space:nowrap}
  .badge{padding:2px 8px;border-radius:999px;border:1px solid #cbd5e1;font-size:12px}
  .ok{background:#ecfdf5;border-color:#34d399}
  .warn{background:#fff7ed;border-color:#f59e0b}
  .err{background:#fef2f2;border-color:#ef4444}
  .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .pagination{display:flex;justify-content:space-between;align-items:center;padding:8px}
  .pagination button{padding:8px 12px;border:1px solid #cbd5e1;border-radius:6px;background:#fff;cursor:pointer}
  .sticky-first thead th:first-child,
  .sticky-first tbody td:first-child{position:sticky;left:0;background:#fff;z-index:1}
  .dim{color:#64748b}

  /* Modal */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(560px,92vw);background:#fff;border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
  .modal-header,.modal-footer{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #e2e8f0}
  .modal-footer{border-top:1px solid #e2e8f0;border-bottom:none}
  .modal-body{padding:12px 14px;display:flex;flex-direction:column;gap:10px}
  .modal-header h3{margin:0;font-size:16px}
  .modal-body label{display:flex;flex-direction:column;gap:6px}
  .modal-body input[type="text"], .modal-body input:not([type]), .modal-body select{padding:8px 10px;border:1px solid #cbd5e1;border-radius:6px}
  .modal-header button,.modal-footer button{padding:8px 12px;border:1px solid #cbd5e1;border-radius:6px;background:#fff;cursor:pointer}
  .action-btn.primary{background:#0ea5e9;border-color:#0284c7;color:#fff}
</style>
{% endblock %}

{% block content %}
<div class="norm-wrap">
  <div class="stats-bar">
    <div class="stat"><div class="v" id="s-total">-</div><div class="dim">Total rows</div></div>
    <div class="stat"><div class="v" id="s-exists">-</div><div class="dim">In customers</div></div>
    <div class="stat"><div class="v" id="s-ias">-</div><div class="dim">Seen: Internal Ad Sales</div></div>
    <div class="stat"><div class="v" id="s-bc">-</div><div class="dim">Seen: Branded Content</div></div>
    <div class="stat"><div class="v" id="s-conflicts">-</div><div class="dim">Alias conflicts</div></div>
  </div>

  <div class="controls">
    <input id="q" placeholder="Search raw/normalized/customer‚Ä¶" style="min-width:280px">
    <select id="status">
      <option value="all">All statuses</option>
      <option value="exists">In customers</option>
      <option value="missing">Missing in customers</option>
      <option value="conflict">Alias conflicts</option>
    </select>
    <select id="rev">
      <option value="all">All rev types</option>
      <option value="IAS">Internal Ad Sales</option>
      <option value="BC">Branded Content</option>
    </select>
    <select id="sort">
      <option value="raw_az">Raw A‚ÜíZ</option>
      <option value="raw_za">Raw Z‚ÜíA</option>
      <option value="norm_az">Normalized A‚ÜíZ</option>
      <option value="norm_za">Normalized Z‚ÜíA</option>
      <option value="status">Status</option>
      <option value="rev">Revenue Type</option>
      <option value="created_desc">Recently Created</option>
    </select>
    <select id="size">
      <option>25</option><option>50</option><option>100</option><option>200</option>
    </select>
    <button id="btn-refresh">Refresh</button>
    <button id="btn-export">Export CSV</button>

    <!-- Actions -->
    <button id="canon-open" class="action-btn primary">‚ûï Canonize agency</button>
    <button id="canon-customer-open" class="action-btn">üß© Canonize customer</button>
    <button id="map-raw-open" class="action-btn">üîó Map raw ‚Üí normalized</button>
    <button id="create-customer-open" class="action-btn">‚ûï Create customer</button>
  </div>

  <div class="table-container">
    <table class="sticky-first" id="grid">
      <thead>
        <tr>
          <th style="min-width:340px">Raw</th>
          <th style="min-width:340px">Normalized</th>
          <th style="min-width:220px">Customer</th>
          <th style="min-width:220px">Agency 1</th>
          <th style="min-width:220px">Agency 2</th>
          <th style="min-width:200px">Revenue Types Seen</th>
          <th style="min-width:160px">Status</th>
          <th style="min-width:160px">Customer ID</th>
          <th style="min-width:160px">Created</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="9" class="dim">Loading‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>

  <div class="pagination">
    <div id="page-info" class="dim">‚Äì</div>
    <div>
      <button id="prev">‚Üê Prev</button>
      <button id="next">Next ‚Üí</button>
    </div>
  </div>
</div>

<!-- Existing: Agency canon modal -->
<div id="canon-modal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3>Canonize Agency</h3>
      <button type="button" id="canon-close-x" aria-label="Close">√ó</button>
    </div>
    <div class="modal-body">
      <label>Alias (as seen in raw):
        <input id="canon-alias" placeholder="e.g., iGRAPHIX">
      </label>
      <label>Canonical:
        <input id="canon-name" placeholder="e.g., iGraphix">
      </label>
      <label style="flex-direction:row;align-items:center;gap:8px">
        <input type="checkbox" id="canon-entity" checked> <span>Also add entity alias</span>
      </label>
      <div id="canon-status" class="text-sm mt-2"></div>
    </div>
    <div class="modal-footer">
      <button type="button" id="canon-cancel">Cancel</button>
      <button type="button" id="canon-save" class="action-btn primary">Save</button>
    </div>
  </div>
</div>

<!-- Customer-tail canon modal -->
<div id="canon-customer-modal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3>Canonize Customer (tail)</h3>
      <button type="button" id="canon-customer-close" aria-label="Close">√ó</button>
    </div>
    <div class="modal-body">
      <label>Alias (tail as seen in raw):
        <input id="cust-alias" placeholder="e.g., Mc'Donald's">
      </label>
      <label>Canonical (tail):
        <input id="cust-canonical" placeholder="e.g., McDonald's">
      </label>
      <div id="cust-status" class="text-sm mt-2"></div>
    </div>
    <div class="modal-footer">
      <button type="button" id="canon-customer-cancel">Cancel</button>
      <button type="button" id="canon-customer-save" class="action-btn primary">Save</button>
    </div>
  </div>
</div>

<!-- Raw ‚Üí normalized modal -->
<div id="map-raw-modal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3>Map Raw ‚Üí Normalized Customer</h3>
      <button type="button" id="map-raw-close" aria-label="Close">√ó</button>
    </div>
    <div class="modal-body">
      <label>Raw string (exact):
        <input id="map-raw" placeholder="e.g., Admerasia Inc.:McDonald's">
      </label>
      <label>Target normalized_name (existing in customers.normalized_name):
        <input id="map-target" placeholder="e.g., Admerasia:McDonald's" list="normalized-suggest">
        <datalist id="normalized-suggest"></datalist>
      </label>
      <div class="dim">Tip: target must exist in <code>customers.normalized_name</code>.</div>
      <div id="map-status" class="text-sm mt-2"></div>
    </div>
    <div class="modal-footer">
      <button type="button" id="map-raw-cancel">Cancel</button>
      <button type="button" id="map-raw-save" class="action-btn primary">Save</button>
    </div>
  </div>
</div>

<!-- Create customer modal -->
<div id="create-customer-modal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3>Create New Customer</h3>
      <button type="button" id="create-customer-close" aria-label="Close">√ó</button>
    </div>
    <div class="modal-body">
      <label>Normalized Name:
        <input id="create-customer-name" placeholder="e.g., Health Plan of San Joaquin">
      </label>
      <label>Sector (optional):
        <select id="create-customer-sector">
          <option value="">‚Äî No sector ‚Äî</option>
        </select>
      </label>
      <div id="create-customer-status" class="text-sm mt-2"></div>
    </div>
    <div class="modal-footer">
      <button type="button" id="create-customer-cancel">Cancel</button>
      <button type="button" id="create-customer-save" class="action-btn primary">Create</button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/customer-normalization-manager.js') }}"></script>

<script>
(() => {
  const $ = (q) => document.querySelector(q);

  // ========== Agency canon ==========
  const openAgency = () => { $("#canon-modal").style.display = "flex"; $("#canon-alias").focus(); };
  const closeAgency = () => { $("#canon-modal").style.display = "none"; $("#canon-status").textContent = ""; };
  const submitAgency = async () => {
    const alias = $("#canon-alias").value.trim();
    const canonical = $("#canon-name").value.trim();
    const create_entity_alias = $("#canon-entity")?.checked ?? true;
    if (!alias || !canonical) { $("#canon-status").textContent = "Alias and Canonical are required."; return; }
    $("#canon-status").textContent = "Saving‚Ä¶";
    try {
      const r = await fetch("/api/canon/agency", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ alias, canonical, create_entity_alias })
      });
      const j = await r.json();
      if (!r.ok || !j.success) throw new Error(j.error || ("HTTP " + r.status));
      $("#canon-status").textContent = `Mapped '${j.alias}' ‚Üí '${j.canonical}' (affects ~${j.affected_preview}).`;
      setTimeout(() => location.reload(), 600);
    } catch (e) { $("#canon-status").textContent = "Error: " + e.message; }
  };
  $("#canon-open")?.addEventListener("click", openAgency);
  $("#canon-close-x")?.addEventListener("click", closeAgency);
  $("#canon-cancel")?.addEventListener("click", closeAgency);
  $("#canon-save")?.addEventListener("click", submitAgency);
  ["#canon-alias","#canon-name"].forEach(s => $(s)?.addEventListener("keydown",(e)=>{ if(e.key==="Enter") submitAgency(); }));

  // ========== Customer-tail canon ==========
  const openCust = () => { $("#canon-customer-modal").style.display = "flex"; $("#cust-alias").focus(); };
  const closeCust = () => { $("#canon-customer-modal").style.display = "none"; $("#cust-status").textContent = ""; };
  const saveCust = async () => {
    const alias = $("#cust-alias").value.trim();
    const canonical = $("#cust-canonical").value.trim();
    if (!alias || !canonical) { $("#cust-status").textContent = "Both fields are required."; return; }
    $("#cust-status").textContent = "Saving‚Ä¶";
    try {
      const r = await fetch("/api/canon/customer", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ alias, canonical })
      });
      const j = await r.json();
      if (!r.ok || !j.success) throw new Error(j.error || ("HTTP " + r.status));
      $("#cust-status").textContent = `Mapped tail '${j.alias}' ‚Üí '${j.canonical}' (affects ~${j.affected_preview}).`;
      setTimeout(() => location.reload(), 600);
    } catch (e) { $("#cust-status").textContent = "Error: " + e.message; }
  };
  $("#canon-customer-open")?.addEventListener("click", openCust);
  $("#canon-customer-close")?.addEventListener("click", closeCust);
  $("#canon-customer-cancel")?.addEventListener("click", closeCust);
  $("#canon-customer-save")?.addEventListener("click", saveCust);
  ["#cust-alias","#cust-canonical"].forEach(s => $(s)?.addEventListener("keydown",(e)=>{ if(e.key==="Enter") saveCust(); }));

  // ========== Raw ‚Üí normalized mapping ==========
  const openMap = () => { $("#map-raw-modal").style.display = "flex"; $("#map-raw").focus(); };
  const closeMap = () => { $("#map-raw-modal").style.display = "none"; $("#map-status").textContent = ""; };

  const suggest = (() => {
    let inflight = 0;
    return async (q) => {
      if (!q || q.length < 2) { $("#normalized-suggest")?.replaceChildren(); return; }
      const id = ++inflight;
      try {
        const r = await fetch(`/api/canon/suggest/normalized?q=${encodeURIComponent(q)}`);
        if (id !== inflight || !r.ok) return;
        const list = $("#normalized-suggest");
        if (!list) return;
        list.innerHTML = "";
        (await r.json()).forEach(v => {
          const o = document.createElement("option"); o.value = v; list.appendChild(o);
        });
      } catch { /* ignore */ }
    };
  })();
  $("#map-target")?.addEventListener("input", (e) => suggest(e.target.value.trim()));

  const saveMap = async () => {
    const raw = $("#map-raw").value.trim();
    const normalized_name = $("#map-target").value.trim();
    if (!raw || !normalized_name) { $("#map-status").textContent = "Both fields are required."; return; }
    $("#map-status").textContent = "Saving‚Ä¶";
    try {
      const r = await fetch("/api/canon/raw-to-customer", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ raw, normalized_name })
      });
      const j = await r.json();
      if (!r.ok || !j.success) throw new Error(j.error || ("HTTP " + r.status));
      $("#map-status").textContent = `Mapped raw ‚Üí '${j.normalized_name}'.`;

      const row = document.querySelector(`tr[data-raw="${CSS.escape(raw)}"]`);
      if (row) {
        const normCell = row.querySelector("td:nth-child(2)");
        if (normCell) normCell.textContent = j.normalized_name;
        row.classList.add("ok");
        setTimeout(() => row.classList.remove("ok"), 1200);
      } else {
        setTimeout(() => location.reload(), 600);
      }
      setTimeout(() => closeMap(), 200);
    } catch (e) {
      $("#map-status").textContent = "Error: " + e.message;
    }
  };
  $("#map-raw-open")?.addEventListener("click", openMap);
  $("#map-raw-close")?.addEventListener("click", closeMap);
  $("#map-raw-cancel")?.addEventListener("click", closeMap);
  $("#map-raw-save")?.addEventListener("click", saveMap);
  ["#map-raw","#map-target"].forEach(s => $(s)?.addEventListener("keydown",(e)=>{ if(e.key==="Enter") saveMap(); }));

  // ========== Create customer ==========
  const openCreateCust = async () => {
    $("#create-customer-modal").style.display = "flex";
    $("#create-customer-name").focus();
    const select = $("#create-customer-sector");
    if (select && select.options.length <= 1) {
      try {
        const r = await fetch("/api/canon/sectors");
        if (r.ok) {
          const sectors = await r.json();
          sectors.forEach(s => {
            const opt = document.createElement("option");
            opt.value = s.sector_id;
            opt.textContent = `${s.sector_code} - ${s.sector_name}`;
            select.appendChild(opt);
          });
        }
      } catch { /* ignore */ }
    }
  };
  const closeCreateCust = () => {
    $("#create-customer-modal").style.display = "none";
    $("#create-customer-status").textContent = "";
  };
  const saveCreateCust = async () => {
    const normalized_name = $("#create-customer-name").value.trim();
    const sector_id = $("#create-customer-sector").value || null;
    if (!normalized_name) {
      $("#create-customer-status").textContent = "Normalized name is required.";
      return;
    }
    $("#create-customer-status").textContent = "Creating‚Ä¶";
    try {
      const payload = { normalized_name };
      if (sector_id) payload.sector_id = parseInt(sector_id, 10);
      const r = await fetch("/api/canon/create-customer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!r.ok || !j.success) throw new Error(j.error || ("HTTP " + r.status));
      $("#create-customer-status").textContent = `Created '${j.normalized_name}' (ID: ${j.customer_id})`;
      $("#create-customer-name").value = "";
      setTimeout(() => { closeCreateCust(); location.reload(); }, 800);
    } catch (e) {
      $("#create-customer-status").textContent = "Error: " + e.message;
    }
  };
  $("#create-customer-open")?.addEventListener("click", openCreateCust);
  $("#create-customer-close")?.addEventListener("click", closeCreateCust);
  $("#create-customer-cancel")?.addEventListener("click", closeCreateCust);
  $("#create-customer-save")?.addEventListener("click", saveCreateCust);
  $("#create-customer-name")?.addEventListener("keydown", (e) => { if (e.key === "Enter") saveCreateCust(); });

  // ========== Close on overlay click ==========
  ["#canon-modal","#canon-customer-modal","#map-raw-modal","#create-customer-modal"].forEach(id=>{
    $(id)?.addEventListener("click",(ev)=>{ if(ev.target===ev.currentTarget) ev.currentTarget.style.display="none"; });
  });
})();
</script>

{% endblock %}