{% extends "base.html" %}

{% block title %}{{ title }} - CTV Reports{% endblock %}

{% block header_title %}{{ title }}{% endblock %}
{% block header_subtitle %}Pipeline-focused revenue management and forecasting{% endblock %}

{% block extra_styles %}
<style>
/* Pipeline Revenue Management Styles */
.pipeline-container {
    margin: 0 auto;
    padding: 24px;
    max-width: 1400px;
}

/* Header Section */
.pipeline-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
}

.header-info h1 {
    margin: 0;
    font-size: 28px;
    font-weight: 700;
}

.header-info .subtitle {
    margin: 4px 0 0 0;
    font-size: 16px;
    opacity: 0.9;
}

.session-info {
    text-align: right;
}

.session-date {
    font-size: 14px;
    opacity: 0.8;
}

.session-progress {
    font-size: 18px;
    font-weight: 600;
    margin-top: 4px;
}

/* AE Selection Bar */
.ae-selector-bar {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.selector-content {
    display: flex;
    align-items: center;
    gap: 24px;
    flex-wrap: wrap;
}

.ae-selection {
    display: flex;
    align-items: center;
    gap: 12px;
}

.ae-selection label {
    font-weight: 600;
    color: #374151;
    white-space: nowrap;
}

.ae-dropdown {
    min-width: 200px;
    padding: 10px 16px;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-size: 16px;
    background: white;
    color: #374151;
    cursor: pointer;
}

.ae-dropdown:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.ae-stats {
    display: flex;
    gap: 24px;
    align-items: center;
    flex-wrap: wrap;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 18px;
    font-weight: 700;
    color: #1f2937;
}

.stat-label {
    font-size: 12px;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.completion-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-dots {
    display: flex;
    gap: 4px;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #e5e7eb;
}

.status-dot.completed {
    background: #10b981;
}

.status-dot.current {
    background: #3b82f6;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Monthly Summary Cards with Quarterly Summaries */
.monthly-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 32px;
}

.quarterly-row {
    display: contents;
}

@media (max-width: 1200px) {
    .monthly-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

.month-card, .quarter-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.quarter-card {
    background: #f8fafc;
    border: 2px solid #3b82f6;
    border-left: 6px solid #3b82f6;
}

.quarter-card .month-header {
    background: #f8fafc;
    color: #3b82f6;
}

.empty-slot {
    opacity: 0.3;
    pointer-events: none;
}

.empty-slot .month-header {
    background: #f9fafb;
    color: #9ca3af;
}

.month-card:hover {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

/* Past months (Jan-May) - Closed/Historical */
.month-card.past-month {
    background: #f0fff4;
    border-left: 6px solid #2f855a;
    border-color: #2f855a;
}

.month-card.past-month .month-header {
    background: #f0fff4;
    color: #2f855a;
}

/* Current month (June) - Active */
.month-card.current-month {
    background: #fef5e7;
    border-left: 6px solid #d69e2e;
    border-color: #d69e2e;
}

.month-card.current-month .month-header {
    background: #fef5e7;
    color: #d69e2e;
}

/* Future months (July-Dec) - Open for planning */
.month-card.future-month {
    background: #f7fafc;
    border-left: 6px solid #4a5568;
    border-color: #4a5568;
}

.month-card.future-month .month-header {
    background: #f7fafc;
    color: #4a5568;
}

.month-card.status-ahead {
    border-left: 6px solid #2f855a;
}

.month-card.status-on_track {
    border-left: 6px solid #d69e2e;
}

.month-card.status-behind {
    border-left: 6px solid #ef4444;
}

.month-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.month-title {
    font-size: 18px;
    font-weight: 700;
    color: #1f2937;
}

.month-status {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-ahead {
    background: #dcfce7;
    color: #166534;
}

.status-on_track {
    background: #fef3c7;
    color: #92400e;
}

.status-behind {
    background: #fef2f2;
    color: #b91c1c;
}

.revenue-metrics {
    margin-bottom: 16px;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.metric-label {
    font-size: 13px;
    color: #6b7280;
}

.metric-value {
    font-weight: 600;
    color: #1f2937;
}

.metric-value.booked {
    color: #059669;
}

.metric-value.pipeline {
    color: #3b82f6;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    transition: background 0.2s;
}

.metric-value.pipeline:hover {
    background: #f3f4f6;
}

.metric-value.pipeline.editing {
    background: #fef3c7;
    color: #92400e;
}

.metric-value.expected {
    color: #7c3aed;
}

.metric-value.budget {
    color: #6b7280;
    font-size: 12px;
}

.pipeline-input {
    width: 80px;
    padding: 2px 6px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-weight: 600;
    text-align: right;
}

.gap-analysis {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
}

.gap-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.gap-primary {
    font-weight: 700;
    color: #1f2937;
}

.gap-secondary {
    font-size: 12px;
    color: #6b7280;
}

.gap-amount {
    font-weight: 600;
}

.gap-amount.positive {
    color: #059669;
}

.gap-amount.negative {
    color: #dc2626;
}

.card-actions {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 11px;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.btn-secondary:hover {
    background: #4b5563;
}

.last-updated {
    font-size: 10px;
    color: #9ca3af;
}

/* Review Actions */
.review-actions {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 24px;
}

.actions-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
}

.notes-section {
    flex: 1;
    min-width: 300px;
}

.notes-textarea {
    width: 100%;
    min-height: 60px;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    resize: vertical;
    font-family: inherit;
}

.action-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
}

.btn-success {
    background: #10b981;
    color: white;
}

.btn-success:hover {
    background: #059669;
}

/* Customer Details Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background: white;
    margin: 3% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    background: #f8fafc;
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
}

.close {
    color: #9ca3af;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    padding: 4px;
}

.close:hover {
    color: #374151;
}

.modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.search-box {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    margin-bottom: 16px;
    font-size: 14px;
}

.tabs {
    display: flex;
    border-bottom: 1px solid #e2e8f0;
    margin-bottom: 16px;
}

.tab {
    padding: 8px 16px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 14px;
    color: #6b7280;
    border-bottom: 2px solid transparent;
}

.tab.active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.deals-table {
    width: 100%;
    border-collapse: collapse;
}

.deals-table th {
    background: #f9fafb;
    padding: 8px 12px;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 1px solid #e5e7eb;
    font-size: 12px;
    text-transform: uppercase;
}

.deals-table td {
    padding: 8px 12px;
    border-bottom: 1px solid #f3f4f6;
    font-size: 13px;
}

.deals-table tr:hover {
    background: #f9fafb;
}

.deal-amount {
    font-weight: 600;
    text-align: right;
}

.deal-status {
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-closed_won {
    background: #dcfce7;
    color: #166534;
}

.status-committed {
    background: #dbeafe;
    color: #1e40af;
}

.status-pipeline {
    background: #fef3c7;
    color: #92400e;
}

/* Loading States */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f3f4f6;
    border-top: 2px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Alert Messages */
.alert {
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 16px;
    font-size: 14px;
}

.alert-success {
    background: #dcfce7;
    border: 1px solid #bbf7d0;
    color: #166534;
}

.alert-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #b91c1c;
}

/* Status legend matching Report5 */
.status-legend {
    display: flex;
    justify-content: center;
    gap: 24px;
    margin: 16px 0;
    padding: 12px;
    background: #f7fafc;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
}

.legend-badge {
    padding: 2px 8px;
    border-radius: 3px;
    font-weight: 600;
    font-size: 10px;
}

.legend-past {
    background-color: #f0fff4;
    color: #2f855a;
}

.legend-current {
    background-color: #fef5e7;
    color: #d69e2e;
}

.legend-future {
    background-color: #f7fafc;
    color: #4a5568;
}

/* Disabled pipeline inputs for past months */
.metric-value.disabled {
    color: #9ca3af !important;
    cursor: not-allowed !important;
    opacity: 0.6;
}

/* Responsive Design */
@media (max-width: 768px) {
    .monthly-grid {
        grid-template-columns: 1fr;
    }
    
    .selector-content {
        flex-direction: column;
        align-items: stretch;
    }
    
    .ae-stats {
        justify-content: space-around;
    }
    
    .header-content {
        flex-direction: column;
        text-align: center;
    }
    
    .actions-content {
        flex-direction: column;
        align-items: stretch;
    }
    
    .status-legend {
        flex-direction: column;
        gap: 8px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="pipeline-container">
    <!-- Header Section -->
    <div class="pipeline-header">
        <div class="header-content">
            <div class="header-info">
                <h1>Pipeline Revenue Management</h1>
                <p class="subtitle">Focus on pipeline forecasting and gap analysis</p>
            </div>
            <div class="session-info">
                <div class="session-date">Review Session: {{ data.session_date }}</div>
                <div class="session-progress" id="session-progress">
                    <span id="completed-count">{{ data.session.completed_aes|length }}</span> 
                    of {{ data.session.total_aes }} AEs Reviewed
                </div>
            </div>
        </div>
    </div>

    <!-- AE Selection Bar -->
    <div class="ae-selector-bar">
        <div class="selector-content">
            <div class="ae-selection">
                <label for="ae-selector">Account Executive:</label>
                <select id="ae-selector" class="ae-dropdown">
                    <option value="">Select an AE to review...</option>
                    {% for ae in data.ae_list %}
                    <option value="{{ ae.ae_id }}" data-name="{{ ae.name }}">{{ ae.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="ae-stats" id="ae-stats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-value" id="total-revenue">-</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="ytd-attainment">-</div>
                    <div class="stat-label">YTD Attainment</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avg-deal-size">-</div>
                    <div class="stat-label">Avg Deal Size</div>
                </div>
            </div>
            
            <div class="completion-indicator">
                <div class="status-dots" id="status-dots">
                    {% for ae in data.ae_list %}
                    <div class="status-dot" data-ae-id="{{ ae.ae_id }}" 
                         title="{{ ae.name }}"></div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Month Status Legend -->
    <div class="status-legend">
        <div class="legend-item">
            <span class="legend-badge legend-past">PAST</span>
            <span>Historical months (Jan-May) - Closed for changes</span>
        </div>
        <div class="legend-item">
            <span class="legend-badge legend-current">CURRENT</span>
            <span>Current month (June) - Active for updates</span>
        </div>
        <div class="legend-item">
            <span class="legend-badge legend-future">FUTURE</span>
            <span>Future months (July-Dec) - Open for pipeline planning</span>
        </div>
    </div>

    <!-- Monthly Revenue Cards -->
    <div id="monthly-grid" class="monthly-grid" style="display: none;">
        <!-- Cards will be populated dynamically -->
    </div>

    <!-- Review Actions -->
    <div class="review-actions" id="review-actions" style="display: none;">
        <div class="actions-content">
            <div class="notes-section">
                <label for="review-notes">Review Notes:</label>
                <textarea id="review-notes" class="notes-textarea" 
                         placeholder="Add notes about this AE's pipeline review..."></textarea>
            </div>
            <div class="action-buttons">
                <button type="button" class="btn btn-secondary" onclick="saveProgress()">
                    Save Progress
                </button>
                <button type="button" class="btn btn-success" onclick="markComplete()">
                    Mark Complete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Customer Details Modal -->
<div id="customer-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Customer Details</h3>
            <span class="close" onclick="closeCustomerModal()">&times;</span>
        </div>
        <div class="modal-body">
            <input type="text" id="customer-search" class="search-box" 
                   placeholder="Search customers and deals...">
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('booked')">Booked Revenue</button>
                <button class="tab" onclick="switchTab('pipeline')">Pipeline</button>
                <button class="tab" onclick="switchTab('all')">All Deals</button>
            </div>
            
            <div id="booked-content" class="tab-content active">
                <table class="deals-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Spots</th>
                            <th>Revenue</th>
                            <th>First Spot</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="booked-deals">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div id="pipeline-content" class="tab-content">
                <table class="deals-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Deal Description</th>
                            <th>Amount</th>
                            <th>Probability</th>
                            <th>Expected Close</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="pipeline-deals">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div id="all-content" class="tab-content">
                <table class="deals-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Spots</th>
                            <th>Revenue</th>
                            <th>First Spot</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="all-deals">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1001;">
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('Pipeline Revenue Management JavaScript loading...');

// Global state
let currentAE = null;
let currentMonthlyData = [];
let currentQuarterlyData = [];
let sessionData = {{ data.session | tojson }};
let originalPipelineValues = {}; // Track original values for change detection

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Pipeline Revenue Management page loaded');
    updateCompletionStatus();
    setupEventListeners();
});

function setupEventListeners() {
    // AE selector change
    document.getElementById('ae-selector').addEventListener('change', function() {
        const aeId = this.value;
        if (aeId) {
            loadAEData(aeId);
        } else {
            hideAEData();
        }
    });

    // Customer search
    document.getElementById('customer-search').addEventListener('input', function() {
        filterCustomerData(this.value);
    });
}

async function loadAEData(aeId) {
    try {
        showLoading(true);
        
        // Get AE summary data
        const response = await fetch(`/api/ae/${aeId}/summary`);
        const result = await response.json();
        
        if (result.success) {
            currentAE = result.data.ae_info;
            currentMonthlyData = result.data.monthly_summary;
            currentQuarterlyData = result.data.quarterly_summary || [];
            
            displayAEStats(currentAE);
            displayMonthlyCards(currentMonthlyData, currentQuarterlyData);
            showAEData();
            
            // Store original pipeline values for change tracking
            originalPipelineValues = {};
            currentMonthlyData.forEach(month => {
                originalPipelineValues[month.month] = month.current_pipeline;
            });
            
        } else {
            showAlert('error', result.error || 'Failed to load AE data');
        }
    } catch (error) {
        console.error('Error loading AE data:', error);
        showAlert('error', 'Failed to load AE data');
    } finally {
        showLoading(false);
    }
}

function displayAEStats(ae) {
    // Calculate attainment percentage from new data
    const attainment = ae.attainment_percentage ? Math.round(ae.attainment_percentage) : 0;
    const avgDeal = ae.avg_deal_size ? formatCurrency(ae.avg_deal_size) : '$0';
    const totalRevenue = ae.total_revenue ? formatCurrency(ae.total_revenue) : '$0';
    
    document.getElementById('ytd-attainment').textContent = `${attainment}%`;
    document.getElementById('avg-deal-size').textContent = avgDeal;
    document.getElementById('total-revenue').textContent = totalRevenue;
}

function calculatePipelineRisk() {
    if (!currentMonthlyData || currentMonthlyData.length === 0) return 'Low';
    
    const behindCount = currentMonthlyData.filter(m => m.pipeline_status === 'behind').length;
    const totalMonths = currentMonthlyData.length;
    
    if (behindCount / totalMonths > 0.5) return 'High';
    if (behindCount / totalMonths > 0.25) return 'Medium';
    return 'Low';
}

function displayMonthlyCards(monthlyData, quarterlyData = []) {
    const grid = document.getElementById('monthly-grid');
    grid.innerHTML = '';
    
    // Define quarters with their months arranged in 4-column rows
    const quarters = [
        { name: 'Q1 2025', months: ['2025-01', '2025-02', '2025-03'], rowMonths: ['2025-01', '2025-02', '2025-03'] },
        { name: 'Q2 2025', months: ['2025-04', '2025-05', '2025-06'], rowMonths: ['2025-04', '2025-05', '2025-06'] },
        { name: 'Q3 2025', months: ['2025-07', '2025-08', '2025-09'], rowMonths: ['2025-07', '2025-08', '2025-09'] },
        { name: 'Q4 2025', months: ['2025-10', '2025-11', '2025-12'], rowMonths: ['2025-10', '2025-11', '2025-12'] }
    ];
    
    quarters.forEach(quarter => {
        // Add 3 monthly card slots for this quarter row
        quarter.rowMonths.forEach(monthStr => {
            if (monthStr) {
                const month = monthlyData.find(m => m.month === monthStr);
                if (month) {
                    const card = createMonthCard(month);
                    grid.appendChild(card);
                } else {
                    // Add empty placeholder if month data is missing
                    const emptyCard = document.createElement('div');
                    emptyCard.className = 'month-card empty-slot';
                    emptyCard.innerHTML = '<div class="month-header"><div class="month-title">No Data</div></div>';
                    grid.appendChild(emptyCard);
                }
            } else {
                // Add empty placeholder for visual alignment
                const emptyCard = document.createElement('div');
                emptyCard.className = 'month-card empty-slot';
                emptyCard.style.visibility = 'hidden';
                grid.appendChild(emptyCard);
            }
        });
        
        // Add quarterly summary card as the 4th column
        const quarterData = quarterlyData.find(q => q.quarter_name === quarter.name);
        if (quarterData) {
            const quarterCard = createQuarterCard(quarterData);
            grid.appendChild(quarterCard);
        } else {
            // Add empty placeholder if quarter data is missing
            const emptyCard = document.createElement('div');
            emptyCard.className = 'quarter-card empty-slot';
            emptyCard.innerHTML = '<div class="month-header"><div class="month-title">No Quarter Data</div></div>';
            grid.appendChild(emptyCard);
        }
    });
}

function createMonthCard(month) {
    const card = document.createElement('div');
    card.className = `month-card status-${month.pipeline_status}`;
    
    // Classify month based on current date (June 2025)
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth() + 1; // June = 6
    const currentYear = currentDate.getFullYear(); // 2025
    
    // Extract month and year from month string (e.g., "2025-06")
    const [monthYear, monthNum] = month.month.split('-');
    const monthNumber = parseInt(monthNum);
    const yearNumber = parseInt(monthYear);
    
    if (yearNumber < currentYear || (yearNumber === currentYear && monthNumber < currentMonth)) {
        card.classList.add('past-month');
    } else if (yearNumber === currentYear && monthNumber === currentMonth) {
        card.classList.add('current-month');
    } else {
        card.classList.add('future-month');
    }
    
    // Removed pipeline gap calculation since expected_pipeline is no longer used
    
    card.innerHTML = `
        <div class="month-header">
            <div class="month-title">${month.month_display}</div>
            <div class="month-status status-${month.pipeline_status}">
                ${month.pipeline_status.replace('_', ' ')}
            </div>
        </div>
        
        <div class="revenue-metrics">
            <div class="metric-row">
                <span class="metric-label">Booked Revenue:</span>
                <span class="metric-value booked">${formatCurrency(month.booked_revenue)}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Current Pipeline:</span>
                <span class="metric-value pipeline ${monthNumber < currentMonth ? 'disabled' : ''}" 
                      ${monthNumber >= currentMonth ? `onclick="editPipeline('${month.month}', this)"` : ''} 
                      data-original="${month.current_pipeline}">
                    ${formatCurrency(month.current_pipeline)}
                </span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Budget (ref):</span>
                <span class="metric-value budget">${formatCurrency(month.budget)}</span>
            </div>
        </div>
        
        <div class="gap-analysis">
            <div class="gap-row gap-secondary">
                <span>Budget Gap:</span>
                <span class="gap-amount ${month.budget_gap >= 0 ? 'positive' : 'negative'}">
                    ${month.budget_gap >= 0 ? '+' : '-'}${formatCurrency(Math.abs(month.budget_gap))}
                </span>
            </div>
        </div>
        
        <div class="card-actions">
            <button class="btn btn-primary btn-sm" onclick="openCustomerModal('${month.month}')">
                View Customers
            </button>
            ${monthNumber >= currentMonth ? `
            <button class="btn btn-success btn-sm" onclick="markMonthComplete('${month.month}')" 
                    style="margin-left: 8px;" ${month.is_complete ? 'disabled' : ''}>
                ${month.is_complete ? 'Completed ✓' : 'Mark Complete'}
            </button>` : ''}
            <div class="last-updated">
                ${month.last_updated ? 'Updated: ' + formatDate(month.last_updated) : ''}
            </div>
        </div>
    `;
    
    return card;
}

function createQuarterCard(quarter) {
    const card = document.createElement('div');
    card.className = 'quarter-card';
    
    card.innerHTML = `
        <div class="month-header">
            <div class="month-title">${quarter.quarter_name}</div>
            <div class="month-status" style="background: #dbeafe; color: #1e40af;">
                QUARTER TOTAL
            </div>
        </div>
        
        <div class="revenue-metrics">
            <div class="metric-row">
                <span class="metric-label">Booked Revenue:</span>
                <span class="metric-value booked">${formatCurrency(quarter.booked_revenue)}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Current Pipeline:</span>
                <span class="metric-value" style="color: #3b82f6;">
                    ${formatCurrency(quarter.current_pipeline)}
                </span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Budget (ref):</span>
                <span class="metric-value budget">${formatCurrency(quarter.budget)}</span>
            </div>
        </div>
        
        <div class="gap-analysis">
            <div class="gap-row gap-secondary">
                <span>Budget Gap:</span>
                <span class="gap-amount ${quarter.budget_gap >= 0 ? 'positive' : 'negative'}">
                    ${quarter.budget_gap >= 0 ? '+' : '-'}${formatCurrency(Math.abs(quarter.budget_gap))}
                </span>
            </div>
        </div>
        
        <div class="card-actions">
            <div class="quarter-status">
                <strong>${quarter.month_count} months</strong>
                ${quarter.is_complete ? '✓ Complete' : 'In Progress'}
            </div>
        </div>
    `;
    
    return card;
}

async function editPipeline(month, element) {
    const currentValue = parseFloat(element.dataset.original) || 0;
    const input = document.createElement('input');
    input.type = 'number';
    input.className = 'pipeline-input';
    input.value = currentValue;
    input.step = '1000';
    
    element.classList.add('editing');
    element.innerHTML = '';
    element.appendChild(input);
    
    input.focus();
    input.select();
    
    const saveValue = async () => {
        const newValue = parseFloat(input.value) || 0;
        
        if (newValue !== currentValue) {
            try {
                const response = await fetch(`/api/pipeline/${currentAE.ae_id}/${month}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        current_pipeline: newValue,
                        notes: `Updated from ${formatCurrency(currentValue)} to ${formatCurrency(newValue)}`,
                        updated_by: 'user'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the data and refresh the display
                    const monthData = currentMonthlyData.find(m => m.month === month);
                    if (monthData) {
                        monthData.current_pipeline = newValue;
                        // No longer calculating pipeline_gap since we removed expected_pipeline
                        monthData.pipeline_status = 'on_track'; // Default status
                    }
                    
                    // Refresh the entire display
                    displayMonthlyCards(currentMonthlyData, currentQuarterlyData);
                    displayAEStats(currentAE);
                    
                    showAlert('success', 'Pipeline updated successfully');
                } else {
                    showAlert('error', result.error || 'Failed to update pipeline');
                    // Revert to original value
                    element.textContent = formatCurrency(currentValue);
                }
            } catch (error) {
                console.error('Error updating pipeline:', error);
                showAlert('error', 'Failed to update pipeline');
                element.textContent = formatCurrency(currentValue);
            }
        } else {
            element.textContent = formatCurrency(currentValue);
        }
        
        element.classList.remove('editing');
    };
    
    input.addEventListener('blur', saveValue);
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            saveValue();
        } else if (e.key === 'Escape') {
            element.textContent = formatCurrency(currentValue);
            element.classList.remove('editing');
        }
    });
}

// Removed getPipelineStatus function since we no longer calculate pipeline gaps

async function openCustomerModal(month) {
    try {
        const response = await fetch(`/api/customers/${currentAE.ae_id}/${month}`);
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('modal-title').textContent = 
                `${currentAE.name} - ${formatMonthYear(month)} (${data.total_customers} customers)`;
            
            populateCustomerTable('booked-deals', data.customers || []);
            populateCustomerTable('pipeline-deals', []);
            populateCustomerTable('all-deals', data.customers || []);
            
            document.getElementById('customer-modal').style.display = 'block';
        } else {
            showAlert('error', result.error || 'Failed to load customer data');
        }
    } catch (error) {
        console.error('Error loading customer data:', error);
        showAlert('error', 'Failed to load customer data');
    }
}

function populateCustomerTable(tableId, customers) {
    const tbody = document.getElementById(tableId);
    tbody.innerHTML = '';
    
    if (customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">No customers found</td></tr>';
        return;
    }
    
    customers.forEach(customer => {
        const row = document.createElement('tr');
        
        if (tableId === 'pipeline-deals') {
            row.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No pipeline deals from historical data</td></tr>';
        } else {
            row.innerHTML = `
                <td>${customer.customer_name || 'Unknown Customer'}</td>
                <td>${customer.spot_count || 0} spots</td>
                <td class="deal-amount">${formatCurrency(customer.total_revenue || 0)}</td>
                <td>${customer.first_spot ? customer.first_spot.split(' ')[0] : 'N/A'}</td>
                <td><span class="deal-status status-booked">Booked</span></td>
            `;
        }
        
        tbody.appendChild(row);
    });
}

function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tabName}-content`).classList.add('active');
}

function filterCustomerData(searchTerm) {
    const term = searchTerm.toLowerCase();
    document.querySelectorAll('.deals-table tbody tr').forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
    });
}

function closeCustomerModal() {
    document.getElementById('customer-modal').style.display = 'none';
    document.getElementById('customer-search').value = '';
}

function showAEData() {
    document.getElementById('ae-stats').style.display = 'flex';
    document.getElementById('monthly-grid').style.display = 'grid';
    document.getElementById('review-actions').style.display = 'block';
}

function hideAEData() {
    document.getElementById('ae-stats').style.display = 'none';
    document.getElementById('monthly-grid').style.display = 'none';
    document.getElementById('review-actions').style.display = 'none';
}

async function saveProgress() {
    if (!currentAE) return;
    
    try {
        const notes = document.getElementById('review-notes').value;
        sessionData.session_notes[currentAE.ae_id] = notes;
        
        const response = await fetch('/api/review-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_date: sessionData.session_date,
                completed_aes: sessionData.completed_aes,
                notes: sessionData.session_notes
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', 'Progress saved');
        } else {
            showAlert('error', result.error || 'Failed to save progress');
        }
    } catch (error) {
        console.error('Error saving progress:', error);
        showAlert('error', 'Failed to save progress');
    }
}

async function markMonthComplete(month) {
    if (!currentAE) return;
    
    try {
        const response = await fetch(`/api/pipeline/${currentAE.ae_id}/${month}/complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update the month data
            const monthData = currentMonthlyData.find(m => m.month === month);
            if (monthData) {
                monthData.is_complete = true;
                monthData.last_updated = new Date().toISOString();
            }
            
            // Refresh the display
            displayMonthlyCards(currentMonthlyData);
            
            showAlert('success', `${formatMonthYear(month)} marked as complete`);
        } else {
            showAlert('error', result.error || 'Failed to mark month complete');
        }
    } catch (error) {
        console.error('Error marking month complete:', error);
        showAlert('error', 'Failed to mark month complete');
    }
}

async function markComplete() {
    if (!currentAE) {
        showAlert('error', 'No AE selected');
        return;
    }
    
    try {
        // Ensure sessionData exists with proper structure
        if (!sessionData) {
            console.error('sessionData not initialized');
            showAlert('error', 'Session data not available');
            return;
        }
        
        // Initialize arrays/objects if missing
        if (!sessionData.completed_aes) sessionData.completed_aes = [];
        if (!sessionData.session_notes) sessionData.session_notes = {};
        if (!sessionData.session_date) sessionData.session_date = new Date().toISOString().split('T')[0];
        
        // Add AE to completed list if not already there
        if (!sessionData.completed_aes.includes(currentAE.ae_id)) {
            sessionData.completed_aes.push(currentAE.ae_id);
        }
        
        const notes = document.getElementById('review-notes').value || '';
        sessionData.session_notes[currentAE.ae_id] = notes;
        
        // Create a clean payload object
        const payload = {
            session_date: sessionData.session_date,
            completed_aes: sessionData.completed_aes,
            notes: sessionData.session_notes
        };
        
        console.log('Sending payload:', payload);
        
        const response = await fetch('/api/review-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            updateCompletionStatus();
            showAlert('success', `${currentAE.name} review completed successfully`);
            
            // Clear current selection
            document.getElementById('ae-selector').value = '';
            hideAEData();
            currentAE = null;
        } else {
            console.error('Server error:', result.error);
            showAlert('error', result.error || 'Failed to mark complete');
        }
    } catch (error) {
        console.error('Error marking complete:', error);
        showAlert('error', `Failed to mark complete: ${error.message}`);
    }
}

function updateCompletionStatus() {
    // Update dots
    document.querySelectorAll('.status-dot').forEach(dot => {
        const aeId = dot.dataset.aeId;
        dot.classList.remove('completed', 'current');
        
        if (sessionData.completed_aes.includes(aeId)) {
            dot.classList.add('completed');
        } else if (currentAE && currentAE.ae_id === aeId) {
            dot.classList.add('current');
        }
    });
    
    // Update progress counter
    document.getElementById('completed-count').textContent = sessionData.completed_aes.length;
}

function showLoading(show) {
    const container = document.querySelector('.pipeline-container');
    if (show) {
        container.classList.add('loading');
    } else {
        container.classList.remove('loading');
    }
}

function showAlert(type, message) {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    
    container.appendChild(alert);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 4000);
}

// Utility functions
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount || 0);
}

function formatDate(dateString) {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function formatMonthYear(monthString) {
    // Parse "2025-01" format
    const [year, month] = monthString.split('-');
    const date = new Date(parseInt(year), parseInt(month) - 1, 1); // month is 0-indexed in JS
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long'
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('customer-modal');
    if (event.target === modal) {
        closeCustomerModal();
    }
}

console.log('Pipeline Revenue Management JavaScript loaded');
</script>
{% endblock %} 