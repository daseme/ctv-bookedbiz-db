{% extends "nord_base.html" %}

{% block title %}{{ title }} - CTV Reports{% endblock %}

{% block header_title %}{{ title }}{% endblock %}
{% block header_subtitle %}Pipeline-focused revenue management and forecasting{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">›</span>
<span class="breadcrumb-link">Executive</span>
<span class="breadcrumb-separator">›</span>
<span class="breadcrumb-current">Pipeline Revenue Management</span>
{% endblock %}

{% block extra_styles %}
<style>
/* Nord Theme Variables */
:root {
    /* Polar Night */
    --nord0: #2e3440;
    --nord1: #3b4252;
    --nord2: #434c5e;
    --nord3: #4c566a;
    
    /* Snow Storm */
    --nord4: #d8dee9;
    --nord5: #e5e9f0;
    --nord6: #eceff4;
    
    /* Frost */
    --nord7: #8fbcbb;
    --nord8: #88c0d0;
    --nord9: #81a1c1;
    --nord10: #5e81ac;
    
    /* Aurora */
    --nord11: #bf616a;
    --nord12: #d08770;
    --nord13: #ebcb8b;
    --nord14: #a3be8c;
    --nord15: #b48ead;
}

/* Pipeline Revenue Management Nord Styles */
.pipeline-container {
    margin: 0 auto;
    padding: 32px;
    max-width: 1400px;
    background: var(--nord6);
    min-height: 100vh;
}

/* Nordic Ice Header Section */
.pipeline-header {
    background: linear-gradient(135deg, var(--nord0) 0%, var(--nord1) 50%, var(--nord2) 100%);
    background-size: 200% 200%;
    animation: nordGradient 8s ease infinite;
    color: var(--nord6);
    padding: 32px;
    border-radius: 16px;
    margin-bottom: 32px;
    position: relative;
    overflow: hidden;
    box-shadow: 
        0 8px 32px rgba(46, 52, 64, 0.3),
        inset 0 1px 0 rgba(236, 239, 244, 0.1);
}

.pipeline-header::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 30% 70%, rgba(143, 188, 187, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 70% 30%, rgba(136, 192, 208, 0.1) 0%, transparent 50%);
    pointer-events: none;
}

@keyframes nordGradient {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 24px;
    position: relative;
    z-index: 1;
}

.header-info h1 {
    margin: 0;
    font-size: 32px;
    font-weight: 700;
    color: var(--nord6);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.header-info .subtitle {
    margin: 8px 0 0 0;
    font-size: 18px;
    color: var(--nord4);
    opacity: 0.9;
}

.session-info {
    text-align: right;
}

.session-date {
    font-size: 16px;
    color: var(--nord4);
    opacity: 0.8;
}

.session-progress {
    font-size: 20px;
    font-weight: 600;
    margin-top: 8px;
    color: var(--nord6);
}

/* Nordic AE Selection Bar */
.ae-selector-bar {
    background: var(--nord6);
    border: 2px solid var(--nord5);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 32px;
    box-shadow: 
        0 4px 20px rgba(46, 52, 64, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
}

.ae-selector-bar::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, var(--nord8) 0%, transparent 30%);
    opacity: 0.03;
    pointer-events: none;
}

.selector-content {
    display: flex;
    align-items: center;
    gap: 32px;
    flex-wrap: wrap;
    position: relative;
    z-index: 1;
}

.ae-selection {
    display: flex;
    align-items: center;
    gap: 16px;
}

.ae-selection label {
    font-weight: 700;
    color: var(--nord0);
    white-space: nowrap;
    font-size: 16px;
}

.ae-dropdown {
    min-width: 240px;
    padding: 14px 20px;
    border: 2px solid var(--nord5);
    border-radius: 12px;
    font-size: 16px;
    background: var(--nord6);
    color: var(--nord0);
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(46, 52, 64, 0.1);
}

.ae-dropdown:focus {
    outline: none;
    border-color: var(--nord8);
    box-shadow: 
        0 0 0 4px rgba(136, 192, 208, 0.15),
        0 4px 12px rgba(46, 52, 64, 0.15);
    transform: translateY(-1px);
}

.ae-stats {
    display: flex;
    gap: 32px;
    align-items: center;
    flex-wrap: wrap;
}

.stat-item {
    text-align: center;
    padding: 16px;
    background: linear-gradient(135deg, var(--nord5) 0%, var(--nord6) 100%);
    border-radius: 12px;
    border: 1px solid var(--nord4);
    min-width: 120px;
}

.stat-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--nord0);
    margin-bottom: 4px;
}

.stat-label {
    font-size: 12px;
    color: var(--nord2);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-weight: 600;
}

.completion-indicator {
    display: flex;
    align-items: center;
    gap: 12px;
}

.status-dots {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--nord5);
    border: 2px solid var(--nord4);
    transition: all 0.3s ease;
}

.status-dot.completed {
    background: var(--nord14);
    border-color: var(--nord14);
    box-shadow: 0 0 8px rgba(163, 190, 140, 0.5);
}

.status-dot.current {
    background: var(--nord8);
    border-color: var(--nord8);
    animation: nordPulse 2s infinite;
    box-shadow: 0 0 12px rgba(136, 192, 208, 0.6);
}

@keyframes nordPulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.2); }
}

/* Progress Review Panel */
.progress-review-panel {
    background: linear-gradient(135deg, var(--nord6) 0%, var(--nord5) 100%);
    border: 2px solid var(--nord8);
    border-radius: 16px;
    padding: 24px;
    margin-top: 24px;
    box-shadow: 0 8px 24px rgba(136, 192, 208, 0.15);
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.progress-header h3 {
    margin: 0;
    color: var(--nord0);
    font-size: 18px;
    font-weight: 700;
}

.review-date {
    color: var(--nord2);
    font-size: 14px;
    font-weight: 600;
}

.progress-message {
    color: var(--nord1);
    line-height: 1.6;
    margin-bottom: 20px;
    font-size: 15px;
}

.progress-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.progress-stat {
    background: var(--nord6);
    border: 1px solid var(--nord4);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    flex: 1;
    min-width: 140px;
}

.progress-stat.positive {
    border-color: var(--nord14);
    background: linear-gradient(135deg, var(--nord6) 0%, rgba(163, 190, 140, 0.05) 100%);
}

.progress-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--nord0);
    margin-bottom: 4px;
}

.progress-label {
    font-size: 12px;
    color: var(--nord2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

/* Nordic Action Buttons */
.progress-actions {
    text-align: center;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--nord8) 0%, var(--nord9) 100%);
    color: var(--nord6);
    box-shadow: 0 4px 12px rgba(136, 192, 208, 0.3);
}

.btn-primary:hover {
    background: linear-gradient(135deg, var(--nord9) 0%, var(--nord10) 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(136, 192, 208, 0.4);
}

.btn-sm {
    padding: 10px 20px;
    font-size: 13px;
}

/* Monthly Summary Cards with Nordic Ice Styling */
.monthly-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
    margin-bottom: 40px;
}

.quarterly-row {
    display: contents;
}

.month-card, .quarter-card {
    background: var(--nord6);
    border: 2px solid var(--nord5);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(46, 52, 64, 0.08);
}

.month-card:hover, .quarter-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(46, 52, 64, 0.15);
    border-color: var(--nord8);
}

.quarter-card {
    background: linear-gradient(135deg, var(--nord5) 0%, var(--nord6) 100%);
    border: 2px solid var(--nord8);
    box-shadow: 0 8px 24px rgba(136, 192, 208, 0.2);
}

.month-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--nord5);
}

.month-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--nord0);
}

.month-status {
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-ahead {
    background: var(--nord14);
    color: var(--nord6);
}

.status-on_track {
    background: var(--nord13);
    color: var(--nord0);
}

.status-behind {
    background: var(--nord11);
    color: var(--nord6);
}

.status-past {
    background: var(--nord3);
    color: var(--nord6);
}

.status-current {
    background: var(--nord8);
    color: var(--nord6);
}

.status-future {
    background: var(--nord9);
    color: var(--nord6);
}

.revenue-metrics {
    margin-bottom: 20px;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--nord5);
}

.metric-row:last-child {
    border-bottom: none;
}

.metric-label {
    font-size: 14px;
    color: var(--nord2);
    font-weight: 600;
}

.metric-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--nord0);
    cursor: default;
    transition: all 0.3s ease;
}

.metric-value.booked {
    color: var(--nord14);
}

.metric-value.pipeline {
    color: var(--nord8);
    cursor: pointer;
}

.metric-value.pipeline:hover:not(.disabled) {
    color: var(--nord9);
    transform: scale(1.05);
}

.metric-value.budget {
    color: var(--nord2);
}

.metric-value.disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.gap-analysis {
    background: linear-gradient(135deg, var(--nord5) 0%, rgba(236, 239, 244, 0.5) 100%);
    border-radius: 12px;
    padding: 16px;
}

.gap-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 14px;
    font-weight: 600;
}

.gap-amount.positive {
    color: var(--nord14);
}

.gap-amount.negative {
    color: var(--nord11);
}

/* Pipeline Input Styling */
.pipeline-input {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid var(--nord8);
    border-radius: 8px;
    font-size: 16px;
    font-weight: 700;
    color: var(--nord0);
    background: var(--nord6);
    text-align: right;
}

.pipeline-input:focus {
    outline: none;
    border-color: var(--nord9);
    box-shadow: 0 0 0 3px rgba(136, 192, 208, 0.2);
}

.metric-value.editing {
    background: var(--nord6);
    border-radius: 8px;
    padding: 4px;
}

/* Status Legend with Nordic Styling */
.status-legend {
    background: var(--nord6);
    border: 2px solid var(--nord5);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 32px;
    display: flex;
    gap: 32px;
    flex-wrap: wrap;
    justify-content: center;
    box-shadow: 0 4px 16px rgba(46, 52, 64, 0.08);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: var(--nord1);
}

.legend-badge {
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
}

.legend-past {
    background: var(--nord3);
    color: var(--nord6);
}

.legend-current {
    background: var(--nord8);
    color: var(--nord6);
}

.legend-future {
    background: var(--nord9);
    color: var(--nord6);
}

/* Month Summary Display Area */
.month-summary-display {
    background: var(--nord6);
    border: 2px solid var(--nord5);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 32px;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--nord2);
    font-size: 18px;
    text-align: center;
    box-shadow: inset 0 2px 8px rgba(46, 52, 64, 0.05);
}

/* Customer Modal Nordic Styling */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(46, 52, 64, 0.8);
    backdrop-filter: blur(4px);
}

.modal-content {
    background: var(--nord6);
    margin: 5% auto;
    padding: 0;
    border-radius: 20px;
    width: 90%;
    max-width: 900px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(46, 52, 64, 0.3);
    border: 2px solid var(--nord5);
}

.modal-header {
    background: linear-gradient(135deg, var(--nord0) 0%, var(--nord1) 100%);
    color: var(--nord6);
    padding: 24px 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    margin: 0;
    font-size: 20px;
    font-weight: 700;
}

.close {
    color: var(--nord4);
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s ease;
}

.close:hover {
    color: var(--nord6);
}

.modal-body {
    padding: 32px;
    max-height: 60vh;
    overflow-y: auto;
}

.search-box {
    width: 100%;
    padding: 16px 20px;
    border: 2px solid var(--nord5);
    border-radius: 12px;
    font-size: 16px;
    margin-bottom: 24px;
    background: var(--nord6);
    color: var(--nord0);
}

.search-box:focus {
    outline: none;
    border-color: var(--nord8);
    box-shadow: 0 0 0 3px rgba(136, 192, 208, 0.15);
}

.tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    background: var(--nord5);
    border-radius: 12px;
    padding: 4px;
}

.tab {
    flex: 1;
    padding: 12px 16px;
    border: none;
    background: transparent;
    color: var(--nord2);
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tab.active {
    background: var(--nord8);
    color: var(--nord6);
    box-shadow: 0 2px 8px rgba(136, 192, 208, 0.3);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.deals-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--nord6);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(46, 52, 64, 0.1);
}

.deals-table th {
    background: var(--nord5);
    color: var(--nord0);
    padding: 16px;
    text-align: left;
    font-weight: 700;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.deals-table td {
    padding: 16px;
    border-bottom: 1px solid var(--nord5);
    color: var(--nord1);
}

.deals-table tr:last-child td {
    border-bottom: none;
}

.deals-table tr:hover {
    background: var(--nord5);
}

/* Alert Container */
#alert-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1001;
}

.alert {
    padding: 16px 24px;
    border-radius: 12px;
    margin-bottom: 12px;
    font-weight: 600;
    box-shadow: 0 4px 16px rgba(46, 52, 64, 0.2);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.alert-success {
    background: var(--nord14);
    color: var(--nord6);
    border: 2px solid rgba(163, 190, 140, 0.3);
}

.alert-error {
    background: var(--nord11);
    color: var(--nord6);
    border: 2px solid rgba(191, 97, 106, 0.3);
}

/* Loading States */
.loading {
    opacity: 0.6;
    pointer-events: none;
    position: relative;
}

.loading::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 24px;
    height: 24px;
    margin: -12px 0 0 -12px;
    border: 3px solid var(--nord5);
    border-top: 3px solid var(--nord8);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .pipeline-container {
        padding: 16px;
    }
    
    .pipeline-header {
        padding: 24px;
    }
    
    .header-content {
        flex-direction: column;
        text-align: center;
        gap: 16px;
    }
    
    .ae-selector-bar {
        padding: 24px;
    }
    
    .selector-content {
        flex-direction: column;
        gap: 20px;
    }
    
    .ae-stats {
        flex-direction: column;
        gap: 16px;
        width: 100%;
    }
    
    .monthly-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .progress-stats {
        flex-direction: column;
        gap: 12px;
    }
    
    .status-legend {
        flex-direction: column;
        gap: 16px;
    }
    
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .modal-body {
        padding: 20px;
    }
}

/* Print Styles */
@media print {
    .pipeline-header {
        background: var(--nord5) !important;
        color: var(--nord0) !important;
        box-shadow: none !important;
    }
    
    .month-card, .quarter-card {
        break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid var(--nord3) !important;
    }
    
    .btn, .modal, #alert-container {
        display: none !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="pipeline-container">
    <!-- Header Section -->
    <div class="pipeline-header">
        <div class="header-content">
            <div class="header-info">
                <h1>❄️ Pipeline Revenue Management</h1>
                <p class="subtitle">Nordic ice-themed pipeline forecasting and gap analysis</p>
            </div>
            <div class="session-info">
                <div class="session-date">Review Session: {{ data.session_date }}</div>
                <div class="session-progress" id="session-progress">
                    <span id="completed-count">{{ data.session.completed_aes|length }}</span> 
                    of {{ data.ae_list|length }} AEs Reviewed
                </div>
            </div>
        </div>
    </div>

    <!-- AE Selection Bar -->
    <div class="ae-selector-bar">
        <div class="selector-content">
            <div class="ae-selection">
                <label for="ae-selector">Account Executive:</label>
                <select id="ae-selector" class="ae-dropdown">
                    <option value="">Select an AE to review...</option>
                    {% for ae in data.ae_list %}
                    <option value="{{ ae.ae_id }}" data-name="{{ ae.name }}">{{ ae.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Progress Since Last Review -->
            <div id="progress-since-review" class="progress-review-panel" style="display: none;">
                <div class="progress-header">
                    <h3>Progress Since Last Review</h3>
                    <div class="review-date" id="last-review-date"></div>
                </div>
                <div class="progress-content">
                    <div class="progress-message" id="progress-message"></div>
                    <div class="progress-stats">
                        <div class="progress-stat positive">
                            <div class="progress-value" id="revenue-progress">$0</div>
                            <div class="progress-label">New Revenue Booked</div>
                        </div>
                        <div class="progress-stat positive">
                            <div class="progress-value" id="pipeline-reduction">$0</div>
                            <div class="progress-label">Pipeline Decay</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-value" id="gap-reduction">$0</div>
                            <div class="progress-label">Gap Reduction</div>
                        </div>
                    </div>
                </div>
                <div class="progress-actions">
                    <button type="button" class="btn btn-primary btn-sm" onclick="createNewReviewSnapshot()">
                        Start New Review Session
                    </button>
                </div>
            </div>

            <div class="ae-stats" id="ae-stats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-value" id="total-revenue">-</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="ytd-attainment">-</div>
                    <div class="stat-label">YTD Attainment</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avg-deal-size">-</div>
                    <div class="stat-label">Avg Deal Size</div>
                </div>
            </div>
            
            <div class="completion-indicator">
                <div class="status-dots" id="status-dots">
                    {% for ae in data.ae_list %}
                    <div class="status-dot" data-ae-id="{{ ae.ae_id }}" 
                         title="{{ ae.name }}"></div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Month Status Legend -->
    <div class="status-legend">
        <div class="legend-item">
            <span class="legend-badge legend-past">PAST</span>
            <span>Historical months (Jan-May) - Closed for changes</span>
        </div>
        <div class="legend-item">
            <span class="legend-badge legend-current">CURRENT</span>
            <span>Current month (June) - Active for updates</span>
        </div>
        <div class="legend-item">
            <span class="legend-badge legend-future">FUTURE</span>
            <span>Future months (July-Dec) - Open for pipeline planning</span>
        </div>
    </div>

    <!-- Monthly Revenue Cards -->
    <div id="monthly-grid" class="monthly-grid" style="display: none;">
        <!-- Cards will be populated dynamically -->
    </div>

    <!-- Month Summary Display -->
    <div class="month-summary-display" id="month-summary-display">
        <div>
            ❄️ Select an Account Executive to view their Nordic pipeline analysis and revenue forecasting
        </div>
    </div>
</div>

<!-- Customer Details Modal -->
<div id="customer-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Customer Details</h3>
            <span class="close" onclick="closeCustomerModal()">&times;</span>
        </div>
        <div class="modal-body">
            <input type="text" id="customer-search" class="search-box" 
                   placeholder="Search customers and deals...">
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('booked')">Booked Revenue</button>
                <button class="tab" onclick="switchTab('pipeline')">Pipeline</button>
                <button class="tab" onclick="switchTab('all')">All Deals</button>
            </div>
            
            <div id="booked-content" class="tab-content active">
                <table class="deals-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Spots</th>
                            <th>Revenue</th>
                            <th>First Spot</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="booked-deals">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div id="pipeline-content" class="tab-content">
                <table class="deals-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Deal Description</th>
                            <th>Amount</th>
                            <th>Probability</th>
                            <th>Expected Close</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="pipeline-deals">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div id="all-content" class="tab-content">
                <table class="deals-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Spots</th>
                            <th>Revenue</th>
                            <th>First Spot</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="all-deals">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1001;">
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('Pipeline Revenue Management (Nord) JavaScript loading...');

// Global state
let currentAE = null;
let currentMonthlyData = [];
let currentQuarterlyData = [];
let sessionData = {{ data.session | tojson }};
let originalPipelineValues = {}; // Track original values for change detection

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Pipeline Revenue Management (Nord) page loaded');
    updateCompletionStatus();
    setupEventListeners();
});

function setupEventListeners() {
    // AE selector change
    document.getElementById('ae-selector').addEventListener('change', function() {
        const aeId = this.value;
        if (aeId) {
            loadAEData(aeId);
        } else {
            hideAEData();
        }
    });

    // Customer search
    if (document.getElementById('customer-search')) {
        document.getElementById('customer-search').addEventListener('input', function() {
            filterCustomerData(this.value);
        });
    }
}

async function loadAEData(aeId) {
    try {
        showLoading(true);
        
        // Get AE summary data
        const response = await fetch(`/api/ae/${aeId}/summary`);
        const result = await response.json();
        
        if (result.success) {
            currentAE = result.data.ae_info;
            currentMonthlyData = result.data.monthly_summary;
            currentQuarterlyData = result.data.quarterly_summary || [];
            
            displayAEStats(currentAE);
            displayProgressSinceReview(result.data.progress_since_review);
            displayMonthlyCards(currentMonthlyData, currentQuarterlyData);
            showAEData();
            
            // Store original pipeline values for change tracking
            originalPipelineValues = {};
            currentMonthlyData.forEach(month => {
                originalPipelineValues[month.month] = month.current_pipeline;
            });
            
        } else {
            showAlert('error', result.error || 'Failed to load AE data');
        }
    } catch (error) {
        console.error('Error loading AE data:', error);
        showAlert('error', 'Failed to load AE data');
    } finally {
        showLoading(false);
    }
}

function displayAEStats(ae) {
    // Calculate attainment percentage from new data
    const attainment = ae.attainment_percentage ? Math.round(ae.attainment_percentage) : 0;
    const avgDeal = ae.avg_deal_size ? formatCurrency(ae.avg_deal_size) : '$0';
    const totalRevenue = ae.total_revenue ? formatCurrency(ae.total_revenue) : '$0';
    
    document.getElementById('ytd-attainment').textContent = `${attainment}%`;
    document.getElementById('avg-deal-size').textContent = avgDeal;
    document.getElementById('total-revenue').textContent = totalRevenue;
}

function displayMonthlyCards(monthlyData, quarterlyData) {
    const grid = document.getElementById('monthly-grid');
    const summaryDisplay = document.getElementById('month-summary-display');
    
    if (!monthlyData || monthlyData.length === 0) {
        grid.style.display = 'none';
        summaryDisplay.style.display = 'flex';
        summaryDisplay.innerHTML = '<div>❄️ No monthly data available for this Account Executive</div>';
        return;
    }
    
    grid.style.display = 'grid';
    summaryDisplay.style.display = 'none';
    grid.innerHTML = '';
    
    // Create month cards
    monthlyData.forEach(month => {
        const card = createMonthCard(month);
        grid.appendChild(card);
    });
}

function createMonthCard(month) {
    const card = document.createElement('div');
    card.className = 'month-card';
    
    // Determine if past, current, or future month
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth() + 1;
    const currentYear = currentDate.getFullYear();
    const [monthYear, monthNum] = month.month.split('-');
    const monthNumber = parseInt(monthNum);
    
    if (parseInt(monthYear) < currentYear || (parseInt(monthYear) === currentYear && monthNumber < currentMonth)) {
        card.classList.add('past-month');
    } else if (parseInt(monthYear) === currentYear && monthNumber === currentMonth) {
        card.classList.add('current-month');  
    } else {
        card.classList.add('future-month');
    }
    
    card.innerHTML = `
        <div class="month-header">
            <div class="month-title">${month.month_display}</div>
            <div class="month-status status-${month.pipeline_status}">
                ${month.pipeline_status.replace('_', ' ')}
            </div>
        </div>
        
        <div class="revenue-metrics">
            <div class="metric-row">
                <span class="metric-label">Booked Revenue:</span>
                <span class="metric-value booked">${formatCurrency(month.booked_revenue)}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Current Pipeline:</span>
                <span class="metric-value pipeline ${monthNumber < currentMonth ? 'disabled' : ''}" 
                      ${monthNumber >= currentMonth ? `onclick="editPipeline('${month.month}', this)"` : ''} 
                      data-original="${month.current_pipeline}">
                    ${formatCurrency(month.current_pipeline)}
                </span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Budget (ref):</span>
                <span class="metric-value budget">${formatCurrency(month.budget)}</span>
            </div>
        </div>
        
        <div class="gap-analysis">
            <div class="gap-row gap-secondary">
                <span>Budget Gap:</span>
                <span class="gap-amount ${month.budget_gap >= 0 ? 'positive' : 'negative'}">
                    ${month.budget_gap >= 0 ? '+' : '-'}${formatCurrency(Math.abs(month.budget_gap))}
                </span>
            </div>
        </div>
    `;
    
    return card;
}

async function editPipeline(month, element) {
    const currentValue = parseFloat(element.dataset.original) || 0;
    const input = document.createElement('input');
    input.type = 'number';
    input.className = 'pipeline-input';
    input.value = currentValue;
    input.step = '1000';
    
    element.classList.add('editing');
    element.innerHTML = '';
    element.appendChild(input);
    
    input.focus();
    input.select();
    
    const saveValue = async () => {
        const newValue = parseFloat(input.value) || 0;
        
        if (newValue !== currentValue) {
            try {
                const response = await fetch(`/api/pipeline/${currentAE.ae_id}/${month}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        current_pipeline: newValue,
                        notes: `Updated from ${formatCurrency(currentValue)} to ${formatCurrency(newValue)}`,
                        updated_by: 'user'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the display
                    element.dataset.original = newValue;
                    element.innerHTML = formatCurrency(newValue);
                    element.classList.remove('editing');
                    
                    // Refresh the data to update gaps
                    loadAEData(currentAE.ae_id);
                    
                    showAlert('success', 'Pipeline updated successfully');
                } else {
                    element.innerHTML = formatCurrency(currentValue);
                    element.classList.remove('editing');
                    showAlert('error', result.error || 'Failed to update pipeline');
                }
            } catch (error) {
                element.innerHTML = formatCurrency(currentValue);
                element.classList.remove('editing');
                showAlert('error', 'Network error updating pipeline');
            }
        } else {
            element.innerHTML = formatCurrency(currentValue);
            element.classList.remove('editing');
        }
    };
    
    input.addEventListener('blur', saveValue);
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            saveValue();
        } else if (e.key === 'Escape') {
            element.innerHTML = formatCurrency(currentValue);
            element.classList.remove('editing');
        }
    });
}

function displayProgressSinceReview(progressData) {
    const progressPanel = document.getElementById('progress-since-review');
    
    if (!progressData) {
        // Show panel with "Start First Review Session" option
        progressPanel.style.display = 'block';
        document.getElementById('last-review-date').textContent = 'No previous review session';
        document.getElementById('progress-message').textContent = 
            'Start your first review session to begin tracking pipeline decay and progress between reviews.';
        
        // Hide progress stats when no data
        const statsDiv = document.querySelector('.progress-stats');
        if (statsDiv) statsDiv.style.display = 'none';
        
        // Update button text for first session
        const button = document.querySelector('#progress-since-review button');
        if (button) button.textContent = 'Start First Review Session';
        return;
    }
    
    // Show the panel with progress data
    progressPanel.style.display = 'block';
    const statsDiv = document.querySelector('.progress-stats');
    if (statsDiv) statsDiv.style.display = 'flex';
    
    // Update the review date
    const reviewDate = new Date(progressData.last_review_date);
    document.getElementById('last-review-date').textContent = 
        `Last review: ${reviewDate.toLocaleDateString()}`;
    
    // Create the progress message
    const message = `Since our last review ${getDaysAgo(reviewDate)} days ago, we've booked ${formatCurrency(progressData.revenue_progress)} additional revenue, automatically reducing our pipeline requirements by ${formatCurrency(progressData.pipeline_reduction)}. The remaining gap has shrunk from ${formatCurrency(Math.abs(progressData.last_gap))} to ${formatCurrency(Math.abs(progressData.current_gap))}.`;
    
    document.getElementById('progress-message').textContent = message;
    
    // Update progress stats
    document.getElementById('revenue-progress').textContent = formatCurrency(progressData.revenue_progress);
    document.getElementById('pipeline-reduction').textContent = formatCurrency(progressData.pipeline_reduction);
    document.getElementById('gap-reduction').textContent = formatCurrency(progressData.last_gap - progressData.current_gap);
}

function getDaysAgo(date) {
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    return Math.floor(diff / (1000 * 60 * 60 * 24));
}

function showAEData() {
    document.getElementById('ae-stats').style.display = 'flex';
    document.getElementById('monthly-grid').style.display = 'grid';
    document.getElementById('month-summary-display').style.display = 'none';
}

function hideAEData() {
    document.getElementById('ae-stats').style.display = 'none';
    document.getElementById('monthly-grid').style.display = 'none';
    document.getElementById('month-summary-display').style.display = 'flex';
    document.getElementById('progress-since-review').style.display = 'none';
}

function updateCompletionStatus() {
    // Update completion dots based on session data
    const dots = document.querySelectorAll('.status-dot');
    const completedAEs = sessionData.completed_aes || [];
    
    dots.forEach(dot => {
        const aeId = dot.dataset.aeId;
        if (completedAEs.includes(aeId)) {
            dot.classList.add('completed');
        }
    });
    
    // Update counts
    document.getElementById('completed-count').textContent = completedAEs.length;
}

function formatCurrency(amount) {
    if (amount === null || amount === undefined) return '$0';
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function showAlert(type, message) {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    
    container.appendChild(alert);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

function showLoading(show) {
    const container = document.querySelector('.pipeline-container');
    if (show) {
        container.classList.add('loading');
    } else {
        container.classList.remove('loading');
    }
}

function closeCustomerModal() {
    document.getElementById('customer-modal').style.display = 'none';
}

function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(`${tabName}-content`).classList.add('active');
    
    // Add active class to clicked tab
    event.target.classList.add('active');
}

function filterCustomerData(searchTerm) {
    // Filter functionality for customer modal
    console.log('Filtering customers by:', searchTerm);
}

async function createNewReviewSnapshot() {
    if (!currentAE) return;
    
    try {
        const response = await fetch(`/api/review/snapshot/${currentAE.ae_id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', 'Review snapshot created successfully');
            // Refresh progress data
            loadAEData(currentAE.ae_id);
        } else {
            showAlert('error', result.error || 'Failed to create review snapshot');
        }
    } catch (error) {
        showAlert('error', 'Network error creating review snapshot');
    }
}

// Initialize
console.log('Pipeline Revenue Management (Nord) initialized');
</script>
{% endblock %}
