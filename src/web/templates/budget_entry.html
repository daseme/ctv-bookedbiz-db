{% extends "base.html" %}

{% block title %}Budget Entry - CTV Booked Biz{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">›</span>
<span>Budgeting</span>
<span class="breadcrumb-separator">›</span>
<span class="breadcrumb-current">Budget Entry</span>
{% endblock %}

{% block header_title %}Budget Entry{% endblock %}
{% block header_subtitle %}Set annual budget targets by AE{% endblock %}

{% block extra_styles %}
<style>
    .budget-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        background: var(--nord6);
        border-radius: 8px;
        margin-bottom: 24px;
    }
    
    .control-group {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .control-group label {
        font-size: 12px;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .control-group select {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        min-width: 120px;
    }
    
    .budget-table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow-x: auto;
        overflow-y: visible;
        margin-bottom: 24px;
    }
    
    .budget-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    
    .budget-table th {
        background: var(--nord0);
        color: var(--nord6);
        padding: 8px 10px;
        text-align: left;
        font-weight: 500;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .budget-table th.number {
        text-align: right;
        width: 70px;
        min-width: 70px;
        padding-left: 8px;
        padding-right: 8px;
    }
    
    .budget-table td {
        padding: 6px 8px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .budget-table td.number {
        text-align: right;
        width: 70px;
        min-width: 70px;
        padding-left: 8px;
        padding-right: 8px;
    }
    
    .budget-table tr:hover {
        background: #f7fafc;
    }
    
    .ae-name {
        font-weight: 500;
        color: var(--nord0);
    }
    
    .ae-type {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        margin-left: 8px;
    }
    
    .ae-type.ae { background: var(--nord8); color: white; }
    .ae-type.house { background: var(--nord14); color: white; }
    .ae-type.agency { background: var(--nord15); color: white; }
    
    /* All table inputs: same border and appearance so none look "bolder" */
    .budget-table input[type="text"],
    .budget-table input[type="number"] {
        -webkit-appearance: none;
        appearance: none;
        border: 1px solid #e2e8f0;
        border-radius: 3px;
        font-weight: 400;
        box-sizing: border-box;
        text-align: right;
    }
    
    .budget-table input[type="number"]::-webkit-outer-spin-button,
    .budget-table input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    .budget-table input[type="number"] {
        -moz-appearance: textfield;
    }
    
    .budget-input {
        width: 100%;
        padding: 4px 6px;
        font-size: 12px;
        text-align: right;
        font-variant-numeric: tabular-nums;
    }
    
    .budget-input:focus {
        outline: none;
        border-color: var(--nord8);
        box-shadow: 0 0 0 3px rgba(136, 192, 208, 0.2);
    }
    
    .budget-input.modified {
        background: #fef3c7;
        border-color: var(--nord13);
    }
    
    .total-cell,
    .budget-table td.sector-total {
        font-weight: 400;
        color: var(--nord0);
        text-align: right;
    }
    
    .totals-row {
        background: var(--nord5) !important;
        font-weight: 400;
    }
    
    .totals-row td {
        border-bottom: none;
        padding: 8px 10px;
    }
    
    .totals-row td.number {
        text-align: right;
    }

    /* Expandable Row Styles */
    .expand-toggle {
        cursor: pointer;
        user-select: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .expand-toggle .arrow {
        display: inline-block;
        width: 16px;
        height: 16px;
        text-align: center;
        line-height: 16px;
        font-size: 12px;
        color: var(--nord3);
        transition: transform 0.15s;
    }
    
    .expand-toggle.expanded .arrow {
        transform: rotate(90deg);
    }
    
    .expand-toggle:hover .arrow {
        color: var(--nord8);
    }
    
    /* Sector Rows */
    .sector-row {
        background: #fafbfc;
    }
    
    .sector-row td {
        padding: 6px 8px;
        border-bottom: 1px solid #e8ecf0;
    }
    
    .sector-row td:first-child {
        border-left: 3px solid var(--nord10);
    }
    
    .sector-row:hover {
        background: #f1f3f5;
    }
    
    .sector-name-cell {
        padding: 4px 8px;
        padding-left: 32px !important;
        font-size: 12px;
        font-weight: 400;
        color: #4a5568;
    }
    
    .sector-name-cell .sector-code {
        font-weight: 400;
        color: var(--nord10);
        margin-right: 6px;
    }
    
    .sector-row-descriptor {
        font-size: 11px;
        color: var(--nord3);
        font-weight: 400;
        margin-left: 8px;
    }
    
    .sector-input {
        width: 100%;
        padding: 3px 5px;
        font-size: 11px;
        text-align: right;
        font-variant-numeric: tabular-nums;
        background: white;
    }
    
    .sector-input:focus {
        outline: none;
        border-color: var(--nord8);
        box-shadow: 0 0 0 2px rgba(136, 192, 208, 0.2);
    }
    
    .sector-input.modified {
        background: #fef3c7;
        border-color: var(--nord13);
    }
    
    /* Sector Total Row */
    .sector-total-row {
        background: #eef1f4;
    }
    
    .sector-total-row td {
        padding: 6px 8px;
        font-weight: 400;
        font-size: 12px;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .sector-total-row td.number {
        text-align: right;
    }
    
    .sector-total-row .total-label {
        padding-left: 32px;
        color: #4a5568;
        text-align: left;
    }
    
    /* Balance Indicators */
    .balance-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-left: 4px;
        vertical-align: middle;
    }
    
    .balance-indicator.balanced {
        background: var(--nord14);
    }
    
    .balance-indicator.unbalanced {
        background: var(--nord11);
    }
    
    /* Add Sector Row */
    .add-sector-row {
        background: #f0fff4;
    }
    
    .add-sector-row td {
        padding: 6px 8px;
    }
    
    .add-sector-cell {
        padding: 6px 8px;
        padding-left: 32px !important;
    }
    
    .add-sector-select {
        padding: 4px 8px;
        border: 1px dashed var(--nord14);
        border-radius: 4px;
        font-size: 12px;
        background: white;
        cursor: pointer;
    }
    
    .remove-sector-btn {
        opacity: 0;
        padding: 2px 6px;
        border: none;
        background: var(--nord11);
        color: white;
        border-radius: 3px;
        font-size: 10px;
        cursor: pointer;
        transition: opacity 0.15s;
    }
    
    .sector-row:hover .remove-sector-btn {
        opacity: 1;
    }
    
    .sector-subrow {
        background: #f8f9fa;
    }
    
    .sector-subrow td {
        padding: 4px 8px;
        border-top: none;
        font-size: 11px;
    }
    
    .sector-subrow td:first-child {
        border-left: 3px solid var(--nord10);
    }
    
    /* Last row of each sector block: clearer separator between sectors */
    .sector-subrow.sector-subrow-dollars {
        border-bottom: 1px solid #cbd5e0;
    }
    
    .sector-subrow td.number input {
        width: 100%;
        padding: 3px 5px;
        font-size: 11px;
    }
    
    .sector-subrow-label {
        color: var(--nord10);
        padding-left: 32px !important;
        font-weight: 400;
        font-style: italic;
    }
    
    /* Quick Fill Section */
    .quick-fill {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
    }
    
    .quick-fill h3 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: var(--nord0);
    }
    
    .quick-fill-row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .quick-fill-row label {
        font-size: 12px;
        color: #718096;
    }
    
    .quick-fill-row input {
        padding: 6px 10px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        width: 120px;
    }
    
    .quick-fill-row select {
        padding: 6px 10px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
    }
    
    /* Action Bar */
    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        background: var(--nord6);
        border-radius: 8px;
    }
    
    .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.15s;
        border: none;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--nord8) 0%, var(--nord7) 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(136, 192, 208, 0.4);
    }
    
    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-secondary {
        background: white;
        color: var(--nord0);
        border: 1px solid #e2e8f0;
    }
    
    .btn-secondary:hover {
        background: var(--nord5);
    }
    
    .status-message {
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 13px;
        display: none;
    }
    
    .status-message.visible {
        display: block;
    }
    
    .status-message.success {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-message.error {
        background: #fee2e2;
        color: #991b1b;
    }
    
    /* Add AE Section */
    .add-ae-section {
        background: #f0f9ff;
        border: 1px dashed var(--nord8);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
    }
    
    .add-ae-section h3 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: var(--nord0);
    }
    
    .add-ae-row {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .add-ae-row input {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        flex: 1;
    }
    
    .add-ae-row select {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
    }
    
    /* Navigation tabs */
    .page-tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 24px;
    }
    
    .page-tab {
        padding: 10px 20px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 6px 6px 0 0;
        font-size: 14px;
        color: #718096;
        cursor: pointer;
        text-decoration: none;
    }
    
    .page-tab:hover {
        background: var(--nord6);
    }
    
    .page-tab.active {
        background: var(--nord8);
        color: white;
        border-color: var(--nord8);
    }
    
    /* Hidden rows */
    .hidden-row {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Tabs -->
<div class="page-tabs">
    <a href="/planning" class="page-tab">Planning Session</a>
    <a href="/planning/budget" class="page-tab active">Budget Entry</a>
</div>

<!-- Controls -->
<div class="budget-controls">
    <div class="control-group">
        <div>
            <label>Year</label>
            <select id="yearSelect" onchange="loadBudgetData()">
                <option value="2025">2025</option>
                <option value="2026" {% if selected_year == 2026 %}selected{% endif %}>2026</option>
                <option value="2027">2027</option>
            </select>
        </div>
    </div>
    <div class="control-group">
        <a href="/planning" class="btn btn-secondary">← Back to Planning</a>
    </div>
</div>

<!-- Quick Fill -->
<div class="quick-fill">
    <h3>Quick Fill</h3>
    <div class="quick-fill-row">
        <label>Apply to:</label>
        <select id="quickFillAe">
            <option value="__all__">All AEs</option>
            {% for entity in entities %}
            <option value="{{ entity.entity_name }}">{{ entity.entity_name }}</option>
            {% endfor %}
        </select>
        <label>Amount:</label>
        <input type="text" id="quickFillAmount" placeholder="e.g. 100000">
        <label>Pattern:</label>
        <select id="quickFillPattern">
            <option value="flat">Same each month</option>
            <option value="quarterly">Quarterly variance</option>
        </select>
        <button class="btn btn-secondary" onclick="applyQuickFill()">Apply</button>
    </div>
</div>

<!-- Add New AE -->
<div class="add-ae-section">
    <h3>Add New Revenue Entity</h3>
    <div class="add-ae-row">
        <input type="text" id="newAeName" placeholder="Enter AE name...">
        <select id="newAeType">
            <option value="AE">AE</option>
            <option value="House">House</option>
            <option value="Agency">Agency</option>
        </select>
        <button class="btn btn-secondary" onclick="addNewAe()">+ Add</button>
    </div>
</div>

<!-- Budget Table -->
<div class="budget-table-container">
    <table class="budget-table" id="budgetTable">
        <thead>
            <tr>
                <th style="width: 160px;">AE</th>
                <th class="number">Jan</th>
                <th class="number">Feb</th>
                <th class="number">Mar</th>
                <th class="number">Apr</th>
                <th class="number">May</th>
                <th class="number">Jun</th>
                <th class="number">Jul</th>
                <th class="number">Aug</th>
                <th class="number">Sep</th>
                <th class="number">Oct</th>
                <th class="number">Nov</th>
                <th class="number">Dec</th>
                <th class="number">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for entity in entities %}
            {% set ae_safe = entity.entity_name | replace(' ', '-') | replace("'", '') %}
            {% set has_sectors = entity.entity_name != 'WorldLink' %}
            {% set entity_exp = sector_expectations.get(entity.entity_name) %}
            
            <!-- Main AE Row -->
            <tr data-ae="{{ entity.entity_name }}" class="ae-row">
                <td>
                    {% if has_sectors %}
                    <span class="expand-toggle" onclick="toggleSectors('{{ ae_safe }}')" data-ae="{{ ae_safe }}" title="Click to expand sectors and edit New Accts / New $">
                        <span class="arrow">▶</span>
                        <span class="ae-name">{{ entity.entity_name }}</span>
                    </span>
                    {% else %}
                    <span class="ae-name" style="margin-left: 22px;">{{ entity.entity_name }}</span>
                    {% endif %}
                    <span class="ae-type {{ entity.entity_type.value|lower }}">{{ entity.entity_type.value }}</span>
                </td>
                {% for month in range(1, 13) %}
                <td class="number">
                    <input type="text" 
                           class="budget-input"
                           data-ae="{{ entity.entity_name }}"
                           data-month="{{ month }}"
                           value="{{ '{:,.0f}'.format(budgets.get(entity.entity_name, {}).get(month, 0) | float) }}"
                           onchange="markBudgetModified(this)"
                           onkeydown="handleKeydown(event, this)">
                </td>
                {% endfor %}
                <td class="number total-cell" id="total-{{ ae_safe }}">$0</td>
            </tr>
            
            {% if has_sectors %}
            <!-- Sector Rows (hidden by default) -->
            {% if entity_exp %}
            {% set new_accts_grid = entity_exp.new_accounts_grid() %}
            {% set new_dollars_grid = entity_exp.new_dollars_grid() %}
            {% for sector_id, sector_code, sector_name in entity_exp.sectors_used() %}
            {% set grid = entity_exp.monthly_grid() %}
            <tr class="sector-row hidden-row" data-ae-parent="{{ ae_safe }}" data-sector="{{ sector_id }}">
                <td class="sector-name-cell">
                    <span class="sector-code">{{ sector_code }}</span>
                    {{ sector_name }}
                    <span class="sector-row-descriptor">· Sector forecast</span>
                    <button class="remove-sector-btn" onclick="removeSector('{{ entity.entity_name }}', {{ sector_id }})">✕</button>
                </td>
                {% for month in range(1, 13) %}
                <td class="number">
                    <input type="text"
                           class="sector-input"
                           data-ae="{{ entity.entity_name }}"
                           data-sector="{{ sector_id }}"
                           data-month="{{ month }}"
                           value="{{ '{:,.0f}'.format(grid.get(sector_id, {}).get(month, 0) | float) }}"
                           onchange="markSectorModified(this)"
                           onkeydown="handleKeydown(event, this)">
                </td>
                {% endfor %}
                <td class="number sector-total" data-ae="{{ ae_safe }}" data-sector="{{ sector_id }}">$0</td>
            </tr>
            <tr class="sector-subrow sector-subrow-accts hidden-row" data-ae-parent="{{ ae_safe }}" data-sector="{{ sector_id }}">
                <td class="sector-subrow-label">New accts</td>
                {% for month in range(1, 13) %}
                <td class="number">
                    <input type="number"
                           class="sector-new-accounts"
                           data-ae="{{ entity.entity_name }}"
                           data-sector="{{ sector_id }}"
                           data-month="{{ month }}"
                           min="0"
                           value="{{ new_accts_grid.get(sector_id, {}).get(month) if new_accts_grid.get(sector_id, {}).get(month) is not none else '' }}"
                           onchange="markSectorModified(this)"
                           placeholder="0">
                </td>
                {% endfor %}
                <td class="number"></td>
            </tr>
            <tr class="sector-subrow sector-subrow-dollars hidden-row" data-ae-parent="{{ ae_safe }}" data-sector="{{ sector_id }}">
                <td class="sector-subrow-label">New $</td>
                {% for month in range(1, 13) %}
                <td class="number">
                    <input type="text"
                           class="sector-new-dollars"
                           data-ae="{{ entity.entity_name }}"
                           data-sector="{{ sector_id }}"
                           data-month="{{ month }}"
                           value="{{ '{:,.0f}'.format(new_dollars_grid.get(sector_id, {}).get(month) | float) if new_dollars_grid.get(sector_id, {}).get(month) is not none else '' }}"
                           onchange="markSectorModified(this)"
                           onkeydown="handleKeydown(event, this)"
                           placeholder="0">
                </td>
                {% endfor %}
                <td class="number"></td>
            </tr>
            {% endfor %}
            {% endif %}
            
            <!-- Add Sector Row -->
            <tr class="add-sector-row hidden-row" data-ae-parent="{{ ae_safe }}">
                <td class="add-sector-cell" colspan="14">
                    <select class="add-sector-select" 
                            id="add-sector-{{ ae_safe }}"
                            onchange="addSectorToEntity('{{ entity.entity_name }}', '{{ ae_safe }}', this.value)">
                        <option value="">+ Add Sector...</option>
                        <!-- Populated via JS -->
                    </select>
                </td>
            </tr>
            
            <!-- Sector Total Row -->
            <tr class="sector-total-row hidden-row" data-ae-parent="{{ ae_safe }}">
                <td class="total-label">
                    Sector Total
                    <span class="balance-indicator" id="balance-{{ ae_safe }}-indicator"></span>
                </td>
                {% for month in range(1, 13) %}
                <td class="number" id="sector-total-{{ ae_safe }}-{{ month }}">$0</td>
                {% endfor %}
                <td class="number" id="sector-grand-total-{{ ae_safe }}">$0</td>
            </tr>
            {% endif %}
            
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="totals-row">
                <td><strong>COMPANY TOTAL</strong></td>
                {% for month in range(1, 13) %}
                <td class="number" id="month-total-{{ month }}">$0</td>
                {% endfor %}
                <td class="number" id="grand-total">$0</td>
            </tr>
        </tfoot>
    </table>
</div>

<!-- Action Bar -->
<div class="action-bar">
    <div>
        <span class="status-message" id="statusMessage"></span>
    </div>
    <div class="control-group">
        <span id="changeCount" style="color: #718096; font-size: 13px;"></span>
        <button class="btn btn-secondary" onclick="resetChanges()" id="resetBtn" disabled>Reset</button>
        <button class="btn btn-primary" onclick="saveAll()" id="saveBtn" disabled>Save All Budgets</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// State management
const budgetChanges = new Map();
const sectorChanges = new Map();
let currentYear = {{ selected_year }};
const allSectors = {{ all_sectors | tojson }};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    currentYear = parseInt(document.getElementById('yearSelect').value);
    recalculateAllTotals();
    
    // Load available sectors for each entity
    document.querySelectorAll('.add-sector-select').forEach(select => {
        const ae = select.id.replace('add-sector-', '');
        loadAvailableSectors(ae);
    });
});

// ============================================================================
// Expand/Collapse
// ============================================================================

function toggleSectors(aeSafe) {
    const toggle = document.querySelector(`.expand-toggle[data-ae="${aeSafe}"]`);
    const sectorRows = document.querySelectorAll(`tr[data-ae-parent="${aeSafe}"]`);
    
    const isExpanded = toggle.classList.contains('expanded');
    
    if (isExpanded) {
        toggle.classList.remove('expanded');
        sectorRows.forEach(row => row.classList.add('hidden-row'));
    } else {
        toggle.classList.add('expanded');
        sectorRows.forEach(row => row.classList.remove('hidden-row'));
        recalculateSectorTotals(aeSafe);
    }
}

// ============================================================================
// Number Formatting
// ============================================================================

function formatNumber(num) {
    return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
}

function parseNumber(str) {
    return parseFloat(str.replace(/[$,]/g, '')) || 0;
}

// ============================================================================
// Budget Changes
// ============================================================================

function markBudgetModified(input) {
    const ae = input.dataset.ae;
    const month = parseInt(input.dataset.month);
    const value = parseNumber(input.value);
    
    input.value = formatNumber(value);
    input.classList.add('modified');
    
    const key = `budget-${ae}-${month}`;
    budgetChanges.set(key, { ae_name: ae, month: month, amount: value });
    
    updateChangeCount();
    recalculateAllTotals();
}

// ============================================================================
// Sector Changes
// ============================================================================

function markSectorModified(input) {
    const ae = input.dataset.ae;
    const sectorId = parseInt(input.dataset.sector);
    const month = parseInt(input.dataset.month);
    const value = parseNumber(input.value);
    
    input.value = formatNumber(value);
    input.classList.add('modified');
    
    const key = `sector-${ae}-${sectorId}-${month}`;
    sectorChanges.set(key, { 
        ae_name: ae, 
        sector_id: sectorId, 
        month: month, 
        amount: value 
    });
    
    updateChangeCount();
    
    // Update sector totals for this AE
    const aeSafe = ae.replace(/ /g, '-').replace(/'/g, '');
    recalculateSectorTotals(aeSafe);
}

function handleKeydown(event, input) {
    if (event.key === 'Enter' || event.key === 'Tab') {
        if (input.classList.contains('budget-input')) {
            markBudgetModified(input);
        } else {
            markSectorModified(input);
        }
    }
}

// ============================================================================
// Totals Calculation
// ============================================================================

function recalculateAllTotals() {
    const rows = document.querySelectorAll('#budgetTable tbody tr.ae-row');
    const monthTotals = {};
    let grandTotal = 0;
    
    for (let m = 1; m <= 12; m++) {
        monthTotals[m] = 0;
    }
    
    rows.forEach(row => {
        const ae = row.dataset.ae;
        const aeSafe = ae.replace(/ /g, '-').replace(/'/g, '');
        let rowTotal = 0;
        
        for (let m = 1; m <= 12; m++) {
            const input = row.querySelector(`input[data-month="${m}"]`);
            if (input) {
                const value = parseNumber(input.value);
                rowTotal += value;
                monthTotals[m] += value;
            }
        }
        
        const totalCell = document.getElementById(`total-${aeSafe}`);
        if (totalCell) {
            totalCell.textContent = '$' + formatNumber(rowTotal);
        }
        
        grandTotal += rowTotal;
    });
    
    // Update month totals
    for (let m = 1; m <= 12; m++) {
        const cell = document.getElementById(`month-total-${m}`);
        if (cell) {
            cell.textContent = '$' + formatNumber(monthTotals[m]);
        }
    }
    
    // Update grand total
    const grandTotalCell = document.getElementById('grand-total');
    if (grandTotalCell) {
        grandTotalCell.textContent = '$' + formatNumber(grandTotal);
    }
}

function recalculateSectorTotals(aeSafe) {
    const sectorRows = document.querySelectorAll(`tr.sector-row[data-ae-parent="${aeSafe}"]`);
    const monthTotals = {};
    let grandTotal = 0;
    
    for (let m = 1; m <= 12; m++) {
        monthTotals[m] = 0;
    }
    
    // Sum sector inputs
    sectorRows.forEach(row => {
        let rowTotal = 0;
        const sectorId = row.dataset.sector;
        
        for (let m = 1; m <= 12; m++) {
            const input = row.querySelector(`input[data-month="${m}"]`);
            if (input) {
                const value = parseNumber(input.value);
                rowTotal += value;
                monthTotals[m] += value;
            }
        }
        
        // Update sector row total
        const sectorTotal = row.querySelector(`.sector-total[data-sector="${sectorId}"]`);
        if (sectorTotal) {
            sectorTotal.textContent = '$' + formatNumber(rowTotal);
        }
        
        grandTotal += rowTotal;
    });
    
    // Update sector total row
    for (let m = 1; m <= 12; m++) {
        const cell = document.getElementById(`sector-total-${aeSafe}-${m}`);
        if (cell) {
            cell.textContent = '$' + formatNumber(monthTotals[m]);
        }
    }
    
    const grandTotalCell = document.getElementById(`sector-grand-total-${aeSafe}`);
    if (grandTotalCell) {
        grandTotalCell.textContent = '$' + formatNumber(grandTotal);
    }
    
    // Check balance with budget
    checkSectorBalance(aeSafe, monthTotals);
}

function checkSectorBalance(aeSafe, sectorMonthTotals) {
    const aeRow = document.querySelector(`tr.ae-row[data-ae="${aeSafe.replace(/-/g, ' ')}"]`) 
                || document.querySelector(`tr.ae-row[data-ae*="${aeSafe.split('-')[0]}"]`);
    
    if (!aeRow) return;
    
    let allBalanced = true;
    
    for (let m = 1; m <= 12; m++) {
        const budgetInput = aeRow.querySelector(`input[data-month="${m}"]`);
        if (budgetInput) {
            const budgetValue = parseNumber(budgetInput.value);
            const sectorTotal = sectorMonthTotals[m] || 0;
            
            if (Math.abs(budgetValue - sectorTotal) > 0.01) {
                allBalanced = false;
            }
        }
    }
    
    const indicator = document.getElementById(`balance-${aeSafe}-indicator`);
    if (indicator) {
        indicator.className = `balance-indicator ${allBalanced ? 'balanced' : 'unbalanced'}`;
        indicator.title = allBalanced ? 'Sectors balanced with budget' : 'Sectors do not match budget';
    }
}

// ============================================================================
// Sector Management
// ============================================================================

async function loadAvailableSectors(aeSafe) {
    // Convert safe name back to actual name
    const aeRow = document.querySelector(`tr.ae-row`);
    if (!aeRow) return;
    
    // Find the actual AE name from a matching row
    const rows = document.querySelectorAll('tr.ae-row');
    let aeName = null;
    rows.forEach(row => {
        const rowAe = row.dataset.ae;
        if (rowAe.replace(/ /g, '-').replace(/'/g, '') === aeSafe) {
            aeName = rowAe;
        }
    });
    
    if (!aeName) return;
    
    try {
        const response = await fetch(`/planning/api/sectors/available/${encodeURIComponent(aeName)}/${currentYear}`);
        const result = await response.json();
        
        if (result.success) {
            const select = document.getElementById(`add-sector-${aeSafe}`);
            if (select) {
                // Clear existing options except first
                select.innerHTML = '<option value="">+ Add Sector...</option>';
                
                result.data.sectors.forEach(sector => {
                    const option = document.createElement('option');
                    option.value = sector.sector_id;
                    option.textContent = `${sector.sector_code} - ${sector.sector_name}`;
                    select.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error loading available sectors:', error);
    }
}

async function addSectorToEntity(aeName, aeSafe, sectorId) {
    if (!sectorId) return;
    
    try {
        const response = await fetch('/planning/api/sector-expectations/add-sector', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ae_name: aeName,
                sector_id: parseInt(sectorId),
                year: currentYear
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showStatus(`Added ${result.data.sector_name}`, 'success');
            // Reload page to show new sector row
            setTimeout(() => location.reload(), 500);
        } else {
            showStatus(result.error || 'Failed to add sector', 'error');
        }
    } catch (error) {
        showStatus('Network error', 'error');
    }
}

async function removeSector(aeName, sectorId) {
    if (!confirm('Remove this sector? All amounts will be deleted.')) return;
    
    try {
        const response = await fetch('/planning/api/sector-expectations/remove-sector', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ae_name: aeName,
                sector_id: sectorId,
                year: currentYear
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showStatus('Sector removed', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showStatus(result.error || 'Failed to remove sector', 'error');
        }
    } catch (error) {
        showStatus('Network error', 'error');
    }
}

// ============================================================================
// Change Tracking
// ============================================================================

function updateChangeCount() {
    const totalChanges = budgetChanges.size + sectorChanges.size;
    const countEl = document.getElementById('changeCount');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    
    if (totalChanges > 0) {
        countEl.textContent = `${totalChanges} unsaved change${totalChanges > 1 ? 's' : ''}`;
        saveBtn.disabled = false;
        resetBtn.disabled = false;
    } else {
        countEl.textContent = '';
        saveBtn.disabled = true;
        resetBtn.disabled = true;
    }
}

// ============================================================================
// Save Operations
// ============================================================================

async function saveAll() {
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
    
    let errors = [];
    
    // Save budget changes
    if (budgetChanges.size > 0) {
        const budgetUpdates = Array.from(budgetChanges.values()).map(c => ({
            ae_name: c.ae_name,
            year: currentYear,
            month: c.month,
            amount: c.amount
        }));
        
        try {
            const response = await fetch('/planning/api/budget/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ updates: budgetUpdates })
            });
            
            const result = await response.json();
            if (!result.success) {
                errors.push('Budget save failed');
            }
        } catch (e) {
            errors.push('Budget save error');
        }
    }
    
    // Save sector changes (grouped by AE)
    if (sectorChanges.size > 0) {
        // Group by AE
        const byAe = {};
        sectorChanges.forEach((change, key) => {
            if (!byAe[change.ae_name]) {
                byAe[change.ae_name] = [];
            }
            byAe[change.ae_name].push(change);
        });
        
        // Save each AE's sector expectations
        for (const [aeName, changes] of Object.entries(byAe)) {
            // Get all current sector data for this AE (including unchanged)
            const aeSafe = aeName.replace(/ /g, '-').replace(/'/g, '');
            const allExpectations = [];
            
            // Collect all sector inputs for this AE (amounts on sector row; new accts / new $ on sub-rows, same month columns)
            const sectorRows = document.querySelectorAll(`tr.sector-row[data-ae-parent="${aeSafe}"]`);
            sectorRows.forEach(row => {
                const sectorId = parseInt(row.dataset.sector);
                const acctsSubrow = document.querySelector(`tr.sector-subrow-accts[data-ae-parent="${aeSafe}"][data-sector="${sectorId}"]`);
                const dollarsSubrow = document.querySelector(`tr.sector-subrow-dollars[data-ae-parent="${aeSafe}"][data-sector="${sectorId}"]`);
                for (let m = 1; m <= 12; m++) {
                    const amountInput = row.querySelector(`input.sector-input[data-month="${m}"]`);
                    const newAcctsInput = acctsSubrow ? acctsSubrow.querySelector(`input.sector-new-accounts[data-month="${m}"]`) : null;
                    const newDollarsInput = dollarsSubrow ? dollarsSubrow.querySelector(`input.sector-new-dollars[data-month="${m}"]`) : null;
                    if (amountInput) {
                        const newAccountsForecast = newAcctsInput && newAcctsInput.value.trim() !== ''
                            ? parseInt(newAcctsInput.value, 10) : null;
                        const newDollarsForecast = newDollarsInput && newDollarsInput.value.trim() !== ''
                            ? parseNumber(newDollarsInput.value) : null;
                        allExpectations.push({
                            sector_id: sectorId,
                            month: m,
                            amount: parseNumber(amountInput.value),
                            new_accounts_forecast: newAccountsForecast,
                            new_dollars_forecast: newDollarsForecast
                        });
                    }
                }
            });
            
            try {
                const response = await fetch('/planning/api/sector-expectations/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ae_name: aeName,
                        year: currentYear,
                        expectations: allExpectations
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                    errors.push(`Sector save failed for ${aeName}`);
                }
            } catch (e) {
                errors.push(`Sector save error for ${aeName}`);
            }
        }
    }
    
    if (errors.length === 0) {
        // Clear modified states
        document.querySelectorAll('.modified').forEach(input => {
            input.classList.remove('modified');
        });
        budgetChanges.clear();
        sectorChanges.clear();
        updateChangeCount();
        showStatus('All changes saved', 'success');
    } else {
        showStatus(errors.join(', '), 'error');
    }
    
    saveBtn.disabled = budgetChanges.size === 0 && sectorChanges.size === 0;
    saveBtn.textContent = 'Save All Budgets';
}

// ============================================================================
// Quick Fill
// ============================================================================

function applyQuickFill() {
    const ae = document.getElementById('quickFillAe').value;
    const amount = parseNumber(document.getElementById('quickFillAmount').value);
    const pattern = document.getElementById('quickFillPattern').value;
    
    if (!amount) {
        showStatus('Please enter an amount', 'error');
        return;
    }
    
    const rows = ae === '__all__' 
        ? document.querySelectorAll('#budgetTable tbody tr.ae-row')
        : document.querySelectorAll(`#budgetTable tbody tr.ae-row[data-ae="${ae}"]`);
    
    rows.forEach(row => {
        for (let m = 1; m <= 12; m++) {
            const input = row.querySelector(`input[data-month="${m}"]`);
            if (input) {
                let monthAmount = amount;
                
                if (pattern === 'quarterly') {
                    if (m >= 1 && m <= 3) monthAmount = amount * 0.9;
                    else if (m >= 4 && m <= 6) monthAmount = amount * 1.0;
                    else if (m >= 7 && m <= 9) monthAmount = amount * 1.0;
                    else monthAmount = amount * 1.1;
                }
                
                input.value = formatNumber(Math.round(monthAmount));
                markBudgetModified(input);
            }
        }
    });
    
    showStatus(`Applied ${formatNumber(amount)}/month to ${ae === '__all__' ? 'all AEs' : ae}`, 'success');
}

// ============================================================================
// Add New AE
// ============================================================================

async function addNewAe() {
    const name = document.getElementById('newAeName').value.trim();
    const type = document.getElementById('newAeType').value;
    
    if (!name) {
        showStatus('Please enter an AE name', 'error');
        return;
    }
    
    try {
        const response = await fetch('/planning/api/entities/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, type: type })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showStatus(`Added ${name}`, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showStatus(result.error || 'Failed to add AE', 'error');
        }
    } catch (error) {
        showStatus('Network error', 'error');
    }
}

// ============================================================================
// Utilities
// ============================================================================

function resetChanges() {
    location.reload();
}

function loadBudgetData() {
    const year = document.getElementById('yearSelect').value;
    window.location.href = `/planning/budget?year=${year}`;
}

function showStatus(message, type) {
    const el = document.getElementById('statusMessage');
    el.textContent = message;
    el.className = `status-message visible ${type}`;
    setTimeout(() => el.classList.remove('visible'), 4000);
}
</script>
{% endblock %}