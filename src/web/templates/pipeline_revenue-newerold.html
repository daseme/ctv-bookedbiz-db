{% extends "base.html" %}

{% block title %}{{ title }} - CTV Reports{% endblock %}

{% block header_title %}{{ title }}{% endblock %}
{% block header_subtitle %}Nordic pipeline management with real-time decay tracking{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">›</span>
<span class="breadcrumb-link">Executive</span>
<span class="breadcrumb-separator">›</span>
<span class="breadcrumb-current">Pipeline Revenue Management</span>
{% endblock %}

{% block extra_styles %}
<!-- Include Nord CSS Module -->
{% include 'nord_base.html' %}

<style>
/* Enhanced Nord Theme with Decay Indicators */
:root {
    /* Existing Nord colors */
    --nord0: #2e3440; --nord1: #3b4252; --nord2: #434c5e; --nord3: #4c566a;
    --nord4: #d8dee9; --nord5: #e5e9f0; --nord6: #eceff4;
    --nord7: #8fbcbb; --nord8: #88c0d0; --nord9: #81a1c1; --nord10: #5e81ac;
    --nord11: #bf616a; --nord12: #d08770; --nord13: #ebcb8b; --nord14: #a3be8c; --nord15: #b48ead;
    
    /* New decay-specific colors */
    --decay-positive: var(--nord14); /* Green for beneficial decay */
    --decay-negative: var(--nord11); /* Red for problematic decay */
    --decay-neutral: var(--nord8);   /* Blue for neutral decay */
    --calibration-color: var(--nord15); /* Purple for calibration events */
}

/* Enhanced Month Cards with Decay Information */
.month-card {
    position: relative;
    background: var(--nord6);
    border: 2px solid var(--nord5);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s ease;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(46, 52, 64, 0.08);
}

.month-card.has-decay {
    border-left: 6px solid var(--decay-neutral);
    background: linear-gradient(135deg, var(--nord6) 0%, rgba(136, 192, 208, 0.03) 100%);
}

.month-card.decay-positive {
    border-left-color: var(--decay-positive);
    background: linear-gradient(135deg, var(--nord6) 0%, rgba(163, 190, 140, 0.05) 100%);
}

.month-card.decay-negative {
    border-left-color: var(--decay-negative);
    background: linear-gradient(135deg, var(--nord6) 0%, rgba(191, 97, 106, 0.05) 100%);
}

/* Decay Status Indicator */
.decay-indicator {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--nord5);
    transition: all 0.3s ease;
}

.decay-indicator.active {
    background: var(--decay-neutral);
    box-shadow: 0 0 8px rgba(136, 192, 208, 0.6);
    animation: decayPulse 2s infinite;
}

.decay-indicator.positive {
    background: var(--decay-positive);
    box-shadow: 0 0 8px rgba(163, 190, 140, 0.6);
}

.decay-indicator.negative {
    background: var(--decay-negative);
    box-shadow: 0 0 8px rgba(191, 97, 106, 0.6);
}

@keyframes decayPulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.3); }
}

/* Enhanced Revenue Metrics with Decay Info */
.revenue-metrics {
    margin-bottom: 20px;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--nord5);
}

.metric-row:last-child {
    border-bottom: none;
}

.metric-label {
    font-size: 14px;
    color: var(--nord2);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.decay-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 6px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.decay-badge.positive {
    background: var(--decay-positive);
    color: var(--nord6);
}

.decay-badge.negative {
    background: var(--decay-negative);
    color: var(--nord6);
}

.decay-badge.neutral {
    background: var(--decay-neutral);
    color: var(--nord6);
}

/* Enhanced Gap Analysis with Decay */
.gap-analysis {
    background: linear-gradient(135deg, var(--nord5) 0%, rgba(236, 239, 244, 0.5) 100%);
    border-radius: 12px;
    padding: 16px;
    margin-top: 16px;
}

.gap-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
}

.gap-amount {
    font-weight: 700;
}

.gap-amount.positive {
    color: var(--decay-positive);
}

.gap-amount.negative {
    color: var(--decay-negative);
}

.decay-summary {
    background: linear-gradient(135deg, var(--nord4) 0%, rgba(216, 222, 233, 0.5) 100%);
    border-radius: 12px;
    padding: 16px;
    margin-top: 12px;
    border: 1px solid var(--decay-neutral);
}

.decay-event-count {
    font-size: 12px;
    color: var(--nord2);
    text-align: center;
    margin-top: 8px;
}

.decay-timeline-link {
    color: var(--nord8);
    text-decoration: none;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
}

.decay-timeline-link:hover {
    color: var(--nord9);
    text-decoration: underline;
}

/* Review Session Panel Enhancement */
.review-session-panel {
    background: linear-gradient(135deg, var(--nord6) 0%, var(--nord5) 100%);
    border: 2px solid var(--calibration-color);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 32px;
    box-shadow: 0 8px 24px rgba(180, 142, 173, 0.15);
}

.progress-stats {
    display: flex;
    gap: 20px;
    margin-top: 16px;
}

.progress-stat {
    text-align: center;
    flex: 1;
}

.progress-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--nord0);
}

.progress-label {
    font-size: 12px;
    color: var(--nord2);
    margin-top: 4px;
}

.calibration-controls {
    display: flex;
    gap: 16px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.btn-calibrate {
    background: linear-gradient(135deg, var(--calibration-color) 0%, var(--nord15) 100%);
    color: var(--nord6);
    border: none;
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-calibrate:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(180, 142, 173, 0.4);
}

/* Pipeline Container */
.pipeline-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.pipeline-header {
    background: var(--nord6);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 4px 16px rgba(46, 52, 64, 0.08);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-info h1 {
    color: var(--nord0);
    margin: 0 0 8px 0;
}

.subtitle {
    color: var(--nord2);
    margin: 0;
}

.session-info {
    text-align: right;
}

.session-date {
    font-size: 14px;
    color: var(--nord2);
    margin-bottom: 8px;
}

.session-progress {
    font-size: 16px;
    font-weight: 600;
    color: var(--nord0);
}

/* AE Selector Bar */
.ae-selector-bar {
    background: var(--nord6);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 4px 16px rgba(46, 52, 64, 0.08);
}

.selector-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.ae-selection label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--nord0);
}

.ae-dropdown {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--nord5);
    border-radius: 10px;
    background: var(--nord6);
    color: var(--nord0);
    font-size: 16px;
}

.ae-stats {
    display: flex;
    gap: 32px;
    justify-content: space-around;
    background: var(--nord5);
    border-radius: 12px;
    padding: 20px;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--nord0);
    margin-bottom: 4px;
}

.stat-label {
    font-size: 12px;
    color: var(--nord2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.completion-indicator {
    display: flex;
    justify-content: center;
}

.status-dots {
    display: flex;
    gap: 8px;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--nord4);
    transition: all 0.3s ease;
}

.status-dot.completed {
    background: var(--decay-positive);
}

.status-dot.decay-active {
    border: 2px solid var(--decay-neutral);
}

/* Decay Analytics Dashboard */
.decay-analytics {
    background: var(--nord6);
    border: 2px solid var(--nord5);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    display: none;
}

.decay-analytics.visible {
    display: block;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.analytics-card {
    background: linear-gradient(135deg, var(--nord5) 0%, var(--nord6) 100%);
    border: 1px solid var(--nord4);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.analytics-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--nord0);
    margin-bottom: 8px;
}

.analytics-label {
    font-size: 12px;
    color: var(--nord2);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-weight: 600;
}

/* Status Legend */
.status-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    background: var(--nord5);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
    font-size: 12px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.legend-badge {
    padding: 4px 8px;
    border-radius: 6px;
    font-weight: 700;
    font-size: 10px;
    text-transform: uppercase;
}

.legend-closed {
    background: var(--nord3);
    color: var(--nord6);
}

.legend-current {
    background: var(--nord8);
    color: var(--nord6);
}

.legend-open {
    background: var(--nord14);
    color: var(--nord6);
}

/* Monthly Grid */
.monthly-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 24px;
    margin-bottom: 32px;
}

.quarter-card {
    background: linear-gradient(135deg, var(--nord4) 0%, var(--nord5) 100%);
    border: 2px solid var(--nord3);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 6px 20px rgba(46, 52, 64, 0.1);
}

.month-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.month-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--nord0);
}

.month-status {
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 6px;
    font-weight: 700;
    text-transform: uppercase;
}

.status-closed {
    background: var(--nord3);
    color: var(--nord6);
}

.status-current {
    background: var(--nord8);
    color: var(--nord6);
}

.status-open {
    background: var(--nord14);
    color: var(--nord6);
}

.metric-value {
    font-weight: 700;
    color: var(--nord0);
}

.metric-value.booked {
    color: var(--decay-positive);
}

.metric-value.pipeline {
    color: var(--nord8);
    cursor: pointer;
}

.metric-value.budget {
    color: var(--nord2);
}

.metric-value.disabled {
    cursor: not-allowed;
    opacity: 0.6;
}

.month-summary-display {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
    background: var(--nord5);
    border-radius: 16px;
    color: var(--nord2);
    font-size: 18px;
    text-align: center;
}

/* Pipeline Input */
.pipeline-input {
    width: 100%;
    padding: 4px 8px;
    border: 2px solid var(--nord8);
    border-radius: 6px;
    background: var(--nord6);
    color: var(--nord0);
    font-weight: 700;
    text-align: right;
}

.metric-value.editing {
    background: var(--nord8);
    color: var(--nord6);
    border-radius: 6px;
    padding: 4px;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(46, 52, 64, 0.8);
    backdrop-filter: blur(4px);
}

.modal-content {
    background: var(--nord6);
    margin: 5% auto;
    padding: 0;
    border-radius: 20px;
    width: 90%;
    max-width: 1000px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(46, 52, 64, 0.3);
}

.modal-header {
    background: linear-gradient(135deg, var(--nord1) 0%, var(--nord2) 100%);
    color: var(--nord6);
    padding: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    margin: 0;
}

.close {
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: var(--nord6);
}

.close:hover {
    opacity: 0.7;
}

.modal-body {
    padding: 24px;
    max-height: 60vh;
    overflow-y: auto;
}

.search-box {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--nord5);
    border-radius: 10px;
    background: var(--nord6);
    color: var(--nord0);
    margin-bottom: 20px;
}

.tabs {
    display: flex;
    border-bottom: 2px solid var(--nord5);
    margin-bottom: 20px;
}

.tab {
    padding: 12px 24px;
    background: none;
    border: none;
    color: var(--nord2);
    cursor: pointer;
    font-weight: 600;
    border-bottom: 3px solid transparent;
}

.tab.active {
    color: var(--nord8);
    border-bottom-color: var(--nord8);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.deals-table {
    width: 100%;
    border-collapse: collapse;
}

.deals-table th,
.deals-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--nord5);
}

.deals-table th {
    background: var(--nord5);
    font-weight: 700;
    color: var(--nord0);
}

.deal-amount {
    font-weight: 700;
    color: var(--decay-positive);
}

.deal-status {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
}

.status-booked {
    background: var(--decay-positive);
    color: var(--nord6);
}

.status-pipeline {
    background: var(--nord8);
    color: var(--nord6);
}

/* Decay Timeline Modal */
.decay-timeline-modal {
    display: none;
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(46, 52, 64, 0.8);
    backdrop-filter: blur(4px);
}

.decay-timeline-content {
    background: var(--nord6);
    margin: 5% auto;
    padding: 0;
    border-radius: 20px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(46, 52, 64, 0.3);
    border: 2px solid var(--nord5);
}

.timeline-header {
    background: linear-gradient(135deg, var(--nord1) 0%, var(--nord2) 100%);
    color: var(--nord6);
    padding: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.timeline-body {
    padding: 24px;
    max-height: 60vh;
    overflow-y: auto;
}

.timeline-event {
    display: flex;
    align-items: flex-start;
    padding: 16px;
    margin-bottom: 16px;
    background: var(--nord5);
    border-radius: 12px;
    border-left: 4px solid var(--decay-neutral);
}

.timeline-event.revenue-booked {
    border-left-color: var(--decay-positive);
}

.timeline-event.revenue-removed {
    border-left-color: var(--decay-negative);
}

.timeline-event.calibration {
    border-left-color: var(--calibration-color);
}

.timeline-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 16px;
    font-weight: 700;
    color: var(--nord6);
    font-size: 14px;
}

.timeline-icon.revenue-booked {
    background: var(--decay-positive);
}

.timeline-icon.revenue-removed {
    background: var(--decay-negative);
}

.timeline-icon.calibration {
    background: var(--calibration-color);
}

.timeline-details {
    flex: 1;
}

.timeline-title {
    font-weight: 700;
    color: var(--nord0);
    margin-bottom: 4px;
}

.timeline-description {
    color: var(--nord2);
    font-size: 14px;
    margin-bottom: 8px;
}

.timeline-meta {
    display: flex;
    gap: 16px;
    font-size: 12px;
    color: var(--nord3);
}

/* Alert System */
.alert {
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 12px;
    font-weight: 600;
    animation: slideIn 0.3s ease;
}

.alert-success {
    background: var(--decay-positive);
    color: var(--nord6);
}

.alert-error {
    background: var(--decay-negative);
    color: var(--nord6);
}

.alert-decay {
    background: linear-gradient(135deg, var(--decay-neutral) 0%, var(--nord8) 100%);
    color: var(--nord6);
    border: 2px solid rgba(136, 192, 208, 0.3);
}

.alert-calibration {
    background: linear-gradient(135deg, var(--calibration-color) 0%, var(--nord15) 100%);
    color: var(--nord6);
    border: 2px solid rgba(180, 142, 173, 0.3);
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Button Styles */
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: var(--nord8);
    color: var(--nord6);
}

.btn-primary:hover {
    background: var(--nord9);
    transform: translateY(-1px);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

/* Loading State */
.pipeline-container.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .monthly-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .monthly-grid {
        grid-template-columns: 1fr;
    }
    
    .ae-stats {
        flex-direction: column;
        gap: 16px;
    }
    
    .header-content {
        flex-direction: column;
        gap: 16px;
        text-align: center;
    }
    
    .calibration-controls {
        flex-direction: column;
    }
    
    .decay-timeline-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .progress-stats {
        flex-direction: column;
        gap: 12px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="pipeline-container">
    <!-- Enhanced Header Section -->
    <div class="pipeline-header">
        <div class="header-content">
            <div class="header-info">
                <h1>❄️ Pipeline Revenue Management</h1>
                <p class="subtitle">Nordic ice-themed pipeline with real-time decay tracking</p>
            </div>
            <div class="session-info">
                <div class="session-date">Review Session: {{ data.session_date }}</div>
                <div class="session-progress" id="session-progress">
                    <span id="completed-count">{{ data.session.completed_aes|length }}</span> 
                    of {{ data.ae_list|length }} AEs Reviewed
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced AE Selection Bar -->
    <div class="ae-selector-bar">
        <div class="selector-content">
            <div class="ae-selection">
                <label for="ae-selector">Account Executive:</label>
                <select id="ae-selector" class="ae-dropdown">
                    <option value="">Select an AE to review...</option>
                    {% for ae in data.ae_list %}
                    <option value="{{ ae.ae_id }}" data-name="{{ ae.name }}" data-decay="{{ ae.decay_enabled|lower }}">
                        {{ ae.name }}{% if ae.has_decay_activity %} ⚡{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Enhanced Progress Since Review with Decay Info -->
            <div id="progress-since-review" class="review-session-panel" style="display: none;">
                <div class="progress-header">
                    <h3>Progress Since Last Review</h3>
                    <div class="review-date" id="last-review-date"></div>
                </div>
                <div class="progress-content">
                    <div class="progress-message" id="progress-message"></div>
                    <div class="progress-stats">
                        <div class="progress-stat positive">
                            <div class="progress-value" id="revenue-progress">$0</div>
                            <div class="progress-label">New Revenue Booked</div>
                        </div>
                        <div class="progress-stat positive">
                            <div class="progress-value" id="pipeline-reduction">$0</div>
                            <div class="progress-label">Automatic Decay</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-value" id="decay-events-count">0</div>
                            <div class="progress-label">Decay Events</div>
                        </div>
                    </div>
                </div>
                <div class="calibration-controls">
                    <button type="button" class="btn-calibrate" onclick="startBulkCalibration()">
                        Start Calibration Session
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="viewDecayAnalytics()">
                        View Decay Analytics
                    </button>
                </div>
            </div>

            <div class="ae-stats" id="ae-stats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-value" id="total-revenue">-</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="ytd-attainment">-</div>
                    <div class="stat-label">YTD Attainment</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avg-deal-size">-</div>
                    <div class="stat-label">Avg Deal Size</div>
                </div>
                <div class="stat-item" id="decay-status-stat" style="display: none;">
                    <div class="stat-value" id="decay-activity">-</div>
                    <div class="stat-label">Decay Activity</div>
                </div>
            </div>
            
            <div class="completion-indicator">
                <div class="status-dots" id="status-dots">
                    {% for ae in data.ae_list %}
                    <div class="status-dot{% if ae.has_decay_activity %} decay-active{% endif %}" 
                         data-ae-id="{{ ae.ae_id }}" 
                         title="{{ ae.name }}{% if ae.has_decay_activity %} (Decay Active){% endif %}"></div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Decay Analytics Dashboard -->
    <div id="decay-analytics" class="decay-analytics">
        <h3>❄️ Decay Analytics Dashboard</h3>
        <div class="analytics-grid" id="analytics-grid">
            <!-- Populated dynamically -->
        </div>
    </div>

    <!-- Enhanced Status Legend -->
    <div class="status-legend">
        <div class="legend-item">
            <span class="legend-badge legend-closed">CLOSED</span>
            <span>Historical months - Closed in database, reference only</span>
        </div>
        <div class="legend-item">
            <span class="legend-badge legend-current">CURRENT</span>
            <span>Current month - Active for updates and planning</span>
        </div>
        <div class="legend-item">
            <span class="legend-badge legend-open">OPEN</span>
            <span>Future months - Open for pipeline planning and forecasting</span>
        </div>
        <div class="legend-item">
            <span class="decay-badge positive">DECAY+</span>
            <span>Beneficial decay - Revenue booked reducing pipeline</span>
        </div>
        <div class="legend-item">
            <span class="decay-badge negative">DECAY-</span>
            <span>Problem decay - Revenue lost increasing pipeline need</span>
        </div>
        <div class="legend-item">
            <span class="decay-badge neutral">CALIBRATED</span>
            <span>Recently calibrated - Fresh baseline set</span>
        </div>
    </div>

    <!-- Enhanced Monthly Revenue Cards -->
    <div id="monthly-grid" class="monthly-grid" style="display: none;">
        <!-- Cards will be populated dynamically with decay information -->
    </div>

    <!-- Month Summary Display -->
    <div class="month-summary-display" id="month-summary-display">
        <div>
            ❄️ Select an Account Executive to view their Nordic pipeline analysis with real-time decay tracking
        </div>
    </div>
</div>

<!-- Enhanced Customer Details Modal -->
<div id="customer-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Customer Details</h3>
            <span class="close" onclick="closeCustomerModal()">&times;</span>
        </div>
        <div class="modal-body">
            <input type="text" id="customer-search" class="search-box" 
                   placeholder="Search customers and deals..." 
                   oninput="filterCustomerData(this.value)">
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('booked')">Booked Revenue</button>
                <button class="tab" onclick="switchTab('pipeline')">Pipeline</button>
                <button class="tab" onclick="switchTab('all')">All Deals</button>
            </div>
            
            <div id="booked-content" class="tab-content active">
                <table class="deals-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Spots</th>
                            <th>Revenue</th>
                            <th>First Spot</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="booked-deals">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div id="pipeline-content" class="tab-content">
                <table class="deals-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Deal Description</th>
                            <th>Amount</th>
                            <th>Probability</th>
                            <th>Expected Close</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="pipeline-deals">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div id="all-content" class="tab-content">
                <table class="deals-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Spots</th>
                            <th>Revenue</th>
                            <th>First Spot</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="all-deals">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Decay Timeline Modal -->
<div id="decay-timeline-modal" class="decay-timeline-modal">
    <div class="decay-timeline-content">
        <div class="timeline-header">
            <h3 id="timeline-title">Decay Timeline</h3>
            <span class="close" onclick="closeDecayTimeline()">&times;</span>
        </div>
        <div class="timeline-body" id="timeline-body">
            <!-- Populated dynamically -->
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 1001;">
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('Enhanced Pipeline Revenue Management with Decay loading...');

// Global state - enhanced for decay
let currentAE = null;
let currentMonthlyData = [];
let currentQuarterlyData = [];
let currentDecayAnalytics = null;
let sessionData = {{ data.session | tojson | safe }};
let originalPipelineValues = {};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Enhanced Pipeline Revenue Management page loaded');
    updateCompletionStatus();
    setupEventListeners();
});

function setupEventListeners() {
    // AE selector change
    document.getElementById('ae-selector').addEventListener('change', function() {
        const aeId = this.value;
        if (aeId) {
            loadAEData(aeId);
        } else {
            hideAEData();
        }
    });
}

async function loadAEData(aeId) {
    try {
        showLoading(true);
        
        // Get AE summary data with decay information
        const response = await fetch(`/api/ae/${aeId}/summary`);
        const result = await response.json();
        
        if (result.success) {
            currentAE = result.data.ae_info;
            currentMonthlyData = result.data.monthly_summary;
            currentQuarterlyData = result.data.quarterly_summary || [];
            currentDecayAnalytics = result.data.decay_analytics || null;
            
            displayAEStats(currentAE);
            displayProgressSinceReview(result.data.progress_since_review);
            displayMonthlyCards(currentMonthlyData, currentQuarterlyData);
            displayDecayAnalytics(currentDecayAnalytics);
            showAEData();
            
            // Store original pipeline values for change tracking
            originalPipelineValues = {};
            currentMonthlyData.forEach(month => {
                originalPipelineValues[month.month] = month.current_pipeline;
            });
            
        } else {
            showAlert('error', result.error || 'Failed to load AE data');
        }
    } catch (error) {
        console.error('Error loading AE data:', error);
        showAlert('error', 'Failed to load AE data');
    } finally {
        showLoading(false);
    }
}

function displayAEStats(ae) {
    // Calculate attainment percentage
    const attainment = ae.ytd_target > 0 ? Math.round((ae.ytd_actual / ae.ytd_target) * 100) : 0;
    const avgDeal = ae.avg_deal_size ? formatCurrency(ae.avg_deal_size) : '$0';
    const totalRevenue = ae.ytd_actual ? formatCurrency(ae.ytd_actual) : '$0';
    
    document.getElementById('ytd-attainment').textContent = `${attainment}%`;
    document.getElementById('avg-deal-size').textContent = avgDeal;
    document.getElementById('total-revenue').textContent = totalRevenue;
    
    // Show decay activity if available
    if (ae.decay_enabled && ae.decay_analytics) {
        const decayActivityElement = document.getElementById('decay-activity');
        const decayStatElement = document.getElementById('decay-status-stat');
        
        if (decayActivityElement && decayStatElement) {
            const totalEvents = ae.decay_analytics.overall_metrics?.total_decay_events || 0;
            decayActivityElement.textContent = totalEvents > 0 ? `${totalEvents} events` : 'None';
            decayStatElement.style.display = 'block';
        }
    }
}

function displayDecayAnalytics(analytics) {
    const analyticsContainer = document.getElementById('decay-analytics');
    const analyticsGrid = document.getElementById('analytics-grid');
    
    if (!analytics || !analytics.overall_metrics) {
        analyticsContainer.classList.remove('visible');
        return;
    }
    
    analyticsContainer.classList.add('visible');
    
    const metrics = analytics.overall_metrics;
    
    analyticsGrid.innerHTML = `
        <div class="analytics-card">
            <div class="analytics-value">${formatCurrency(metrics.avg_daily_decay_rate || 0)}</div>
            <div class="analytics-label">Avg Daily Decay</div>
        </div>
        <div class="analytics-card">
            <div class="analytics-value">${(metrics.avg_decay_percentage || 0).toFixed(1)}%</div>
            <div class="analytics-label">Avg Decay %</div>
        </div>
        <div class="analytics-card">
            <div class="analytics-value">${metrics.total_decay_events || 0}</div>
            <div class="analytics-label">Total Events</div>
        </div>
        <div class="analytics-card">
            <div class="analytics-value">${metrics.months_analyzed || 0}</div>
            <div class="analytics-label">Months Tracked</div>
        </div>
    `;
}

function displayMonthlyCards(monthlyData, quarterlyData = []) {
    const grid = document.getElementById('monthly-grid');
    const summaryDisplay = document.getElementById('month-summary-display');

    if (!monthlyData || monthlyData.length === 0) {
        grid.style.display = 'none';
        summaryDisplay.style.display = 'flex';
        summaryDisplay.innerHTML = '<div>❄️ No monthly data available for this Account Executive</div>';
        return;
    }

    grid.style.display = 'grid';
    summaryDisplay.style.display = 'none';
    grid.innerHTML = '';

    // Define quarters with their months arranged in 4-column rows
    const currentYear = new Date().getFullYear();
    const quarters = [
        { name: `Q1 ${currentYear}`, months: [`${currentYear}-01`, `${currentYear}-02`, `${currentYear}-03`], rowMonths: [`${currentYear}-01`, `${currentYear}-02`, `${currentYear}-03`] },
        { name: `Q2 ${currentYear}`, months: [`${currentYear}-04`, `${currentYear}-05`, `${currentYear}-06`], rowMonths: [`${currentYear}-04`, `${currentYear}-05`, `${currentYear}-06`] },
        { name: `Q3 ${currentYear}`, months: [`${currentYear}-07`, `${currentYear}-08`, `${currentYear}-09`], rowMonths: [`${currentYear}-07`, `${currentYear}-08`, `${currentYear}-09`] },
        { name: `Q4 ${currentYear}`, months: [`${currentYear}-10`, `${currentYear}-11`, `${currentYear}-12`], rowMonths: [`${currentYear}-10`, `${currentYear}-11`, `${currentYear}-12`] }
    ];

    quarters.forEach(quarter => {
        // Add 3 monthly card slots for this quarter row
        quarter.rowMonths.forEach(monthStr => {
            if (monthStr) {
                const month = monthlyData.find(m => m.month === monthStr);
                if (month) {
                    const card = createMonthCard(month);
                    grid.appendChild(card);
                } else {
                    // Add empty placeholder if month data is missing
                    const emptyCard = document.createElement('div');
                    emptyCard.className = 'month-card empty-slot';
                    emptyCard.innerHTML = '<div class="month-header"><div class="month-title">No Data</div></div>';
                    grid.appendChild(emptyCard);
                }
            }
        });

        // Add quarterly summary card as the 4th column
        const quarterData = quarterlyData.find(q => q.quarter_name === quarter.name);
        if (quarterData) {
            const quarterCard = createQuarterCard(quarterData);
            grid.appendChild(quarterCard);
        } else {
            // Add empty placeholder if quarter data is missing
            const emptyCard = document.createElement('div');
            emptyCard.className = 'quarter-card empty-slot';
            emptyCard.innerHTML = '<div class="month-header"><div class="month-title">No Quarter Data</div></div>';
            grid.appendChild(emptyCard);
        }
    });
}

function createMonthCard(month) {
    const card = document.createElement('div');
    card.className = 'month-card';

    // Determine month status
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth() + 1;
    const currentYear = currentDate.getFullYear();
    const [monthYear, monthNum] = month.month.split('-');
    const monthNumber = parseInt(monthNum);

    let monthStatus = 'open';
    let statusText = 'Open';
    
    if (parseInt(monthYear) < currentYear || (parseInt(monthYear) === currentYear && monthNumber < currentMonth)) {
        card.classList.add('closed-month');
        monthStatus = 'closed';
        statusText = 'Closed';
    } else if (parseInt(monthYear) === currentYear && monthNumber === currentMonth) {
        card.classList.add('current-month');
        monthStatus = 'current';
        statusText = 'Current';
    } else {
        card.classList.add('open-month');
        monthStatus = 'open';
        statusText = 'Open';
    }
    
    // Add decay indicators
    let decayIndicator = '';
    let decaySection = '';
    let decayClass = '';
    
    if (month.has_decay_activity) {
        card.classList.add('has-decay');
        
        const totalDecay = month.total_decay || 0;
        if (totalDecay < 0) {
            decayClass = 'decay-positive';
            card.classList.add('decay-positive');
        } else if (totalDecay > 0) {
            decayClass = 'decay-negative';
            card.classList.add('decay-negative');
        }
        
        decayIndicator = `<div class="decay-indicator active ${decayClass}"></div>`;
        
        decaySection = `
            <div class="decay-summary">
                <div class="gap-row">
                    <span>Total Decay:</span>
                    <span class="gap-amount ${totalDecay <= 0 ? 'positive' : 'negative'}">
                        ${totalDecay <= 0 ? '+' : '-'}${formatCurrency(Math.abs(totalDecay))}
                    </span>
                </div>
                <div class="gap-row">
                    <span>Days Since Cal:</span>
                    <span>${month.days_since_calibration || 0} days</span>
                </div>
                <div class="decay-event-count">
                    ${month.decay_events_count || 0} decay events
                    ${month.decay_events_count > 0 ? `<br><a href="#" class="decay-timeline-link" onclick="showDecayTimeline('${month.month}')">View Timeline</a>` : ''}
                </div>
            </div>
        `;
    }
    
    card.innerHTML = `
        ${decayIndicator}
        <div class="month-header">
            <div class="month-title">${month.month_display}</div>
            <div class="month-status status-${monthStatus}">
                ${statusText}
            </div>
        </div>
        
        <div class="revenue-metrics">
            <div class="metric-row">
                <span class="metric-label">
                    Booked Revenue:
                    ${month.has_decay_activity && month.total_decay < 0 ? '<span class="decay-badge positive">AUTO</span>' : ''}
                </span>
                <span class="metric-value booked">${formatCurrency(month.booked_revenue)}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">
                    Current Pipeline:
                    ${month.has_decay_activity ? '<span class="decay-badge neutral">LIVE</span>' : ''}
                </span>
                <span class="metric-value pipeline ${monthStatus === 'closed' ? 'disabled' : ''}"
                      ${monthStatus !== 'closed' ? `onclick="editPipeline('${month.month}', this)"` : ''}
                      data-original="${month.current_pipeline}">
                    ${formatCurrency(month.current_pipeline)}
                </span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Budget (ref):</span>
                <span class="metric-value budget">${formatCurrency(month.budget)}</span>
            </div>
        </div>
        
        <div class="gap-analysis">
            <div class="gap-row gap-secondary">
                <span>Budget Gap:</span>
                <span class="gap-amount ${month.budget_gap >= 0 ? 'positive' : 'negative'}">
                    ${month.budget_gap >= 0 ? '+' : '-'}${formatCurrency(Math.abs(month.budget_gap))}
                </span>
            </div>
        </div>
        
        ${decaySection}
        
        <div class="card-actions" style="margin-top: 16px;">
            <button class="btn btn-primary btn-sm" onclick="openCustomerModal('${month.month}')">
                View Customers
            </button>
            ${month.has_decay_activity ? `
                <button class="btn btn-sm" onclick="showDecayTimeline('${month.month}')"
                        style="background: var(--decay-neutral); color: var(--nord6); border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-left: 8px;">
                    Decay Timeline
                </button>
            ` : ''}
        </div>
    `;
    
    return card;
}

function createQuarterCard(quarter) {
    const card = document.createElement('div');
    card.className = 'quarter-card';

    card.innerHTML = `
        <div class="month-header">
            <div class="month-title">${quarter.quarter_name}</div>
            <div class="month-status">
                QUARTER TOTAL
            </div>
        </div>

        <div class="revenue-metrics">
            <div class="metric-row">
                <span class="metric-label">Booked Revenue:</span>
                <span class="metric-value booked">${formatCurrency(quarter.booked_revenue)}</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Current Pipeline:</span>
                <span class="metric-value" style="color: var(--nord8);">
                    ${formatCurrency(quarter.current_pipeline)}
                </span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Budget (ref):</span>
                <span class="metric-value budget">${formatCurrency(quarter.budget)}</span>
            </div>
        </div>

        <div class="gap-analysis">
            <div class="gap-row gap-secondary">
                <span>Budget Gap:</span>
                <span class="gap-amount ${quarter.budget_gap >= 0 ? 'positive' : 'negative'}">
                    ${quarter.budget_gap >= 0 ? '+' : '-'}${formatCurrency(Math.abs(quarter.budget_gap))}
                </span>
            </div>
        </div>

        <div class="quarter-status" style="margin-top: 16px; text-align: center; font-size: 14px;">
            <strong>${quarter.month_count || 3} months</strong>
            <div style="margin-top: 4px; ${getQuarterStatusStyle(quarter.quarter_name)}">
                ${determineQuarterCompletion(quarter.quarter_name)}
            </div>
        </div>
    `;

    return card;
}

function determineQuarterCompletion(quarterName) {
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth() + 1;
    const currentYear = currentDate.getFullYear();
    
    const quarterMap = {
        [`Q1 ${currentYear}`]: { startMonth: 1, endMonth: 3, year: currentYear },
        [`Q2 ${currentYear}`]: { startMonth: 4, endMonth: 6, year: currentYear },
        [`Q3 ${currentYear}`]: { startMonth: 7, endMonth: 9, year: currentYear },
        [`Q4 ${currentYear}`]: { startMonth: 10, endMonth: 12, year: currentYear }
    };
    
    const quarter = quarterMap[quarterName];
    if (!quarter) return 'Unknown';
    
    if (currentYear > quarter.year || 
        (currentYear === quarter.year && currentMonth > quarter.endMonth)) {
        return '✓ Complete';
    }
    else if (currentYear === quarter.year && 
             currentMonth >= quarter.startMonth && 
             currentMonth <= quarter.endMonth) {
        return 'In Progress';
    }
    else {
        return 'Planned';
    }
}

function getQuarterStatusStyle(quarterName) {
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth() + 1;
    const currentYear = currentDate.getFullYear();
    
    const quarterMap = {
        [`Q1 ${currentYear}`]: { startMonth: 1, endMonth: 3, year: currentYear },
        [`Q2 ${currentYear}`]: { startMonth: 4, endMonth: 6, year: currentYear },
        [`Q3 ${currentYear}`]: { startMonth: 7, endMonth: 9, year: currentYear },
        [`Q4 ${currentYear}`]: { startMonth: 10, endMonth: 12, year: currentYear }
    };
    
    const quarter = quarterMap[quarterName];
    if (!quarter) return 'color: var(--nord2);';
    
    if (currentYear > quarter.year || 
        (currentYear === quarter.year && currentMonth > quarter.endMonth)) {
        return 'color: var(--nord14); font-weight: 600;';
    }
    else if (currentYear === quarter.year && 
             currentMonth >= quarter.startMonth && 
             currentMonth <= quarter.endMonth) {
        return 'color: var(--nord8); font-weight: 500;';
    }
    else {
        return 'color: var(--nord15); font-weight: 400;';
    }
}

function displayProgressSinceReview(progressData) {
    const progressPanel = document.getElementById('progress-since-review');
    
    if (!progressData) {
        progressPanel.style.display = 'block';
        document.getElementById('last-review-date').textContent = 'No previous review session';
        document.getElementById('progress-message').textContent = 
            'Start your first review session to begin tracking pipeline decay and progress between reviews.';
        
        const statsDiv = document.querySelector('.progress-stats');
        if (statsDiv) statsDiv.style.display = 'none';
        
        const button = document.querySelector('#progress-since-review .btn-calibrate');
        if (button) button.textContent = 'Start First Review Session';
        return;
    }
    
    progressPanel.style.display = 'block';
    const statsDiv = document.querySelector('.progress-stats');
    if (statsDiv) statsDiv.style.display = 'flex';
    
    const reviewDate = new Date(progressData.last_review_date);
    document.getElementById('last-review-date').textContent = 
        `Last review: ${reviewDate.toLocaleDateString()}`;
    
    const message = `Since our last review ${getDaysAgo(reviewDate)} days ago, we've booked ${formatCurrency(progressData.revenue_progress)} additional revenue, with ${progressData.decay_events_count || 0} automatic decay adjustments applied.`;
    
    document.getElementById('progress-message').textContent = message;
    
    document.getElementById('revenue-progress').textContent = formatCurrency(progressData.revenue_progress);
    document.getElementById('pipeline-reduction').textContent = formatCurrency(progressData.pipeline_reduction);
    document.getElementById('decay-events-count').textContent = progressData.decay_events_count || 0;
}

function getDaysAgo(date) {
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    return Math.floor(diff / (1000 * 60 * 60 * 24));
}

function showAEData() {
    document.getElementById('ae-stats').style.display = 'flex';
    document.getElementById('monthly-grid').style.display = 'grid';
    document.getElementById('month-summary-display').style.display = 'none';
}

function hideAEData() {
    document.getElementById('ae-stats').style.display = 'none';
    document.getElementById('monthly-grid').style.display = 'none';
    document.getElementById('month-summary-display').style.display = 'flex';
    document.getElementById('progress-since-review').style.display = 'none';
    document.getElementById('decay-analytics').classList.remove('visible');
}

function updateCompletionStatus() {
    const dots = document.querySelectorAll('.status-dot');
    const completedAEs = sessionData.completed_aes || [];
    
    dots.forEach(dot => {
        const aeId = dot.dataset.aeId;
        if (completedAEs.includes(aeId)) {
            dot.classList.add('completed');
        }
    });
    
    document.getElementById('completed-count').textContent = completedAEs.length;
}

// Enhanced pipeline editing with decay awareness
async function editPipeline(month, element) {
    const currentValue = parseFloat(element.dataset.original) || 0;
    const input = document.createElement('input');
    input.type = 'number';
    input.className = 'pipeline-input';
    input.value = currentValue;
    input.step = '1000';
    
    element.classList.add('editing');
    element.innerHTML = '';
    element.appendChild(input);
    
    input.focus();
    input.select();
    
    const saveValue = async () => {
        const newValue = parseFloat(input.value) || 0;
        
        if (newValue !== currentValue) {
            try {
                // This will trigger calibration in the enhanced system
                const response = await fetch(`/api/pipeline/decay/calibration`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ae_id: currentAE.ae_id,
                        month: month,
                        pipeline_value: newValue,
                        calibrated_by: 'manual_review',
                        session_id: `session_${Date.now()}`
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the display
                    element.dataset.original = newValue;
                    element.innerHTML = formatCurrency(newValue);
                    element.classList.remove('editing');
                    
                    // Refresh the data to show decay information
                    loadAEData(currentAE.ae_id);
                    
                    showAlert('calibration', `Pipeline calibrated: ${formatCurrency(newValue)}`);
                } else {
                    element.innerHTML = formatCurrency(currentValue);
                    element.classList.remove('editing');
                    showAlert('error', result.error || 'Failed to calibrate pipeline');
                }
            } catch (error) {
                element.innerHTML = formatCurrency(currentValue);
                element.classList.remove('editing');
                showAlert('error', 'Network error calibrating pipeline');
            }
        } else {
            element.innerHTML = formatCurrency(currentValue);
            element.classList.remove('editing');
        }
    };
    
    input.addEventListener('blur', saveValue);
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            saveValue();
        } else if (e.key === 'Escape') {
            element.innerHTML = formatCurrency(currentValue);
            element.classList.remove('editing');
        }
    });
}

// Customer Modal Functions
async function openCustomerModal(month) {
    try {
        const response = await fetch(`/api/customers/${currentAE.ae_id}/${month}`);
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            const totalCustomers = data.all_deals ? data.all_deals.length : 0;
            
            document.getElementById('modal-title').textContent = 
                `${currentAE.name} - ${formatMonthYear(month)} (${totalCustomers} customers)`;
            
            populateCustomerTable('booked-deals', data.booked_deals || []);
            populateCustomerTable('pipeline-deals', data.pipeline_deals || []);
            populateCustomerTable('all-deals', data.all_deals || []);
            
            document.getElementById('customer-modal').style.display = 'block';
        } else {
            showAlert('error', result.error || 'Failed to load customer data');
        }
    } catch (error) {
        console.error('Error loading customer data:', error);
        showAlert('error', 'Failed to load customer data');
    }
}

function populateCustomerTable(tableId, customers) {
    const tbody = document.getElementById(tableId);
    tbody.innerHTML = '';
    
    if (customers.length === 0) {
        const message = tableId === 'pipeline-deals' ? 
            'No pipeline deals from historical data' : 
            'No customers found';
        tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--nord2);">${message}</td></tr>`;
        return;
    }
    
    customers.forEach(customer => {
        const row = document.createElement('tr');
        
        let status = 'Booked';
        let statusClass = 'status-booked';
        if (tableId === 'pipeline-deals') {
            status = 'Pipeline';
            statusClass = 'status-pipeline';
        }
        
        row.innerHTML = `
            <td>${customer.customer_name || 'Unknown Customer'}</td>
            <td>${customer.spot_count || 0} spots</td>
            <td class="deal-amount">${formatCurrency(customer.total_revenue || 0)}</td>
            <td>${customer.first_spot ? customer.first_spot.split(' ')[0] : 'N/A'}</td>
            <td><span class="deal-status ${statusClass}">${status}</span></td>
        `;
        
        tbody.appendChild(row);
    });
}

function closeCustomerModal() {
    document.getElementById('customer-modal').style.display = 'none';
    document.getElementById('customer-search').value = '';
}

function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tabName}-content`).classList.add('active');
}

function filterCustomerData(searchTerm) {
    const term = searchTerm.toLowerCase();
    document.querySelectorAll('.deals-table tbody tr').forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
    });
}

function formatMonthYear(monthStr) {
    const [year, month] = monthStr.split('-');
    const date = new Date(year, month - 1);
    return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
}

// New decay-specific functions
async function showDecayTimeline(month) {
    if (!currentAE) return;
    
    try {
        const response = await fetch(`/api/pipeline/decay/timeline/${currentAE.ae_id}/${month}`);
        const result = await response.json();
        
        if (result.success) {
            const modal = document.getElementById('decay-timeline-modal');
            const title = document.getElementById('timeline-title');
            const body = document.getElementById('timeline-body');
            
            title.textContent = `Decay Timeline - ${currentAE.name} - ${formatMonthYear(month)}`;
            
            // Populate timeline events
            const timeline = result.data.timeline || [];
            body.innerHTML = '';
            
            if (timeline.length === 0) {
                body.innerHTML = '<p style="text-align: center; color: var(--nord2);">No decay events for this month.</p>';
            } else {
                timeline.forEach(event => {
                    const eventElement = createTimelineEvent(event);
                    body.appendChild(eventElement);
                });
            }
            
            modal.style.display = 'block';
        } else {
            showAlert('error', 'Failed to load decay timeline');
        }
    } catch (error) {
        showAlert('error', 'Error loading decay timeline');
    }
}

function createTimelineEvent(event) {
    const eventDiv = document.createElement('div');
    eventDiv.className = `timeline-event ${event.event_type}`;
    
    const iconText = {
        'revenue_booked': '💰',
        'revenue_removed': '❌',
        'calibration_reset': '⚙️',
        'manual_adjustment': '✏️'
    }[event.event_type] || '•';
    
    const eventDate = new Date(event.timestamp).toLocaleString();
    
    eventDiv.innerHTML = `
        <div class="timeline-icon ${event.event_type}">
            ${iconText}
        </div>
        <div class="timeline-details">
            <div class="timeline-title">${event.description || event.event_type}</div>
            <div class="timeline-description">
                ${event.customer ? `Customer: ${event.customer} • ` : ''}
                Amount: ${formatCurrency(event.amount)} • 
                Pipeline: ${formatCurrency(event.old_pipeline)} → ${formatCurrency(event.new_pipeline)}
            </div>
            <div class="timeline-meta">
                <span>📅 ${eventDate}</span>
                <span>👤 ${event.created_by}</span>
            </div>
        </div>
    `;
    
    return eventDiv;
}

function closeDecayTimeline() {
    document.getElementById('decay-timeline-modal').style.display = 'none';
}

function startBulkCalibration() {
    showAlert('calibration', 'Bulk calibration feature coming soon!');
}

function viewDecayAnalytics() {
    const analyticsContainer = document.getElementById('decay-analytics');
    if (analyticsContainer.classList.contains('visible')) {
        analyticsContainer.classList.remove('visible');
    } else {
        analyticsContainer.classList.add('visible');
        analyticsContainer.scrollIntoView({ behavior: 'smooth' });
    }
}

async function createNewReviewSnapshot() {
    if (!currentAE) return;
    
    try {
        const response = await fetch(`/api/review/snapshot/${currentAE.ae_id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', 'Review snapshot created successfully');
            loadAEData(currentAE.ae_id);
        } else {
            showAlert('error', result.error || 'Failed to create review snapshot');
        }
    } catch (error) {
        showAlert('error', 'Network error creating review snapshot');
    }
}

// Enhanced alert system
function showAlert(type, message) {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    
    container.appendChild(alert);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

// Utility functions
function formatCurrency(amount) {
    if (amount === null || amount === undefined) return '$0';
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function showLoading(show) {
    const container = document.querySelector('.pipeline-container');
    if (show) {
        container.classList.add('loading');
    } else {
        container.classList.remove('loading');
    }
}

console.log('Enhanced Pipeline Revenue Management with Decay initialized');
</script>
{% endblock %}