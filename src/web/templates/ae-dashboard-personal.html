{% extends "base.html" %}

{% block title %}{{ title }} - CTV Reports{% endblock %}

{% block header_title %}{{ title }}{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">›</span>
<span class="breadcrumb-link">Reports</span>
<span class="breadcrumb-separator">›</span>
<span class="breadcrumb-current">My Dashboard</span>
{% endblock %}

{% block extra_styles %}
<style>
/* Dashboard Container */
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
}

/* Summary Cards */
.summary-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 32px;
}

.summary-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.summary-card h3 {
    font-size: 14px;
    font-weight: 600;
    color: #718096;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0 0 12px 0;
}

.summary-card .amount {
    font-size: 32px;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 8px;
}

.summary-card .percentage {
    font-size: 16px;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 4px;
    display: inline-block;
}

.summary-card .percentage.positive {
    background: #c6f6d5;
    color: #22543d;
}

.summary-card .percentage.negative {
    background: #fed7d7;
    color: #742a2a;
}

.summary-card .percentage.neutral {
    background: #edf2f7;
    color: #4a5568;
}

/* Monthly Table */
.monthly-table-container {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.monthly-table-header {
    background: linear-gradient(135deg, #2e3440 0%, #3b4252 100%);
    color: white;
    padding: 20px 24px;
    border-bottom: 2px solid #4c566a;
}

.monthly-table-header h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
}

.monthly-table {
    width: 100%;
    border-collapse: collapse;
}

.monthly-table thead {
    background: #f7fafc;
    border-bottom: 2px solid #e2e8f0;
}

.monthly-table th {
    padding: 12px 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    color: #4a5568;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.monthly-table th.numeric {
    text-align: right;
}

.monthly-table td {
    padding: 14px 16px;
    border-bottom: 1px solid #e2e8f0;
    font-size: 14px;
    color: #2d3748;
}

.monthly-table td.numeric {
    text-align: right;
    font-feature-settings: "tnum";
}

.monthly-table tbody tr:hover {
    background: #f7fafc;
}

.monthly-table tbody tr:last-child td {
    border-bottom: none;
}

.month-name {
    font-weight: 600;
    color: #2d3748;
}

.amount-cell {
    font-weight: 500;
    color: #2d3748;
}

.percentage-cell {
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
    min-width: 60px;
    text-align: center;
}

.percentage-cell.positive {
    background: #c6f6d5;
    color: #22543d;
}

.percentage-cell.negative {
    background: #fed7d7;
    color: #742a2a;
}

.percentage-cell.neutral {
    background: #edf2f7;
    color: #4a5568;
}

/* Year Totals Row */
.year-totals-row {
    background: #f7fafc;
    font-weight: 600;
    border-top: 2px solid #2d3748;
}

.year-totals-row td {
    padding: 16px;
    font-size: 15px;
    color: #2d3748;
}

/* Responsive */
@media (max-width: 1024px) {
    .summary-cards {
        grid-template-columns: 1fr;
    }
    
    .monthly-table-container {
        overflow-x: auto;
    }
    
    .monthly-table {
        min-width: 800px;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 16px;
    }
    
    .summary-card .amount {
        font-size: 24px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- AE Selector (for admins/management) -->
    {% if is_admin_or_management %}
    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
        <form method="GET" action="/reports/ae-dashboard-personal" style="display: flex; align-items: center; gap: 16px;">
            <label for="ae-select" style="font-weight: 600; color: #4a5568; font-size: 14px;">Select AE:</label>
            <select id="ae-select" name="ae" onchange="this.form.submit()" style="flex: 1; max-width: 400px; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 14px; background: white;">
                <option value="">-- Select an AE --</option>
                {% for ae in ae_list %}
                <option value="{{ ae }}" {% if selected_ae == ae %}selected{% endif %}>{{ ae }}</option>
                {% endfor %}
            </select>
            {% if selected_ae %}
            <a href="/reports/ae-dashboard-personal" style="padding: 8px 16px; background: #e2e8f0; color: #4a5568; text-decoration: none; border-radius: 4px; font-size: 14px;">Clear</a>
            {% endif %}
        </form>
    </div>
    {% endif %}
    
    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card">
            <h3>Total Booked Revenue</h3>
            <div class="amount">${{ "{:,.0f}".format(totals.booked) }}</div>
            <div>
                <span class="percentage {% if totals.booked_vs_budget_pct >= 100 %}positive{% elif totals.booked_vs_budget_pct >= 80 %}neutral{% else %}negative{% endif %}">
                    {{ "{:.1f}".format(totals.booked_vs_budget_pct) }}% of Budget
                </span>
            </div>
        </div>
        
        <div class="summary-card">
            <h3>Total Forecast</h3>
            <div class="amount">${{ "{:,.0f}".format(totals.forecast) }}</div>
            <div>
                <span class="percentage {% if totals.forecast_vs_budget_pct >= 100 %}positive{% elif totals.forecast_vs_budget_pct >= 90 %}neutral{% else %}negative{% endif %}">
                    {{ "{:.1f}".format(totals.forecast_vs_budget_pct) }}% of Budget
                </span>
            </div>
        </div>
        
        <div class="summary-card">
            <h3>Total Budget</h3>
            <div class="amount">${{ "{:,.0f}".format(totals.budget) }}</div>
            <div>
                <span class="percentage neutral">
                    {{ "{:.1f}".format(totals.booked_vs_forecast_pct) }}% Booked vs Forecast
                </span>
            </div>
        </div>
    </div>
    
    <!-- Monthly Table -->
    <div class="monthly-table-container">
        <div class="monthly-table-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0;">{{ year }} Monthly Performance - {{ ae_name }}</h2>
            <div style="display: flex; align-items: center; gap: 12px;">
                <label for="year-filter" style="font-size: 14px; color: white; font-weight: 500;">Year:</label>
                <select id="year-filter" style="padding: 6px 12px; border: 1px solid rgba(255,255,255,0.5); border-radius: 4px; background: white; color: #2d3748; font-size: 14px; cursor: pointer;">
                    {% for y in available_years %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <table class="monthly-table">
            <thead>
                <tr>
                    <th>Month</th>
                    <th class="numeric">Booked Revenue</th>
                    <th class="numeric">Forecast</th>
                    <th class="numeric">Budget</th>
                    <th class="numeric">Booked vs Forecast</th>
                    <th class="numeric">Forecast vs Budget</th>
                    <th class="numeric">Booked vs Budget</th>
                </tr>
            </thead>
            <tbody>
                {% for month in monthly_data %}
                <tr>
                    <td class="month-name">{{ month.month_name }}</td>
                    <td class="numeric amount-cell">${{ "{:,.0f}".format(month.booked_revenue) }}</td>
                    <td class="numeric amount-cell">${{ "{:,.0f}".format(month.forecast) }}</td>
                    <td class="numeric amount-cell">${{ "{:,.0f}".format(month.budget) }}</td>
                    <td class="numeric">
                        <span class="percentage-cell {% if month.booked_vs_forecast_pct >= 100 %}positive{% elif month.booked_vs_forecast_pct >= 80 %}neutral{% else %}negative{% endif %}">
                            {{ "{:.1f}".format(month.booked_vs_forecast_pct) }}%
                        </span>
                    </td>
                    <td class="numeric">
                        <span class="percentage-cell {% if month.forecast_vs_budget_pct >= 100 %}positive{% elif month.forecast_vs_budget_pct >= 90 %}neutral{% else %}negative{% endif %}">
                            {{ "{:.1f}".format(month.forecast_vs_budget_pct) }}%
                        </span>
                    </td>
                    <td class="numeric">
                        <span class="percentage-cell {% if month.booked_vs_budget_pct >= 100 %}positive{% elif month.booked_vs_budget_pct >= 80 %}neutral{% else %}negative{% endif %}">
                            {{ "{:.1f}".format(month.booked_vs_budget_pct) }}%
                        </span>
                    </td>
                </tr>
                {% endfor %}
                
                <!-- Year Totals Row -->
                <tr class="year-totals-row">
                    <td><strong>Year Total</strong></td>
                    <td class="numeric"><strong>${{ "{:,.0f}".format(totals.booked) }}</strong></td>
                    <td class="numeric"><strong>${{ "{:,.0f}".format(totals.forecast) }}</strong></td>
                    <td class="numeric"><strong>${{ "{:,.0f}".format(totals.budget) }}</strong></td>
                    <td class="numeric">
                        <span class="percentage-cell {% if totals.booked_vs_forecast_pct >= 100 %}positive{% elif totals.booked_vs_forecast_pct >= 80 %}neutral{% else %}negative{% endif %}">
                            {{ "{:.1f}".format(totals.booked_vs_forecast_pct) }}%
                        </span>
                    </td>
                    <td class="numeric">
                        <span class="percentage-cell {% if totals.forecast_vs_budget_pct >= 100 %}positive{% elif totals.forecast_vs_budget_pct >= 90 %}neutral{% else %}negative{% endif %}">
                            {{ "{:.1f}".format(totals.forecast_vs_budget_pct) }}%
                        </span>
                    </td>
                    <td class="numeric">
                        <span class="percentage-cell {% if totals.booked_vs_budget_pct >= 100 %}positive{% elif totals.booked_vs_budget_pct >= 80 %}neutral{% else %}negative{% endif %}">
                            {{ "{:.1f}".format(totals.booked_vs_budget_pct) }}%
                        </span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Account Revenue Module -->
    <div class="account-revenue-container" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); margin-top: 32px;">
        <div class="monthly-table-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
            <div>
                <h2 style="margin: 0;">Account Revenue - {{ ae_name }}</h2>
                <div id="account-count-display" style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 4px;">
                    {% if total_account_count %}
                        {{ total_account_count }} account{{ 's' if total_account_count != 1 else '' }}
                    {% else %}
                        0 accounts
                    {% endif %}
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <label for="account-start-date" style="font-size: 14px; color: white; font-weight: 500; white-space: nowrap;">Start Date:</label>
                <input type="date" id="account-start-date" value="{{ account_start_date or '' }}" style="padding: 6px 12px; border: 1px solid rgba(255,255,255,0.5); border-radius: 4px; background: white; color: #2d3748; font-size: 14px;">
                <label for="account-end-date" style="font-size: 14px; color: white; font-weight: 500; white-space: nowrap;">End Date:</label>
                <input type="date" id="account-end-date" value="{{ account_end_date or '' }}" style="padding: 6px 12px; border: 1px solid rgba(255,255,255,0.5); border-radius: 4px; background: white; color: #2d3748; font-size: 14px;">
                <button id="account-date-reset" style="padding: 6px 16px; border: 1px solid rgba(255,255,255,0.5); border-radius: 4px; background: white; color: #2d3748; font-size: 14px; cursor: pointer; font-weight: 500;">Reset Date</button>
                <label for="sector-sort" style="font-size: 14px; color: white; font-weight: 500; white-space: nowrap; margin-left: 8px;">Sort Sectors:</label>
                <select id="sector-sort" style="padding: 6px 12px; border: 1px solid rgba(255,255,255,0.5); border-radius: 4px; background: white; color: #2d3748; font-size: 14px; cursor: pointer; min-width: 180px;">
                    <option value="name-asc">Alphabetical (A-Z)</option>
                    <option value="name-desc">Alphabetical (Z-A)</option>
                    <option value="revenue-desc">Revenue (High to Low)</option>
                    <option value="revenue-asc">Revenue (Low to High)</option>
                </select>
                <label for="account-sort" style="font-size: 14px; color: white; font-weight: 500; white-space: nowrap;">Sort Accounts:</label>
                <select id="account-sort" style="padding: 6px 12px; border: 1px solid rgba(255,255,255,0.5); border-radius: 4px; background: white; color: #2d3748; font-size: 14px; cursor: pointer; min-width: 180px;">
                    <option value="revenue-desc">Revenue (High to Low)</option>
                    <option value="revenue-asc">Revenue (Low to High)</option>
                    <option value="name-asc">Account Name (A-Z)</option>
                    <option value="name-desc">Account Name (Z-A)</option>
                </select>
            </div>
        </div>
        <table class="monthly-table" id="account-revenue-table">
            <thead>
                <tr>
                    <th style="width: 40px;"></th>
                    <th>Account</th>
                    <th class="numeric">Total Revenue</th>
                    <th class="numeric">% of Total Budget</th>
                </tr>
            </thead>
            <tbody id="account-revenue-tbody">
                {% if account_revenue_sectors %}
                    {% for sector_data in account_revenue_sectors %}
                    <tr class="sector-header" data-sector="{{ sector_data.sector }}" data-sector-revenue="{{ sector_data.total_revenue }}" data-sector-name="{{ sector_data.sector.lower() }}" style="background: #f7fafc; cursor: pointer; font-weight: 600;">
                        <td class="expand-icon" style="text-align: center; padding: 12px 8px;">
                            <span style="display: inline-block; width: 16px; height: 16px; line-height: 16px; text-align: center; border: 1px solid #4a5568; border-radius: 3px; background: white; color: #4a5568; font-size: 12px;">+</span>
                        </td>
                        <td style="padding: 12px 16px;">
                            {{ sector_data.sector }} 
                            <span style="font-weight: normal; color: #718096; margin-left: 8px;">
                                ({{ sector_data.accounts | length }} account{{ 's' if sector_data.accounts | length != 1 else '' }})
                            </span>
                        </td>
                        <td class="numeric" style="padding: 12px 16px; font-weight: 600;">${{ "{:,.0f}".format(sector_data.total_revenue) }}</td>
                        <td class="numeric" style="padding: 12px 16px; font-weight: 600;">
                            {% if totals.budget > 0 %}
                                {{ "{:.1f}".format((sector_data.total_revenue / totals.budget) * 100) }}%
                            {% else %}
                                0.0%
                            {% endif %}
                        </td>
                    </tr>
                    {% for account in sector_data.accounts %}
                    <tr class="account-row" data-sector="{{ sector_data.sector }}" data-revenue="{{ account.total_revenue }}" data-name="{{ account.customer_name.lower() }}" style="display: none;">
                        <td></td>
                        <td class="month-name" style="padding-left: 32px;">{{ account.customer_name }}</td>
                        <td class="numeric amount-cell">${{ "{:,.0f}".format(account.total_revenue) }}</td>
                        <td class="numeric">
                            {% if totals.budget > 0 %}
                                {{ "{:.1f}".format((account.total_revenue / totals.budget) * 100) }}%
                            {% else %}
                                0.0%
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                    <!-- Account Totals Row -->
                    <tr class="year-totals-row">
                        <td colspan="2"><strong>Total</strong></td>
                        <td class="numeric"><strong>${{ "{:,.0f}".format(total_account_revenue) }}</strong></td>
                        <td class="numeric"><strong>
                            {% if totals.budget > 0 %}
                                {{ "{:.1f}".format((total_account_revenue / totals.budget) * 100) }}%
                            {% else %}
                                0.0%
                            {% endif %}
                        </strong></td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 24px; color: #718096;">
                            No account revenue data available
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <script>
        // Year filter functionality
        document.addEventListener('DOMContentLoaded', function() {
            const yearFilter = document.getElementById('year-filter');
            if (yearFilter) {
                yearFilter.addEventListener('change', function() {
                    const selectedYear = this.value;
                    const url = new URL(window.location);
                    url.searchParams.set('year', selectedYear);
                    window.location.href = url.toString();
                });
            }
            
            // Account revenue date range filter functionality (AJAX with debounce)
            let dateFilterTimeout = null;
            
            function applyAccountDateFilter() {
                const startDate = document.getElementById('account-start-date').value;
                const endDate = document.getElementById('account-end-date').value;
                const tbody = document.getElementById('account-revenue-tbody');
                const container = document.querySelector('.account-revenue-container');
                
                // Save scroll position relative to the container
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const containerTop = container ? container.getBoundingClientRect().top + scrollTop : 0;
                const relativeScroll = scrollTop - containerTop;
                
                // Store expanded state before updating
                const expandedSectors = new Set();
                document.querySelectorAll('.sector-header').forEach(header => {
                    const icon = header.querySelector('.expand-icon span');
                    if (icon && icon.textContent === '−') {
                        expandedSectors.add(header.dataset.sector);
                    }
                });
                
                // Show loading state with fade
                tbody.style.opacity = '0.5';
                tbody.style.transition = 'opacity 0.2s';
                
                // Build query params
                const params = new URLSearchParams();
                if (startDate) params.set('account_start_date', startDate);
                if (endDate) params.set('account_end_date', endDate);
                params.set('ajax', 'account_revenue');
                
                // Get AE name from URL or use current
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('ae')) params.set('ae', urlParams.get('ae'));
                
                // Fetch account revenue data
                fetch(`/reports/ae-dashboard-personal?${params.toString()}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Update account count in header
                    const accountCountElement = document.getElementById('account-count-display');
                    if (accountCountElement && data.total_account_count !== undefined) {
                        accountCountElement.textContent = `${data.total_account_count} account${data.total_account_count !== 1 ? 's' : ''}`;
                    }
                    
                    // Build new table HTML
                    let html = '';
                    const budgetTotal = data.totals.budget || 0;
                    
                    if (data.account_revenue_sectors && data.account_revenue_sectors.length > 0) {
                        data.account_revenue_sectors.forEach(sectorData => {
                            const sector = sectorData.sector;
                            const sectorRevenue = sectorData.total_revenue;
                            const accountCount = sectorData.accounts.length;
                            const isExpanded = expandedSectors.has(sector);
                            
                            html += `
                                <tr class="sector-header" data-sector="${sector}" data-sector-revenue="${sectorRevenue}" data-sector-name="${sector.toLowerCase()}" style="background: #f7fafc; cursor: pointer; font-weight: 600;">
                                    <td class="expand-icon" style="text-align: center; padding: 12px 8px;">
                                        <span style="display: inline-block; width: 16px; height: 16px; line-height: 16px; text-align: center; border: 1px solid #4a5568; border-radius: 3px; background: white; color: #4a5568; font-size: 12px;">${isExpanded ? '−' : '+'}</span>
                                    </td>
                                    <td style="padding: 12px 16px;">
                                        ${sector} 
                                        <span style="font-weight: normal; color: #718096; margin-left: 8px;">
                                            (${accountCount} account${accountCount !== 1 ? 's' : ''})
                                        </span>
                                    </td>
                                    <td class="numeric" style="padding: 12px 16px; font-weight: 600;">$${sectorRevenue.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                                    <td class="numeric" style="padding: 12px 16px; font-weight: 600;">
                                        ${budgetTotal > 0 ? ((sectorRevenue / budgetTotal) * 100).toFixed(1) : '0.0'}%
                                    </td>
                                </tr>
                            `;
                            
                            sectorData.accounts.forEach(account => {
                                html += `
                                    <tr class="account-row" data-sector="${sector}" data-revenue="${account.total_revenue}" data-name="${account.customer_name.toLowerCase()}" style="display: ${isExpanded ? '' : 'none'};">
                                        <td></td>
                                        <td class="month-name" style="padding-left: 32px;">${account.customer_name}</td>
                                        <td class="numeric amount-cell">$${account.total_revenue.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                                        <td class="numeric">
                                            ${budgetTotal > 0 ? ((account.total_revenue / budgetTotal) * 100).toFixed(1) : '0.0'}%
                                        </td>
                                    </tr>
                                `;
                            });
                        });
                        
                        // Add totals row
                        const totalRevenue = data.total_account_revenue || 0;
                        html += `
                            <tr class="year-totals-row">
                                <td colspan="2"><strong>Total</strong></td>
                                <td class="numeric"><strong>$${totalRevenue.toLocaleString('en-US', {maximumFractionDigits: 0})}</strong></td>
                                <td class="numeric"><strong>
                                    ${budgetTotal > 0 ? ((totalRevenue / budgetTotal) * 100).toFixed(1) : '0.0'}%
                                </strong></td>
                            </tr>
                        `;
                    } else {
                        html = '<tr><td colspan="4" style="text-align: center; padding: 24px; color: #718096;">No account revenue data available</td></tr>';
                    }
                    
                    // Update content
                    tbody.innerHTML = html;
                    
                    // Restore scroll position
                    requestAnimationFrame(() => {
                        if (container) {
                            const newContainerTop = container.getBoundingClientRect().top + (window.pageYOffset || document.documentElement.scrollTop);
                            window.scrollTo({
                                top: newContainerTop + relativeScroll,
                                behavior: 'instant'
                            });
                        }
                        
                        // Fade back in
                        tbody.style.opacity = '1';
                    });
                    
                    // Re-attach event listeners (expand/collapse only, sorting listeners persist)
                    attachSectorExpandListeners();
                })
                .catch(error => {
                    console.error('Error loading account revenue:', error);
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 24px; color: #d32f2f;">Error loading data. Please try again.</td></tr>';
                    tbody.style.opacity = '1';
                });
            }
            
            // Helper function to attach expand/collapse listeners
            function attachSectorExpandListeners() {
                const sectorHeaders = document.querySelectorAll('.sector-header');
                sectorHeaders.forEach(header => {
                    // Check if listener already attached
                    if (header.dataset.listenerAttached === 'true') return;
                    header.dataset.listenerAttached = 'true';
                    
                    header.addEventListener('click', function() {
                        const sector = this.dataset.sector;
                        const accountRows = document.querySelectorAll(`.account-row[data-sector="${sector}"]`);
                        const icon = this.querySelector('.expand-icon span');
                        const isExpanded = icon.textContent === '−';
                        
                        accountRows.forEach(row => {
                            row.style.display = isExpanded ? 'none' : '';
                        });
                        
                        icon.textContent = isExpanded ? '+' : '−';
                    });
                });
            }
            
            // Debounced date filter change handler
            function handleDateFilterChange() {
                // Clear existing timeout
                if (dateFilterTimeout) {
                    clearTimeout(dateFilterTimeout);
                }
                
                // Set new timeout (500ms delay)
                dateFilterTimeout = setTimeout(() => {
                    applyAccountDateFilter();
                }, 500);
            }
            
            // Apply filter on date input change (with debounce)
            const accountStartDate = document.getElementById('account-start-date');
            const accountEndDate = document.getElementById('account-end-date');
            if (accountStartDate) {
                accountStartDate.addEventListener('change', handleDateFilterChange);
                accountStartDate.addEventListener('input', handleDateFilterChange);
            }
            if (accountEndDate) {
                accountEndDate.addEventListener('change', handleDateFilterChange);
                accountEndDate.addEventListener('input', handleDateFilterChange);
            }
            
            // Reset to full year button
            const accountDateReset = document.getElementById('account-date-reset');
            if (accountDateReset) {
                accountDateReset.addEventListener('click', function() {
                    document.getElementById('account-start-date').value = '';
                    document.getElementById('account-end-date').value = '';
                    // Apply immediately (no debounce for reset)
                    applyAccountDateFilter();
                });
            }
            
            // Helper function to attach sorting listeners
            function attachSortingListeners() {
                // Sector sorting functionality
                const sectorSortSelect = document.getElementById('sector-sort');
                if (sectorSortSelect && !sectorSortSelect.dataset.listenerAttached) {
                    sectorSortSelect.dataset.listenerAttached = 'true';
                    sectorSortSelect.addEventListener('change', function() {
                        const sortValue = this.value;
                    const tbody = document.querySelector('#account-revenue-table tbody');
                    const sectorHeaders = Array.from(document.querySelectorAll('.sector-header'));
                    const totalRow = document.querySelector('.year-totals-row');
                    
                    // Store expanded state before sorting
                    const expandedSectors = new Set();
                    sectorHeaders.forEach(header => {
                        const icon = header.querySelector('.expand-icon span');
                        if (icon && icon.textContent === '−') {
                            expandedSectors.add(header.dataset.sector);
                        }
                    });
                    
                    sectorHeaders.sort((a, b) => {
                        if (sortValue === 'name-asc') {
                            return a.dataset.sectorName.localeCompare(b.dataset.sectorName);
                        } else if (sortValue === 'name-desc') {
                            return b.dataset.sectorName.localeCompare(a.dataset.sectorName);
                        } else if (sortValue === 'revenue-desc') {
                            return parseFloat(b.dataset.sectorRevenue) - parseFloat(a.dataset.sectorRevenue);
                        } else if (sortValue === 'revenue-asc') {
                            return parseFloat(a.dataset.sectorRevenue) - parseFloat(b.dataset.sectorRevenue);
                        }
                        return 0;
                    });
                    
                    // Collect all account rows by sector before removing
                    const allAccountRows = {};
                    sectorHeaders.forEach(sectorHeader => {
                        const sector = sectorHeader.dataset.sector;
                        allAccountRows[sector] = Array.from(document.querySelectorAll(`.account-row[data-sector="${sector}"]`));
                    });
                    
                    // Remove all sector headers and account rows from DOM
                    sectorHeaders.forEach(header => header.remove());
                    Object.values(allAccountRows).flat().forEach(row => row.remove());
                    
                    // Re-insert sorted sector headers with their account rows
                    sectorHeaders.forEach(sectorHeader => {
                        const sector = sectorHeader.dataset.sector;
                        const accountRows = allAccountRows[sector];
                        
                        // Insert sector header
                        tbody.insertBefore(sectorHeader, totalRow);
                        
                        // Insert account rows after sector header
                        accountRows.forEach(row => {
                            tbody.insertBefore(row, totalRow);
                        });
                        
                        // Restore expanded state
                        if (expandedSectors.has(sector)) {
                            const icon = sectorHeader.querySelector('.expand-icon span');
                            if (icon) {
                                icon.textContent = '−';
                                accountRows.forEach(row => {
                                    row.style.display = '';
                                });
                            }
                        }
                    });
                    });
                }
                
                // Account sorting functionality
                const accountSortSelect = document.getElementById('account-sort');
                if (accountSortSelect && !accountSortSelect.dataset.listenerAttached) {
                    accountSortSelect.dataset.listenerAttached = 'true';
                    accountSortSelect.addEventListener('change', function() {
                        const sortValue = this.value;
                    const sectors = document.querySelectorAll('.sector-header');
                    
                    sectors.forEach(sectorHeader => {
                        const sector = sectorHeader.dataset.sector;
                        const accountRows = Array.from(document.querySelectorAll(`.account-row[data-sector="${sector}"]`));
                        
                        // Check if sector is expanded by checking the icon
                        const icon = sectorHeader.querySelector('.expand-icon span');
                        const isSectorExpanded = icon && icon.textContent === '−';
                        
                        accountRows.sort((a, b) => {
                            if (sortValue === 'revenue-desc') {
                                return parseFloat(b.dataset.revenue) - parseFloat(a.dataset.revenue);
                            } else if (sortValue === 'revenue-asc') {
                                return parseFloat(a.dataset.revenue) - parseFloat(b.dataset.revenue);
                            } else if (sortValue === 'name-asc') {
                                return a.dataset.name.localeCompare(b.dataset.name);
                            } else if (sortValue === 'name-desc') {
                                return b.dataset.name.localeCompare(a.dataset.name);
                            }
                            return 0;
                        });
                        
                        // Remove all account rows for this sector
                        accountRows.forEach(row => row.remove());
                        
                        // Re-insert sorted rows with preserved display state
                        const tbody = sectorHeader.parentElement;
                        const nextSector = sectorHeader.nextElementSibling;
                        const insertBefore = (nextSector && nextSector.classList.contains('sector-header')) 
                            ? nextSector 
                            : document.querySelector('.year-totals-row');
                        
                        accountRows.forEach(row => {
                            // Restore display state based on whether sector is expanded
                            row.style.display = isSectorExpanded ? '' : 'none';
                            tbody.insertBefore(row, insertBefore);
                        });
                    });
                    });
                }
            }
            
            // Initial attachment of all listeners
            attachSectorExpandListeners();
            attachSortingListeners();
        });
    </script>
</div>
{% endblock %}
