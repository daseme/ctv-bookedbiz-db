{% extends "base.html" %}

{% block title %}Address Book - SpotOps{% endblock %}
{% block header_title %}Address Book{% endblock %}
{% block header_subtitle %}Unified directory of agencies and advertisers with contacts{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">‚Ä∫</span>
<span>Data Management</span>
<span class="breadcrumb-separator">‚Ä∫</span>
<span class="breadcrumb-current">Address Book</span>
{% endblock %}

{% block extra_styles %}
<style>
  .stats-row{display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap}
  .stat{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:14px 18px;min-width:120px}
  .stat .val{font-size:24px;font-weight:700}
  .stat .lbl{font-size:12px;color:#64748b;margin-top:2px}
  .stat.agencies{border-left:4px solid #0ea5e9}
  .stat.customers{border-left:4px solid #8b5cf6}
  .stat.warn{border-left:4px solid #f59e0b}

  .filter-bar{display:flex;gap:12px;margin-bottom:16px;align-items:center;flex-wrap:wrap}
  .filter-bar input,.filter-bar select{padding:8px 12px;border:1px solid #cbd5e1;border-radius:6px;font-size:14px}
  .filter-bar input[type="text"]{width:280px}
  .filter-bar button{padding:8px 16px;border-radius:6px;cursor:pointer;border:1px solid #e2e8f0;background:#fff}
  .filter-bar button:hover{background:#f8fafc}
  .filter-bar button#export-csv{background:#059669;color:#fff;border-color:#047857}
  .filter-bar button#export-csv:hover{background:#047857}
  .filter-bar button#save-filter{background:#0ea5e9;color:#fff;border-color:#0284c7}
  .filter-bar button#save-filter:hover{background:#0284c7}
  .filter-bar .count{margin-left:auto;font-size:13px;color:#64748b}

  .entity-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(380px, 1fr));gap:16px}

  .entity-card{background:#fff;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;transition:box-shadow 0.15s;cursor:pointer}
  .entity-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);border-color:#cbd5e1}
  .entity-card.agency{border-top:3px solid #0ea5e9}
  .entity-card.customer{border-top:3px solid #8b5cf6}

  .card-header{padding:14px 16px;display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
  .entity-name{font-weight:600;font-size:15px;color:#0f172a;margin:0}
  .header-badges{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .entity-type{font-size:11px;padding:2px 8px;border-radius:10px;font-weight:500}
  .entity-type.agency{background:#e0f2fe;color:#0369a1}
  .entity-type.customer{background:#ede9fe;color:#6d28d9}
  .sector-badge{font-size:11px;padding:2px 8px;border-radius:10px;font-weight:500;background:#fef3c7;color:#92400e}
  .sector-badge.none{background:#f1f5f9;color:#64748b}
  .market-badges{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
  .market-chip{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:500;background:#dcfce7;color:#166534}
  .market-chip.more{background:#f1f5f9;color:#64748b}

  .metrics-row{display:flex;gap:16px;margin-top:8px;font-size:12px;color:#64748b}
  .metric{display:flex;align-items:center;gap:4px}
  .metric .value{font-weight:600;color:#334155}
  .metric.revenue .value{color:#059669}
  .metric.inactive{opacity:0.5}

  .card-body{padding:0 16px 14px}
  .address-line{font-size:13px;color:#475569;margin-bottom:6px;display:flex;align-items:flex-start;gap:8px}
  .address-line .icon{color:#94a3b8;flex-shrink:0}
  .no-data{font-size:13px;color:#94a3b8;font-style:italic}
  .notes-preview{font-size:12px;color:#64748b;margin-bottom:6px;max-height:36px;overflow:hidden}
  .contacts-summary{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .contact-chip{display:flex;align-items:center;gap:4px;padding:4px 8px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;font-size:11px}
  .contact-chip .name{font-weight:500;color:#334155}
  .contact-chip.primary{background:#fef3c7;border-color:#fcd34d}

  .empty{text-align:center;padding:60px 20px;color:#64748b}
  .empty h3{margin:0 0 8px;color:#334155}

  /* Detail Modal - larger */
  .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:flex-start;justify-content:center;padding:40px 20px;overflow-y:auto}
  .modal-overlay.active{display:flex}
  .detail-modal{background:#fff;border-radius:12px;width:100%;max-width:700px;box-shadow:0 20px 40px rgba(0,0,0,0.25)}
  .detail-modal .modal-header{padding:20px 24px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
  .detail-modal .modal-header h2{margin:0;font-size:20px;display:flex;align-items:center;gap:12px}
  .detail-modal .modal-header .type-badge{font-size:12px;padding:4px 10px;border-radius:12px;font-weight:500}
  .detail-modal .modal-header .type-badge.agency{background:#e0f2fe;color:#0369a1}
  .detail-modal .modal-header .type-badge.customer{background:#ede9fe;color:#6d28d9}
  .modal-close{background:none;border:none;font-size:24px;color:#94a3b8;cursor:pointer;padding:4px 8px}
  .modal-close:hover{color:#334155}
  .detail-modal .modal-body{padding:24px}

  .detail-section{margin-bottom:24px}
  .detail-section:last-child{margin-bottom:0}
  .detail-section h3{font-size:14px;font-weight:600;color:#334155;margin:0 0 12px;display:flex;align-items:center;gap:8px}
  .detail-section h3 .icon{font-size:16px}

  .address-form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .address-form .full-width{grid-column:1/-1}
  .form-field label{display:block;font-size:11px;color:#64748b;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
  .form-field input,.form-field select,.form-field textarea{width:100%;padding:10px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px}
  .form-field input:focus,.form-field select:focus,.form-field textarea:focus{border-color:#0ea5e9;outline:none}
  .form-field textarea{resize:vertical;min-height:80px}

  .sector-row{display:flex;gap:12px;align-items:flex-end}
  .sector-row .form-field{flex:1}

  .contacts-list{display:flex;flex-direction:column;gap:10px}
  .contact-card{display:flex;align-items:flex-start;gap:12px;padding:12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px}
  .contact-card.primary{background:#fefce8;border-color:#fde047}
  .contact-card .contact-info{flex:1}
  .contact-card .contact-name{font-weight:600;font-size:14px;color:#0f172a;display:flex;align-items:center;gap:8px}
  .contact-card .primary-badge{font-size:10px;padding:2px 6px;background:#fde047;color:#854d0e;border-radius:4px;font-weight:600}
  .contact-card .contact-title{font-size:12px;color:#64748b;margin-top:2px}
  .contact-card .contact-details{font-size:13px;color:#475569;margin-top:6px;display:flex;gap:16px;flex-wrap:wrap}
  .contact-card .contact-actions{display:flex;gap:4px}
  .contact-card .contact-actions button{background:none;border:none;color:#94a3b8;cursor:pointer;padding:4px 6px;font-size:12px;border-radius:4px}
  .contact-card .contact-actions button:hover{background:#e2e8f0;color:#334155}
  .contact-card .contact-actions button.delete:hover{background:#fee2e2;color:#dc2626}
  .contact-card .contact-actions button.edit:hover{background:#dbeafe;color:#2563eb}

  .contact-edit-form{padding:12px;background:#f0f9ff;border:1px solid #0ea5e9;border-radius:8px}
  .contact-edit-form .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
  .contact-edit-form .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .contact-edit-form .btn{padding:8px 16px;border-radius:6px;font-size:13px;cursor:pointer}
  .contact-edit-form .btn-cancel{background:#fff;border:1px solid #e2e8f0;color:#64748b}
  .contact-edit-form .btn-save{background:#0ea5e9;border:1px solid #0284c7;color:#fff}
  .contact-edit-form .btn-save:hover{background:#0284c7}
  .address-edit-form{padding:12px;background:#f0fdf4;border:1px solid #22c55e;border-radius:8px}
  .address-edit-form .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
  .address-edit-form .form-field label{display:block;font-size:11px;color:#64748b;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
  .address-edit-form .form-field input,.address-edit-form .form-field select,.address-edit-form .form-field textarea{width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px;box-sizing:border-box}
  .address-edit-form .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .address-edit-form .btn{padding:8px 16px;border-radius:6px;font-size:13px;cursor:pointer}
  .address-edit-form .btn-cancel{background:#fff;border:1px solid #e2e8f0;color:#64748b}
  .address-edit-form .btn-save{background:#22c55e;border:1px solid #16a34a;color:#fff}
  .address-edit-form .btn-save:hover{background:#16a34a}

  .role-badge{font-size:10px;padding:2px 6px;background:#e0e7ff;color:#4338ca;border-radius:4px;font-weight:500}

  .add-contact-btn{padding:10px 16px;background:#fff;border:2px dashed #cbd5e1;border-radius:8px;color:#64748b;cursor:pointer;font-size:13px;width:100%;text-align:center}
  .add-contact-btn:hover{border-color:#0ea5e9;color:#0ea5e9;background:#f0f9ff}

  .add-contact-form{display:none;padding:16px;background:#f0f9ff;border:1px solid #0ea5e9;border-radius:8px;margin-top:10px}
  .add-contact-form.active{display:block}
  .add-contact-form .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
  .add-contact-form .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .add-contact-form .btn{padding:8px 16px;border-radius:6px;font-size:13px;cursor:pointer}
  .add-contact-form .btn-cancel{background:#fff;border:1px solid #e2e8f0;color:#64748b}
  .add-contact-form .btn-save{background:#0ea5e9;border:1px solid #0284c7;color:#fff}
  .add-contact-form .btn-save:hover{background:#0284c7}

  .save-bar{padding:16px 24px;background:#f8fafc;border-top:1px solid #e2e8f0;display:flex;justify-content:flex-end;gap:12px}
  .save-bar .btn{padding:10px 20px;border-radius:6px;font-size:14px;cursor:pointer}
  .save-bar .btn-close{background:#fff;border:1px solid #e2e8f0;color:#475569}
  .save-bar .btn-save{background:#0ea5e9;border:1px solid #0284c7;color:#fff}
  .save-bar .btn-save:hover{background:#0284c7}
  .save-bar .btn-save:disabled{background:#94a3b8;border-color:#94a3b8;cursor:not-allowed}
  .save-bar .btn-deactivate{background:#fff;border:1px solid #ef4444;color:#ef4444;margin-right:auto}
  .save-bar .btn-deactivate:hover{background:#fef2f2}
  .save-status{font-size:13px;color:#64748b;display:flex;align-items:center;margin-right:auto}
  .save-status.success{color:#16a34a}
  .save-status.error{color:#dc2626}

  /* View Toggle */
  .view-toggle{display:flex;border:1px solid #e2e8f0;border-radius:6px;overflow:hidden}
  .view-toggle button{padding:6px 12px;border:none;background:#fff;color:#64748b;cursor:pointer;font-size:13px}
  .view-toggle button.active{background:#0ea5e9;color:#fff}
  .view-toggle button:hover:not(.active){background:#f1f5f9}

  /* Table View */
  .entity-table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;display:none}
  .entity-table.active{display:table}
  .entity-grid.hidden{display:none}
  .entity-table th,.entity-table td{padding:10px 12px;text-align:left;border-bottom:1px solid #e2e8f0}
  .entity-table th{background:#f8fafc;font-size:12px;font-weight:600;color:#475569;text-transform:uppercase}
  .entity-table td{font-size:13px}
  .entity-table tr:hover{background:#f8fafc}
  .entity-table tr.selected{background:#e0f2fe}
  .entity-table .name-cell{font-weight:500;color:#0f172a;cursor:pointer}
  .entity-table .name-cell:hover{color:#0ea5e9}
  .entity-table .checkbox-cell{width:40px}
  .entity-table .type-cell{width:80px}
  .entity-table .revenue-cell{text-align:right;font-weight:500;color:#059669}

  /* Bulk Toolbar */
  .bulk-toolbar{display:none;align-items:center;gap:12px;padding:12px 16px;background:#e0f2fe;border-radius:8px;margin-bottom:16px}
  .bulk-toolbar.active{display:flex}
  .bulk-toolbar .count{font-weight:600;color:#0369a1}
  .bulk-toolbar button{padding:6px 12px;border:1px solid #0284c7;border-radius:6px;background:#fff;color:#0284c7;cursor:pointer;font-size:13px}
  .bulk-toolbar button:hover{background:#0ea5e9;color:#fff}
  .bulk-toolbar .clear-selection{background:transparent;border:none;color:#64748b;text-decoration:underline}

  /* Activity Log */
  .activity-timeline{max-height:300px;overflow-y:auto;margin-top:12px}
  .activity-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid #f1f5f9}
  .activity-item:last-child{border-bottom:none}
  .activity-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px}
  .activity-icon.note{background:#e0e7ff;color:#4338ca}
  .activity-icon.call{background:#dcfce7;color:#16a34a}
  .activity-icon.email{background:#fef3c7;color:#ca8a04}
  .activity-icon.meeting{background:#ede9fe;color:#7c3aed}
  .activity-icon.status_change{background:#fee2e2;color:#dc2626}
  .activity-content{flex:1;min-width:0}
  .activity-header{font-size:12px;color:#64748b;display:flex;gap:8px;align-items:center}
  .activity-type{font-weight:600;text-transform:capitalize}
  .activity-desc{font-size:13px;color:#334155;margin-top:4px}
  .add-activity-form{margin-top:12px;padding:12px;background:#f8fafc;border-radius:8px;display:none}
  .add-activity-form.active{display:block}
  .add-activity-form select,.add-activity-form textarea{width:100%;margin-bottom:8px;padding:8px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px}
  .add-activity-form textarea{min-height:60px}

  .ae-badge{font-size:11px;padding:2px 8px;border-radius:10px;font-weight:500;background:#dbeafe;color:#1e40af}
  .ae-badge.none{background:#f1f5f9;color:#94a3b8}

  /* AE History Timeline */
  .ae-history-timeline{max-height:200px;overflow-y:auto;margin-top:10px}
  .ae-history-item{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid #f1f5f9;font-size:13px}
  .ae-history-item:last-child{border-bottom:none}
  .ae-history-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:4px}
  .ae-history-dot.active{background:#16a34a}
  .ae-history-dot.ended{background:#cbd5e1}
  .ae-history-info{flex:1;min-width:0}
  .ae-history-name{font-weight:600;color:#334155}
  .ae-history-dates{font-size:11px;color:#64748b;margin-top:2px}
  .ae-history-source{font-size:10px;color:#94a3b8;margin-top:1px}

  .sub-customers-table{width:100%;border-collapse:collapse;font-size:13px}
  .sub-customers-table th,.sub-customers-table td{padding:6px 10px;text-align:left;border-bottom:1px solid #f1f5f9}
  .sub-customers-table th{font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase}
  .sub-customers-table .revenue{text-align:right;color:#059669;font-weight:500}
  .sub-customers-table .spots{text-align:right;color:#64748b}
  .sub-customers-table .po-input{width:100px;padding:4px 6px;border:1px solid #e2e8f0;border-radius:4px;font-size:12px}
  .sub-customers-table .po-input:focus{border-color:#0ea5e9;outline:none}
  .sub-customers-table .po-saved{color:#16a34a;font-size:11px;margin-left:4px;opacity:0;transition:opacity 0.3s}
  .sub-customers-table .po-saved.show{opacity:1}
  .sub-customers-scroll{max-height:250px;overflow-y:auto}

  .toggle-label{display:flex;align-items:center;gap:6px;font-size:13px;color:#475569;cursor:pointer}
  .toggle-label input{cursor:pointer}
  .badge-inactive{display:inline-block;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:500;background:#f1f5f9;color:#64748b;margin-left:6px}
  .count.loading{color:#0ea5e9}
  /* Billing Info */
  .billing-row{display:flex;gap:16px;align-items:flex-end}
  .billing-row .form-field{flex:1}
  .edi-toggle{display:flex;align-items:center;gap:8px;padding-bottom:10px}
  .edi-toggle label{font-size:13px;color:#475569;cursor:pointer}

  /* Additional Addresses */
  .address-card{display:flex;align-items:flex-start;gap:12px;padding:12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px}
  .address-card.primary{background:#fefce8;border-color:#fde047}
  .address-card .address-info{flex:1}
  .address-card .address-label-badge{font-size:10px;padding:2px 6px;background:#e0e7ff;color:#4338ca;border-radius:4px;font-weight:600}
  .address-card .address-label-badge.primary{background:#fde047;color:#854d0e}
  .address-card .address-text{font-size:13px;color:#334155;margin-top:4px}
  .address-card .address-notes{font-size:12px;color:#64748b;margin-top:2px;font-style:italic}
  .address-card .address-actions{display:flex;gap:4px}
  .address-card .address-actions button{background:none;border:none;color:#94a3b8;cursor:pointer;padding:4px 6px;font-size:12px;border-radius:4px}
  .address-card .address-actions button:hover{background:#e2e8f0;color:#334155}
  .address-card .address-actions button.delete:hover{background:#fee2e2;color:#dc2626}
  .addresses-list{display:flex;flex-direction:column;gap:10px}

  .add-address-form{display:none;padding:16px;background:#f0f9ff;border:1px solid #0ea5e9;border-radius:8px;margin-top:10px}
  .add-address-form.active{display:block}
  .add-address-form .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
  .add-address-form .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  .count.loading{animation:pulse 1s ease-in-out infinite}

  /* Create Entity Modal */
  .create-modal{background:#fff;border-radius:12px;width:100%;max-width:600px;box-shadow:0 20px 40px rgba(0,0,0,0.25);max-height:90vh;display:flex;flex-direction:column}
  .create-modal .modal-header{padding:20px 24px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
  .create-modal .modal-header h2{margin:0;font-size:20px}
  .create-modal .modal-body{padding:24px;display:flex;flex-direction:column;gap:16px;overflow-y:auto}
  .create-modal .type-selector{display:flex;gap:8px}
  .create-modal .type-btn{flex:1;padding:10px;border:2px solid #e2e8f0;border-radius:8px;background:#fff;cursor:pointer;font-size:14px;font-weight:500;text-align:center;transition:all 0.15s}
  .create-modal .type-btn:hover{border-color:#cbd5e1}
  .create-modal .type-btn.active.agency{border-color:#0ea5e9;background:#e0f2fe;color:#0369a1}
  .create-modal .type-btn.active.customer{border-color:#8b5cf6;background:#ede9fe;color:#6d28d9}
  .create-modal .section-label{font-size:12px;font-weight:600;color:#475569;text-transform:uppercase;letter-spacing:0.5px;padding-bottom:4px;border-bottom:1px solid #f1f5f9;margin-bottom:-4px}
  .create-modal .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .create-modal .error-msg{padding:10px 12px;background:#fef2f2;border:1px solid #fecaca;border-radius:6px;color:#dc2626;font-size:13px;display:none}
  .create-modal .error-msg.active{display:block}
  .create-modal .error-msg a{color:#0ea5e9;cursor:pointer;text-decoration:underline}
  .create-modal .form-actions{display:flex;gap:8px;justify-content:flex-end;padding-top:8px;flex-shrink:0}
  .create-modal .btn{padding:10px 20px;border-radius:6px;font-size:14px;cursor:pointer}
  .create-modal .btn-cancel{background:#fff;border:1px solid #e2e8f0;color:#475569}
  .create-modal .btn-create{background:#059669;border:1px solid #047857;color:#fff}
  .create-modal .btn-create:hover{background:#047857}
  .create-modal .btn-create:disabled{background:#94a3b8;border-color:#94a3b8;cursor:not-allowed}
  .create-modal .affidavit-toggle{display:flex;align-items:center;gap:8px;padding-top:6px}
  .create-modal .affidavit-toggle label{font-size:13px;color:#475569;cursor:pointer}
  .filter-bar button#add-new{background:#059669;color:#fff;border-color:#047857}
  .filter-bar button#add-new:hover{background:#047857}
</style>
{% endblock %}

{% block content %}
<div class="stats-row" id="stats">
  <div class="stat agencies"><div class="val">-</div><div class="lbl">Agencies</div></div>
  <div class="stat customers"><div class="val">-</div><div class="lbl">Advertisers</div></div>
  <div class="stat"><div class="val">-</div><div class="lbl">With Contacts</div></div>
  <div class="stat warn"><div class="val">-</div><div class="lbl">Missing Contacts</div></div>
</div>

<div class="filter-bar">
  <input type="text" id="search" placeholder="Search name, contacts, notes...">
  <select id="type-filter">
    <option value="all">All Types</option>
    <option value="agency">Agencies Only</option>
    <option value="customer">Advertisers Only</option>
  </select>
  <select id="market-filter">
    <option value="">All Markets</option>
  </select>
  <select id="sector-filter">
    <option value="">All Sectors</option>
  </select>
  <select id="ae-filter">
    <option value="">All AEs</option>
    <option value="__none__">Unassigned</option>
  </select>
  <select id="contacts-filter">
    <option value="all">All Contact Status</option>
    <option value="yes">Has Contacts</option>
    <option value="no">Missing Contacts</option>
  </select>
  <select id="sort-filter">
    <option value="name">Sort by Name</option>
    <option value="last_active">Sort by Last Active</option>
    <option value="revenue">Sort by Revenue</option>
    <option value="market">Sort by Market</option>
    <option value="sector">Sort by Sector</option>
    <option value="type">Sort by Type</option>
    <option value="ae">Sort by AE</option>
  </select>
  <select id="saved-filter">
    <option value="">Saved Filters...</option>
  </select>
  <label class="toggle-label">
    <input type="checkbox" id="inactive-filter"> Show Deactivated
  </label>
  <button id="save-filter" title="Save current filter">Save</button>
  <button id="export-csv" title="Export to CSV">Export</button>
  <button id="add-new" title="Add New Agency or Advertiser">+ Add New</button>
  <button id="refresh">Refresh</button>
  <div class="view-toggle">
    <button id="view-cards" class="active" title="Card View">Cards</button>
    <button id="view-table" title="Table View">Table</button>
  </div>
  <span class="count" id="count"></span>
</div>

<!-- Bulk Toolbar -->
<div class="bulk-toolbar" id="bulk-toolbar">
  <span class="count"><span id="selected-count">0</span> selected</span>
  <button id="bulk-export">Export Selected</button>
  <button id="bulk-set-sector">Set Sector</button>
  <button class="clear-selection" id="clear-selection">Clear Selection</button>
</div>

<div class="entity-grid" id="grid">
  <div class="empty">Loading...</div>
</div>

<!-- Table View -->
<table class="entity-table" id="table">
  <thead>
    <tr>
      <th class="checkbox-cell"><input type="checkbox" id="select-all"></th>
      <th>Name</th>
      <th class="type-cell">Type</th>
      <th>Sector</th>
      <th>AE</th>
      <th>Primary Contact</th>
      <th>Last Active</th>
      <th class="revenue-cell">Revenue</th>
    </tr>
  </thead>
  <tbody id="table-body"></tbody>
</table>

<!-- Detail Modal -->
<div class="modal-overlay" id="detail-modal">
  <div class="detail-modal">
    <div class="modal-header">
      <h2><span id="detail-name"></span> <span class="type-badge" id="detail-type-badge"></span> <a id="detail-page-link" href="#" target="_blank" title="Open detail page" style="font-size:14px;color:#0ea5e9;text-decoration:none;display:none">‚Üó</a></h2>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Sector (advertisers only) -->
      <div class="detail-section" id="sector-section" style="display:none">
        <h3><span class="icon">üè∑Ô∏è</span> Sector</h3>
        <div class="sector-row">
          <div class="form-field">
            <select id="detail-sector"></select>
          </div>
        </div>
      </div>

      <!-- Agency (advertisers only) -->
      <div class="detail-section" id="agency-section" style="display:none">
        <h3><span class="icon">üè¢</span> Agency</h3>
        <div class="form-field">
          <select id="detail-agency">
            <option value="">-- No Agency (Direct) --</option>
          </select>
        </div>
      </div>

      <!-- AE Assignment -->
      <div class="detail-section">
        <h3><span class="icon">üëî</span> Assigned AE</h3>
        <div class="form-field">
          <select id="detail-ae">
            <option value="">-- No AE Assigned --</option>
          </select>
        </div>
        <div class="ae-history-timeline" id="detail-ae-history">
          <div class="no-data">No assignment history</div>
        </div>
      </div>

      <!-- EDI Billing (agencies only) -->
      <div class="detail-section" id="edi-section" style="display:none">
        <h3><span class="icon">üí∞</span> Billing</h3>
        <div class="edi-toggle">
          <input type="checkbox" id="detail-edi-billing">
          <label for="detail-edi-billing">EDI Billing</label>
        </div>
      </div>

      <!-- PO Number + Affidavit (advertisers only) -->
      <div class="detail-section" id="po-section" style="display:none">
        <h3><span class="icon">üí∞</span> Billing</h3>
        <div class="billing-row">
          <div class="form-field" style="max-width:300px">
            <label>PO Number</label>
            <input type="text" id="detail-po-number" placeholder="Purchase order number">
          </div>
          <div class="edi-toggle">
            <input type="checkbox" id="detail-affidavit-required">
            <label for="detail-affidavit-required">Affidavit Required</label>
          </div>
        </div>
      </div>

      <!-- Markets -->
      <div class="detail-section" id="markets-section">
        <h3><span class="icon">üì∫</span> Markets</h3>
        <div class="market-badges" id="detail-markets" style="font-size:12px">
          <span class="no-data">No spots in any market</span>
        </div>
      </div>

      <!-- Agency Clients (agencies only) -->
      <div class="detail-section" id="agency-clients-section" style="display:none">
        <h3><span class="icon">üè¢</span> Agency Clients <span id="agency-clients-count" style="font-weight:400;color:#64748b;font-size:12px"></span></h3>
        <div class="sub-customers-scroll">
          <table class="sub-customers-table">
            <thead><tr><th>Client</th><th>Sector</th><th>PO Number</th><th class="spots">Spots</th><th class="revenue">Revenue</th></tr></thead>
            <tbody id="agency-clients-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Address -->
      <div class="detail-section">
        <h3><span class="icon">üìç</span> Address</h3>
        <div class="address-form">
          <div class="form-field full-width">
            <label>Street Address</label>
            <input type="text" id="detail-address" placeholder="123 Main St">
          </div>
          <div class="form-field">
            <label>City</label>
            <input type="text" id="detail-city" placeholder="City">
          </div>
          <div class="form-field">
            <label>State</label>
            <input type="text" id="detail-state" placeholder="CA" maxlength="2" style="width:80px">
          </div>
          <div class="form-field">
            <label>ZIP</label>
            <input type="text" id="detail-zip" placeholder="12345" maxlength="10" style="width:100px">
          </div>
        </div>
      </div>

      <!-- Additional Addresses -->
      <div class="detail-section">
        <h3><span class="icon">üì¨</span> Additional Addresses</h3>
        <div class="addresses-list" id="detail-addresses"></div>
        <button class="add-contact-btn" id="show-add-address">+ Add Additional Address</button>
        <div class="add-address-form" id="add-address-form">
          <div class="form-row">
            <div class="form-field">
              <label>Label *</label>
              <select id="new-address-label">
                <option value="">-- Select Label --</option>
                <option value="Billing">Billing</option>
                <option value="Shipping">Shipping</option>
                <option value="PO Box">PO Box</option>
                <option value="Office">Office</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-field" style="display:flex;align-items:flex-end;padding-bottom:10px">
              <div style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" id="new-address-primary">
                <label for="new-address-primary" style="font-size:13px;color:#475569">Primary address</label>
              </div>
            </div>
          </div>
          <div class="form-row" style="grid-template-columns:1fr">
            <div class="form-field">
              <label>Street Address</label>
              <input type="text" id="new-address-street" placeholder="123 Main St">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>City</label>
              <input type="text" id="new-address-city" placeholder="City">
            </div>
            <div class="form-field">
              <label>State</label>
              <input type="text" id="new-address-state" placeholder="CA" maxlength="2" style="width:80px">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>ZIP</label>
              <input type="text" id="new-address-zip" placeholder="12345" maxlength="10" style="width:100px">
            </div>
            <div class="form-field">
              <label>Notes</label>
              <input type="text" id="new-address-notes" placeholder="Optional notes">
            </div>
          </div>
          <div class="form-actions">
            <button class="btn btn-cancel" id="cancel-add-address">Cancel</button>
            <button class="btn btn-save" id="save-new-address">Add Address</button>
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="detail-section">
        <h3><span class="icon">üìù</span> Notes</h3>
        <div class="form-field">
          <textarea id="detail-notes" placeholder="Add notes about this entity..."></textarea>
        </div>
      </div>

      <!-- Contacts -->
      <div class="detail-section">
        <h3><span class="icon">üë§</span> Contacts</h3>
        <div class="contacts-list" id="detail-contacts"></div>
        <button class="add-contact-btn" id="show-add-contact">+ Add New Contact</button>
        <div class="add-contact-form" id="add-contact-form">
          <div class="form-row">
            <div class="form-field">
              <label>Name *</label>
              <input type="text" id="new-contact-name" placeholder="Full name">
            </div>
            <div class="form-field">
              <label>Title</label>
              <input type="text" id="new-contact-title" placeholder="Job title">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Email</label>
              <input type="email" id="new-contact-email" placeholder="email@example.com">
            </div>
            <div class="form-field">
              <label>Phone</label>
              <input type="text" id="new-contact-phone" placeholder="(555) 123-4567">
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <label>Role</label>
              <select id="new-contact-role">
                <option value="">-- Select Role --</option>
                <option value="decision_maker">Decision Maker</option>
                <option value="account_manager">Account Manager</option>
                <option value="billing">Billing</option>
                <option value="technical">Technical</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-field" style="display:flex;align-items:flex-end;padding-bottom:10px">
              <div style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" id="new-contact-primary">
                <label for="new-contact-primary" style="font-size:13px;color:#475569">Primary contact</label>
              </div>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn btn-cancel" id="cancel-add-contact">Cancel</button>
            <button class="btn btn-save" id="save-new-contact">Add Contact</button>
          </div>
        </div>
      </div>

      <!-- Activity Log -->
      <div class="detail-section">
        <h3><span class="icon">üìã</span> Activity Log</h3>
        <button class="add-contact-btn" id="show-add-activity">+ Add Note or Activity</button>
        <div class="add-activity-form" id="add-activity-form">
          <select id="new-activity-type">
            <option value="note">Note</option>
            <option value="call">Call</option>
            <option value="email">Email</option>
            <option value="meeting">Meeting</option>
          </select>
          <textarea id="new-activity-desc" placeholder="Describe the activity..."></textarea>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn btn-cancel" id="cancel-add-activity">Cancel</button>
            <button class="btn btn-save" id="save-new-activity">Add</button>
          </div>
        </div>
        <div class="activity-timeline" id="detail-activities">
          <div class="no-data">No activity recorded</div>
        </div>
      </div>
    </div>
    <div class="save-bar">
      <button class="btn btn-deactivate" id="deactivate-entity" title="Deactivate this entity">Deactivate</button>
      <span class="save-status" id="save-status"></span>
      <button class="btn btn-close" id="close-detail">Close</button>
      <button class="btn btn-save" id="save-detail">Save Changes</button>
    </div>
  </div>
</div>
<!-- Create Entity Modal -->
<div class="modal-overlay" id="create-modal">
  <div class="create-modal">
    <div class="modal-header">
      <h2>Add New Entity</h2>
      <button class="modal-close" id="create-modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Entity Info -->
      <div>
        <label style="display:block;font-size:11px;color:#64748b;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Type</label>
        <div class="type-selector">
          <button class="type-btn agency active" data-type="agency">Agency</button>
          <button class="type-btn customer" data-type="customer">Advertiser</button>
        </div>
      </div>
      <div class="form-field">
        <label>Name *</label>
        <input type="text" id="create-name" placeholder="Entity name">
      </div>
      <div class="form-field" id="create-sector-field" style="display:none">
        <label>Sector</label>
        <select id="create-sector">
          <option value="">-- No Sector --</option>
        </select>
      </div>
      <div class="form-field" id="create-agency-field" style="display:none">
        <label>Agency</label>
        <select id="create-agency">
          <option value="">-- No Agency (Direct) --</option>
        </select>
      </div>
      <div class="form-row" id="create-customer-fields" style="display:none">
        <div class="form-field">
          <label>PO Number</label>
          <input type="text" id="create-po-number" placeholder="Purchase order number">
        </div>
        <div class="form-field">
          <div class="affidavit-toggle" style="margin-top:20px">
            <input type="checkbox" id="create-affidavit">
            <label for="create-affidavit">Affidavit Required</label>
          </div>
        </div>
      </div>
      <div class="form-field">
        <label>Assigned AE</label>
        <select id="create-ae">
          <option value="">-- No AE --</option>
        </select>
      </div>
      <div class="form-field">
        <label>Notes</label>
        <textarea id="create-notes" placeholder="Optional notes" style="min-height:60px"></textarea>
      </div>

      <!-- Address -->
      <div class="section-label">Address</div>
      <div class="form-field">
        <label>Street</label>
        <input type="text" id="create-address" placeholder="123 Main St">
      </div>
      <div class="form-row" style="grid-template-columns:1fr 80px 100px">
        <div class="form-field">
          <label>City</label>
          <input type="text" id="create-city" placeholder="City">
        </div>
        <div class="form-field">
          <label>State</label>
          <input type="text" id="create-state" placeholder="CA" maxlength="2">
        </div>
        <div class="form-field">
          <label>ZIP</label>
          <input type="text" id="create-zip" placeholder="12345" maxlength="10">
        </div>
      </div>

      <!-- Contact -->
      <div class="section-label">Primary Contact</div>
      <div class="form-row">
        <div class="form-field">
          <label>Contact Name</label>
          <input type="text" id="create-contact-name" placeholder="Full name">
        </div>
        <div class="form-field">
          <label>Title</label>
          <input type="text" id="create-contact-title" placeholder="Job title">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>Email</label>
          <input type="email" id="create-contact-email" placeholder="email@example.com">
        </div>
        <div class="form-field">
          <label>Phone</label>
          <input type="text" id="create-contact-phone" placeholder="(555) 123-4567">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>Role</label>
          <select id="create-contact-role">
            <option value="">-- Select Role --</option>
            <option value="decision_maker">Decision Maker</option>
            <option value="account_manager">Account Manager</option>
            <option value="billing">Billing</option>
            <option value="technical">Technical</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-field"></div>
      </div>

      <div class="error-msg" id="create-error"></div>
      <div class="form-actions">
        <button class="btn btn-cancel" id="create-cancel">Cancel</button>
        <button class="btn btn-create" id="create-submit">Create</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function() {
  const API = '/api/address-book';
  let currentData = [];
  let sectorsData = [];
  let marketsData = [];
  let aeListData = [];
  let currentEntity = null;
  let hasUnsavedChanges = false;
  let selectedEntities = new Set();
  let viewMode = localStorage.getItem('addressBookView') || 'cards';

  function esc(s) {
    return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // ===== Centralized fetch helper =====
  async function apiFetch(url, options = {}) {
    try {
      const r = await fetch(url, options);
      if (r.ok) {
        const data = await r.json().catch(() => null);
        return { ok: true, data, status: r.status };
      }
      const errData = await r.json().catch(() => null);
      return { ok: false, data: errData, error: errData?.error || `Request failed (${r.status})`, status: r.status };
    } catch (e) {
      return { ok: false, data: null, error: 'Network error. Please try again.', status: 0 };
    }
  }

  // ===== Load sectors =====
  async function loadSectors() {
    const { ok, data } = await apiFetch(`${API}/sectors`);
    if (!ok) { console.error('Failed to load sectors'); return; }
    sectorsData = data;
    document.getElementById('sector-filter').innerHTML = '<option value="">All Sectors</option>' +
      sectorsData.map(s => `<option value="${s.sector_id}">${esc(s.sector_name)}</option>`).join('');
    document.getElementById('detail-sector').innerHTML = '<option value="">-- No Sector --</option>' +
      sectorsData.map(s => `<option value="${s.sector_id}">${esc(s.sector_name)}</option>`).join('');
  }

  // ===== Load markets =====
  async function loadMarkets() {
    const { ok, data } = await apiFetch(`${API}/markets`);
    if (!ok) { console.error('Failed to load markets'); return; }
    marketsData = data;
    document.getElementById('market-filter').innerHTML = '<option value="">All Markets</option>' +
      marketsData.map(m => `<option value="${esc(m)}">${esc(m)}</option>`).join('');
  }

  // ===== Load AE list =====
  async function loadAEList() {
    const { ok, data } = await apiFetch(`${API}/ae-list`);
    if (!ok) { console.error('Failed to load AE list'); return; }
    aeListData = data;
    const filterEl = document.getElementById('ae-filter');
    filterEl.innerHTML = '<option value="">All AEs</option><option value="__none__">Unassigned</option>' +
      aeListData.map(ae => `<option value="${esc(ae)}">${esc(ae)}</option>`).join('');
    const detailEl = document.getElementById('detail-ae');
    detailEl.innerHTML = '<option value="">-- No AE Assigned --</option>' +
      aeListData.map(ae => `<option value="${esc(ae)}">${esc(ae)}</option>`).join('');
  }

  // ===== Load data =====
  async function loadData() {
    const countEl = document.getElementById('count');
    countEl.textContent = 'Loading\u2026';
    countEl.classList.add('loading');

    const params = new URLSearchParams({
      search: document.getElementById('search').value.trim(),
      type: document.getElementById('type-filter').value,
      market: document.getElementById('market-filter').value,
      ae: document.getElementById('ae-filter').value,
      has_contacts: document.getElementById('contacts-filter').value,
      sector_id: document.getElementById('sector-filter').value,
      sort: document.getElementById('sort-filter').value,
      include_inactive: document.getElementById('inactive-filter').checked ? '1' : '0'
    });
    const { ok, data, error } = await apiFetch(`${API}?${params}`);
    if (ok) {
      currentData = data;
      updateStats();
      renderGrid();
    } else {
      countEl.textContent = 'Error loading';
      console.error('Load error:', error);
    }
    countEl.classList.remove('loading');
  }

  function updateStats() {
    const agencies = currentData.filter(d => d.entity_type === 'agency').length;
    const customers = currentData.filter(d => d.entity_type === 'customer').length;
    const withContacts = currentData.filter(d => d.contact_count > 0).length;
    const noContacts = currentData.filter(d => d.contact_count === 0).length;
    document.getElementById('stats').innerHTML = `
      <div class="stat agencies"><div class="val">${agencies}</div><div class="lbl">Agencies</div></div>
      <div class="stat customers"><div class="val">${customers}</div><div class="lbl">Advertisers</div></div>
      <div class="stat"><div class="val">${withContacts}</div><div class="lbl">With Contacts</div></div>
      <div class="stat warn"><div class="val">${noContacts}</div><div class="lbl">Missing Contacts</div></div>`;
    document.getElementById('count').textContent = `${currentData.length} entities`;
  }

  function renderGrid() {
    const grid = document.getElementById('grid');
    const table = document.getElementById('table');

    if (!currentData.length) {
      grid.innerHTML = `<div class="empty"><h3>No entities found</h3><p>Try adjusting your filters.</p></div>`;
      grid.classList.remove('hidden');
      table.classList.remove('active');
      return;
    }

    // Render card view
    grid.innerHTML = currentData.map(renderCard).join('');
    document.querySelectorAll('.entity-card').forEach(card => {
      card.addEventListener('click', () => openDetail(card.dataset.type, card.dataset.id));
    });

    // Render table view
    renderTable();

    // Apply view mode
    applyViewMode();
  }

  function renderTable() {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = currentData.map(e => {
      const key = `${e.entity_type}:${e.entity_id}`;
      const isSelected = selectedEntities.has(key);
      const revenue = e.total_revenue || 0;
      const revenueStr = revenue >= 1000000 ? `$${(revenue/1000000).toFixed(1)}M` :
                         revenue >= 1000 ? `$${(revenue/1000).toFixed(0)}K` :
                         `$${revenue.toFixed(0)}`;
      const lastActive = e.last_active ? formatDate(e.last_active) : '-';
      const inactiveTag = e.is_active === 0 ? '<span class="badge-inactive">Inactive</span>' : '';
      return `
        <tr class="${isSelected ? 'selected' : ''}" data-key="${key}" data-type="${e.entity_type}" data-id="${e.entity_id}">
          <td class="checkbox-cell"><input type="checkbox" class="row-select" ${isSelected ? 'checked' : ''}></td>
          <td class="name-cell">${esc(e.entity_name)}${inactiveTag}</td>
          <td class="type-cell"><span class="entity-type ${e.entity_type}">${e.entity_type === 'agency' ? 'Agency' : 'Advertiser'}</span></td>
          <td>${esc(e.sector_name || '-')}</td>
          <td>${e.assigned_ae ? `<span class="ae-badge">${esc(e.assigned_ae)}</span>` : '-'}</td>
          <td>${esc(e.primary_contact || '-')}</td>
          <td>${lastActive}</td>
          <td class="revenue-cell">${revenueStr}</td>
        </tr>`;
    }).join('');

    // Attach click handlers
    tbody.querySelectorAll('.name-cell').forEach(cell => {
      cell.addEventListener('click', (e) => {
        const row = cell.closest('tr');
        openDetail(row.dataset.type, row.dataset.id);
      });
    });

    tbody.querySelectorAll('.row-select').forEach(cb => {
      cb.addEventListener('change', (e) => {
        e.stopPropagation();
        const row = cb.closest('tr');
        const key = row.dataset.key;
        if (cb.checked) {
          selectedEntities.add(key);
          row.classList.add('selected');
        } else {
          selectedEntities.delete(key);
          row.classList.remove('selected');
        }
        updateBulkToolbar();
      });
    });
  }

  function applyViewMode() {
    const grid = document.getElementById('grid');
    const table = document.getElementById('table');
    const cardsBtn = document.getElementById('view-cards');
    const tableBtn = document.getElementById('view-table');

    if (viewMode === 'table') {
      grid.classList.add('hidden');
      table.classList.add('active');
      cardsBtn.classList.remove('active');
      tableBtn.classList.add('active');
    } else {
      grid.classList.remove('hidden');
      table.classList.remove('active');
      cardsBtn.classList.add('active');
      tableBtn.classList.remove('active');
    }
  }

  // View toggle handlers
  document.getElementById('view-cards').addEventListener('click', () => {
    viewMode = 'cards';
    localStorage.setItem('addressBookView', 'cards');
    applyViewMode();
  });
  document.getElementById('view-table').addEventListener('click', () => {
    viewMode = 'table';
    localStorage.setItem('addressBookView', 'table');
    applyViewMode();
  });

  // Select all handler
  document.getElementById('select-all').addEventListener('change', function() {
    const checked = this.checked;
    document.querySelectorAll('.row-select').forEach(cb => {
      cb.checked = checked;
      const row = cb.closest('tr');
      const key = row.dataset.key;
      if (checked) {
        selectedEntities.add(key);
        row.classList.add('selected');
      } else {
        selectedEntities.delete(key);
        row.classList.remove('selected');
      }
    });
    updateBulkToolbar();
  });

  function updateBulkToolbar() {
    const toolbar = document.getElementById('bulk-toolbar');
    const countEl = document.getElementById('selected-count');
    countEl.textContent = selectedEntities.size;
    if (selectedEntities.size > 0) {
      toolbar.classList.add('active');
    } else {
      toolbar.classList.remove('active');
    }
  }

  document.getElementById('clear-selection').addEventListener('click', () => {
    selectedEntities.clear();
    document.querySelectorAll('.row-select').forEach(cb => {
      cb.checked = false;
      cb.closest('tr').classList.remove('selected');
    });
    document.getElementById('select-all').checked = false;
    updateBulkToolbar();
  });

  document.getElementById('bulk-export').addEventListener('click', () => {
    if (selectedEntities.size === 0) return;
    const ids = Array.from(selectedEntities).map(k => k.split(':'));
    const customerIds = ids.filter(([t]) => t === 'customer').map(([,id]) => id);
    const agencyIds = ids.filter(([t]) => t === 'agency').map(([,id]) => id);
    // For now, just export all with current filters - full bulk export would need backend changes
    alert(`Exporting ${selectedEntities.size} selected entities. Using current filters for export.`);
    document.getElementById('export-csv').click();
  });

  document.getElementById('bulk-set-sector').addEventListener('click', async () => {
    const customerKeys = Array.from(selectedEntities).filter(k => k.startsWith('customer:'));
    if (customerKeys.length === 0) {
      alert('No advertisers selected. Sector can only be set on advertisers, not agencies.');
      return;
    }
    const options = sectorsData.map(s => `${s.sector_id}: ${s.sector_name}`).join('\n');
    const input = prompt(`Set sector for ${customerKeys.length} advertiser(s).\n\nEnter sector ID:\n${options}`);
    if (!input) return;
    const sectorId = parseInt(input);
    if (!sectorId || !sectorsData.find(s => s.sector_id === sectorId)) {
      alert('Invalid sector ID.');
      return;
    }
    let ok = 0, fail = 0;
    for (const key of customerKeys) {
      const id = key.split(':')[1];
      const { ok: success } = await apiFetch(`${API}/customer/${id}/sector`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ sector_id: sectorId })
      });
      if (success) ok++; else fail++;
    }
    alert(`Sector updated: ${ok} succeeded${fail ? `, ${fail} failed` : ''}.`);
    loadData();
  });

  function renderCard(e) {
    const sectorBadge = e.entity_type === 'customer'
      ? `<span class="sector-badge ${e.sector_name ? '' : 'none'}">${esc(e.sector_name || 'No sector')}</span>`
      : '';
    const aeBadge = e.assigned_ae
      ? `<span class="ae-badge">${esc(e.assigned_ae)}</span>`
      : '';
    const inactiveBadge = e.is_active === 0 ? '<span class="badge-inactive">Inactive</span>' : '';
    let addressHtml = e.address || e.city ? `<div class="address-line"><span class="icon">üìç</span>${esc([e.address, [e.city, e.state].filter(Boolean).join(', '), e.zip].filter(Boolean).join(' | '))}</div>` : '';
    const notesHtml = e.notes ? `<div class="notes-preview">${esc(e.notes)}</div>` : '';
    let contactsHtml = '';
    if (e.contact_count > 0) {
      contactsHtml = e.primary_contact ? `<div class="contact-chip primary"><span class="name">${esc(e.primary_contact)}</span></div>` : '';
      if (e.contact_count > 1) contactsHtml += `<div class="contact-chip">+${e.contact_count - (e.primary_contact ? 1 : 0)} more</div>`;
    }
    // Markets
    const markets = e.markets ? e.markets.split(',') : [];
    let marketsHtml = '';
    if (markets.length > 0) {
      const displayMarkets = markets.slice(0, 4);
      marketsHtml = '<div class="market-badges">' +
        displayMarkets.map(m => `<span class="market-chip">${esc(m)}</span>`).join('') +
        (markets.length > 4 ? `<span class="market-chip more">+${markets.length - 4}</span>` : '') +
        '</div>';
    }
    // Metrics (revenue, last active, spots)
    const revenue = e.total_revenue || 0;
    const revenueStr = revenue >= 1000000 ? `$${(revenue/1000000).toFixed(1)}M` :
                       revenue >= 1000 ? `$${(revenue/1000).toFixed(0)}K` :
                       `$${revenue.toFixed(0)}`;
    const lastActive = e.last_active ? formatDate(e.last_active) : 'Never';
    const metricsHtml = `
      <div class="metrics-row">
        <div class="metric revenue"><span class="value">${revenueStr}</span> revenue</div>
        <div class="metric"><span class="value">${e.spot_count || 0}</span> spots</div>
        <div class="metric ${e.last_active ? '' : 'inactive'}">Last: <span class="value">${lastActive}</span></div>
      </div>`;
    return `
      <div class="entity-card ${e.entity_type}" data-type="${e.entity_type}" data-id="${e.entity_id}">
        <div class="card-header">
          <h4 class="entity-name">${esc(e.entity_name)}${inactiveBadge}</h4>
          <div class="header-badges">
            <span class="entity-type ${e.entity_type}">${e.entity_type === 'agency' ? 'Agency' : 'Advertiser'}</span>
            ${sectorBadge}
            ${aeBadge}
          </div>
        </div>
        <div class="card-body">
          ${metricsHtml}
          ${marketsHtml}
          ${addressHtml}
          ${notesHtml}
          <div class="contacts-summary">${contactsHtml || '<span class="no-data">No contacts</span>'}</div>
        </div>
      </div>`;
  }

  function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  // ===== Detail Modal =====
  const modal = document.getElementById('detail-modal');

  async function openDetail(type, id) {
    const { ok, data, error } = await apiFetch(`${API}/${type}/${id}`);
    if (!ok) { alert(error || 'Failed to load entity'); return; }
    currentEntity = data;
    currentEntity.entity_type = type;
    currentEntity.entity_id = id;

    document.getElementById('detail-name').textContent = currentEntity.entity_name;
    const badge = document.getElementById('detail-type-badge');
    badge.textContent = type === 'agency' ? 'Agency' : 'Advertiser';
    badge.className = 'type-badge ' + type;

    // Detail page link (customers only)
    const pageLink = document.getElementById('detail-page-link');
    if (type === 'customer') {
      pageLink.href = `/reports/customer/${id}`;
      pageLink.style.display = 'inline';
    } else {
      pageLink.style.display = 'none';
    }

    // Sector (customers only)
    const sectorSection = document.getElementById('sector-section');
    if (type === 'customer') {
      sectorSection.style.display = 'block';
      document.getElementById('detail-sector').value = currentEntity.sector_id || '';
    } else {
      sectorSection.style.display = 'none';
    }

    // Agency (customers only)
    const agencySection = document.getElementById('agency-section');
    if (type === 'customer') {
      agencySection.style.display = 'block';
      const agencySelect = document.getElementById('detail-agency');
      const agencies = currentData
        .filter(d => d.entity_type === 'agency' && d.is_active)
        .sort((a, b) => a.entity_name.localeCompare(b.entity_name));
      agencySelect.innerHTML = '<option value="">-- No Agency (Direct) --</option>' +
        agencies.map(a => `<option value="${a.entity_id}">${esc(a.entity_name)}</option>`).join('');
      agencySelect.value = currentEntity.agency_id || '';
    } else {
      agencySection.style.display = 'none';
    }

    // AE
    document.getElementById('detail-ae').value = currentEntity.assigned_ae || '';

    // EDI Billing (agencies only), PO Number (customers only)
    const ediSection = document.getElementById('edi-section');
    const poSection = document.getElementById('po-section');
    if (type === 'agency') {
      ediSection.style.display = 'block';
      poSection.style.display = 'none';
      document.getElementById('detail-edi-billing').checked = !!currentEntity.edi_billing;
    } else {
      ediSection.style.display = 'none';
      poSection.style.display = 'block';
      document.getElementById('detail-po-number').value = currentEntity.po_number || '';
      document.getElementById('detail-affidavit-required').checked = !!currentEntity.affidavit_required;
    }

    // Markets
    const marketsDiv = document.getElementById('detail-markets');
    if (currentEntity.markets && currentEntity.markets.length > 0) {
      marketsDiv.innerHTML = currentEntity.markets.map(m => `<span class="market-chip" style="font-size:12px;padding:4px 8px">${esc(m)}</span>`).join('');
    } else {
      marketsDiv.innerHTML = '<span class="no-data">No spots in any market</span>';
    }

    // Agency Clients (agencies only)
    const clientsSection = document.getElementById('agency-clients-section');
    if (type === 'agency') {
      clientsSection.style.display = 'block';
      loadAgencyClients(id);
    } else {
      clientsSection.style.display = 'none';
    }

    // Address
    document.getElementById('detail-address').value = currentEntity.address || '';
    document.getElementById('detail-city').value = currentEntity.city || '';
    document.getElementById('detail-state').value = currentEntity.state || '';
    document.getElementById('detail-zip').value = currentEntity.zip || '';

    // Notes
    document.getElementById('detail-notes').value = currentEntity.notes || '';

    // Contacts
    renderContacts();

    // Additional Addresses
    renderAddresses();

    // Activities
    loadActivities();

    // AE History
    loadAEHistory();

    // Reset state
    hasUnsavedChanges = false;
    document.getElementById('save-status').textContent = '';
    document.getElementById('add-contact-form').classList.remove('active');
    document.getElementById('add-address-form').classList.remove('active');
    document.getElementById('add-activity-form').classList.remove('active');

    // Track unsaved changes on editable fields
    const trackChange = () => { hasUnsavedChanges = true; };
    ['detail-notes', 'detail-address', 'detail-city', 'detail-state', 'detail-zip',
     'detail-sector', 'detail-agency', 'detail-ae', 'detail-po-number'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', trackChange, { once: true });
    });
    ['detail-edi-billing', 'detail-affidavit-required'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', trackChange, { once: true });
    });

    modal.classList.add('active');
  }

  const ACTIVITY_ICONS = {
    'note': 'üìù',
    'call': 'üìû',
    'email': 'üìß',
    'meeting': 'ü§ù',
    'status_change': 'üîÑ'
  };

  async function loadActivities() {
    const container = document.getElementById('detail-activities');
    const { ok, data: activities } = await apiFetch(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}/activities`);
    if (!ok || !activities || activities.length === 0) {
      container.innerHTML = `<div class="no-data">${ok ? 'No activity recorded' : 'Failed to load activities'}</div>`;
      return;
    }

    container.innerHTML = activities.map(a => {
      const icon = ACTIVITY_ICONS[a.activity_type] || 'üìã';
      const date = a.activity_date ? formatDateTime(a.activity_date) : '';
      return `
        <div class="activity-item">
          <div class="activity-icon ${a.activity_type}">${icon}</div>
          <div class="activity-content">
            <div class="activity-header">
              <span class="activity-type">${a.activity_type}</span>
              <span>${date}</span>
              ${a.contact_name ? `<span>with ${esc(a.contact_name)}</span>` : ''}
            </div>
            ${a.description ? `<div class="activity-desc">${esc(a.description)}</div>` : ''}
          </div>
        </div>`;
    }).join('');
  }

  async function loadAEHistory() {
    const container = document.getElementById('detail-ae-history');
    const { ok, data: history } = await apiFetch(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}/ae-history`);
    if (!ok || !history || history.length === 0) {
      container.innerHTML = `<div class="no-data">${ok ? 'No assignment history' : 'Failed to load history'}</div>`;
      return;
    }

    container.innerHTML = history.map(h => {
      const isActive = !h.ended_date;
      const start = h.assigned_date ? formatDate(h.assigned_date.split('T')[0].split(' ')[0]) : '';
      const end = h.ended_date ? formatDate(h.ended_date.split('T')[0].split(' ')[0]) : 'Present';
      const source = h.created_by === 'backfill' ? 'Auto-assigned from spot data' : 'Manual assignment';
      return `
        <div class="ae-history-item">
          <div class="ae-history-dot ${isActive ? 'active' : 'ended'}"></div>
          <div class="ae-history-info">
            <div class="ae-history-name">${esc(h.ae_name)}</div>
            <div class="ae-history-dates">${start} ‚Äî ${end}</div>
            <div class="ae-history-source">${source}</div>
          </div>
        </div>`;
    }).join('');
  }

  async function loadAgencyClients(agencyId) {
    const tbody = document.getElementById('agency-clients-body');
    const countEl = document.getElementById('agency-clients-count');
    tbody.innerHTML = '<tr><td colspan="5" class="no-data">Loading...</td></tr>';
    try {
      const { ok, data } = await apiFetch(`${API}/agency/${agencyId}/customers`);
      if (!ok) throw new Error('Failed to load');
      const clients = data.customers || [];
      countEl.textContent = `(${clients.length})`;
      if (clients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-data">No clients on record</td></tr>';
        return;
      }
      tbody.innerHTML = clients.map(c => {
        const rev = c.revenue_via_agency || 0;
        const revStr = rev >= 1000000 ? `$${(rev/1000000).toFixed(1)}M` :
                       rev >= 1000 ? `$${(rev/1000).toFixed(0)}K` :
                       rev > 0 ? `$${rev.toFixed(0)}` : '-';
        return `<tr>
          <td><a href="/reports/customer/${c.customer_id}" target="_blank" style="color:#0ea5e9;text-decoration:none">${esc(c.customer_name)}</a></td>
          <td>${esc(c.sector_name || '-')}</td>
          <td><input class="po-input" data-customer-id="${c.customer_id}" value="${esc(c.po_number || '')}" placeholder="‚Äî"><span class="po-saved">‚úì</span></td>
          <td class="spots">${c.spot_count || '-'}</td>
          <td class="revenue">${revStr}</td>
        </tr>`;
      }).join('');

      // Save PO number on change
      tbody.querySelectorAll('.po-input').forEach(input => {
        const client = clients.find(c => c.customer_id == input.dataset.customerId);
        input.addEventListener('change', async () => {
          const custId = input.dataset.customerId;
          const saved = input.nextElementSibling;
          const { ok } = await apiFetch(`${API}/customer/${custId}/billing-info`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              po_number: input.value.trim() || null,
              edi_billing: !!(client && client.edi_billing)
            })
          });
          if (ok) {
            saved.classList.add('show');
            setTimeout(() => saved.classList.remove('show'), 1500);
          }
        });
      });
    } catch (e) {
      tbody.innerHTML = '<tr><td colspan="5" class="no-data">Failed to load clients</td></tr>';
    }
  }

  function formatDateTime(dt) {
    if (!dt) return '';
    const d = new Date(dt);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
  }

  // Activity form handlers
  document.getElementById('show-add-activity').addEventListener('click', () => {
    document.getElementById('add-activity-form').classList.add('active');
  });
  document.getElementById('cancel-add-activity').addEventListener('click', () => {
    document.getElementById('add-activity-form').classList.remove('active');
    document.getElementById('new-activity-type').value = 'note';
    document.getElementById('new-activity-desc').value = '';
  });
  document.getElementById('save-new-activity').addEventListener('click', async () => {
    const activityType = document.getElementById('new-activity-type').value;
    const description = document.getElementById('new-activity-desc').value.trim();

    const { ok, error } = await apiFetch(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}/activities`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ activity_type: activityType, description: description || null })
    });

    if (ok) {
      document.getElementById('add-activity-form').classList.remove('active');
      document.getElementById('new-activity-type').value = 'note';
      document.getElementById('new-activity-desc').value = '';
      loadActivities();
    } else {
      alert(error || 'Failed to add activity');
    }
  });

  const ROLE_LABELS = {
    'decision_maker': 'Decision Maker',
    'account_manager': 'Account Manager',
    'billing': 'Billing',
    'technical': 'Technical',
    'other': 'Other'
  };

  function renderContacts() {
    const list = document.getElementById('detail-contacts');
    if (!currentEntity.contacts || currentEntity.contacts.length === 0) {
      list.innerHTML = '<div class="no-data">No contacts yet</div>';
      return;
    }
    list.innerHTML = currentEntity.contacts.map(c => {
      const roleLabel = c.contact_role ? ROLE_LABELS[c.contact_role] || c.contact_role : '';
      const lastContacted = c.last_contacted ? `Last contact: ${formatDate(c.last_contacted)}` : '';
      return `
      <div class="contact-card ${c.is_primary ? 'primary' : ''}" data-contact-id="${c.contact_id}">
        <div class="contact-info">
          <div class="contact-name">
            ${esc(c.contact_name)}
            ${c.is_primary ? '<span class="primary-badge">PRIMARY</span>' : ''}
            ${roleLabel ? `<span class="role-badge">${roleLabel}</span>` : ''}
          </div>
          ${c.contact_title ? `<div class="contact-title">${esc(c.contact_title)}</div>` : ''}
          <div class="contact-details">
            ${c.email ? `<span>üìß ${esc(c.email)}</span>` : ''}
            ${c.phone ? `<span>üìû ${esc(c.phone)}</span>` : ''}
            ${lastContacted ? `<span style="color:#64748b;font-size:11px">${lastContacted}</span>` : ''}
          </div>
        </div>
        <div class="contact-actions">
          <button class="edit" title="Edit contact">‚úèÔ∏è</button>
          <button class="mark-contacted" title="Mark as contacted">üìû</button>
          ${!c.is_primary ? `<button class="set-primary" title="Set as primary">‚≠ê</button>` : ''}
          <button class="delete" title="Delete contact">üóëÔ∏è</button>
        </div>
      </div>`;
    }).join('');

    // Attach handlers
    list.querySelectorAll('.set-primary').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const contactId = btn.closest('.contact-card').dataset.contactId;
        await setPrimaryContact(contactId);
      });
    });
    list.querySelectorAll('.delete').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!confirm('Delete this contact?')) return;
        const contactId = btn.closest('.contact-card').dataset.contactId;
        await deleteContact(contactId);
      });
    });
    list.querySelectorAll('.mark-contacted').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const contactId = btn.closest('.contact-card').dataset.contactId;
        await markContacted(contactId);
      });
    });
    list.querySelectorAll('.edit').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const card = btn.closest('.contact-card');
        const contactId = card.dataset.contactId;
        const contact = currentEntity.contacts.find(c => c.contact_id == contactId);
        if (contact) showEditContactForm(card, contact);
      });
    });
  }

  // ===== Additional Addresses =====
  function renderAddresses() {
    const list = document.getElementById('detail-addresses');
    if (!currentEntity.addresses || currentEntity.addresses.length === 0) {
      list.innerHTML = '<div class="no-data">No additional addresses</div>';
      return;
    }
    list.innerHTML = currentEntity.addresses.map(a => {
      const parts = [a.address, [a.city, a.state].filter(Boolean).join(', '), a.zip].filter(Boolean);
      return `
      <div class="address-card ${a.is_primary ? 'primary' : ''}" data-address-id="${a.address_id}">
        <div class="address-info">
          <div>
            <span class="address-label-badge">${esc(a.address_label)}</span>
            ${a.is_primary ? '<span class="address-label-badge primary">PRIMARY</span>' : ''}
          </div>
          <div class="address-text">${esc(parts.join(' | ') || 'No address details')}</div>
          ${a.notes ? `<div class="address-notes">${esc(a.notes)}</div>` : ''}
        </div>
        <div class="address-actions">
          <button class="edit-addr" title="Edit address">‚úèÔ∏è</button>
          ${!a.is_primary ? `<button class="set-primary-addr" title="Set as primary">‚≠ê</button>` : ''}
          <button class="delete" title="Delete address">üóëÔ∏è</button>
        </div>
      </div>`;
    }).join('');

    // Attach handlers
    list.querySelectorAll('.set-primary-addr').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const addrId = btn.closest('.address-card').dataset.addressId;
        const addr = currentEntity.addresses.find(a => a.address_id == addrId);
        if (!addr) return;
        const { ok, error } = await apiFetch(`${API}/addresses/${addrId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ ...addr, is_primary: true })
        });
        if (ok) refreshAddresses();
        else alert(error || 'Failed to set primary address');
      });
    });
    list.querySelectorAll('.edit-addr').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const card = btn.closest('.address-card');
        const addrId = card.dataset.addressId;
        const addr = currentEntity.addresses.find(a => a.address_id == addrId);
        if (addr) showEditAddressForm(card, addr);
      });
    });
    list.querySelectorAll('.delete').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!confirm('Delete this address?')) return;
        const addrId = btn.closest('.address-card').dataset.addressId;
        const { ok, error } = await apiFetch(`${API}/addresses/${addrId}`, { method: 'DELETE' });
        if (ok) refreshAddresses();
        else alert(error || 'Failed to delete address');
      });
    });
  }

  function showEditAddressForm(card, addr) {
    const labelOptions = ['Billing', 'Shipping', 'PO Box', 'Office', 'Other'];
    card.innerHTML = `
      <div class="address-edit-form">
        <div class="form-row">
          <div class="form-field">
            <label>Label</label>
            <select class="edit-addr-label">
              ${labelOptions.map(l => `<option value="${l}" ${l === addr.address_label ? 'selected' : ''}>${l}</option>`).join('')}
            </select>
          </div>
          <div class="form-field">
            <label>Street</label>
            <input type="text" class="edit-addr-street" value="${esc(addr.address || '')}" placeholder="Street address">
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label>City</label>
            <input type="text" class="edit-addr-city" value="${esc(addr.city || '')}" placeholder="City">
          </div>
          <div class="form-field">
            <label>State</label>
            <input type="text" class="edit-addr-state" value="${esc(addr.state || '')}" placeholder="State">
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label>ZIP</label>
            <input type="text" class="edit-addr-zip" value="${esc(addr.zip || '')}" placeholder="ZIP code">
          </div>
          <div class="form-field">
            <label>Notes</label>
            <input type="text" class="edit-addr-notes" value="${esc(addr.notes || '')}" placeholder="Notes">
          </div>
        </div>
        <div style="margin-top:8px">
          <label style="font-size:13px;color:#475569;cursor:pointer">
            <input type="checkbox" class="edit-addr-primary" ${addr.is_primary ? 'checked' : ''}> Primary address
          </label>
        </div>
        <div class="form-actions">
          <button class="btn btn-cancel edit-addr-cancel">Cancel</button>
          <button class="btn btn-save edit-addr-save">Save</button>
        </div>
      </div>`;
    card.querySelector('.edit-addr-cancel').addEventListener('click', () => renderAddresses());
    card.querySelector('.edit-addr-save').addEventListener('click', () => saveAddressEdit(card, addr.address_id));
    card.querySelector('.edit-addr-street').focus();
  }

  async function saveAddressEdit(card, addressId) {
    const { ok, error } = await apiFetch(`${API}/addresses/${addressId}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        address_label: card.querySelector('.edit-addr-label').value,
        address: card.querySelector('.edit-addr-street').value.trim() || '',
        city: card.querySelector('.edit-addr-city').value.trim() || '',
        state: card.querySelector('.edit-addr-state').value.trim() || '',
        zip: card.querySelector('.edit-addr-zip').value.trim() || '',
        notes: card.querySelector('.edit-addr-notes').value.trim() || '',
        is_primary: card.querySelector('.edit-addr-primary').checked
      })
    });
    if (ok) {
      refreshAddresses();
    } else {
      alert(error || 'Failed to update address');
    }
  }

  async function refreshAddresses() {
    const { ok, data } = await apiFetch(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}/addresses`);
    if (ok) {
      currentEntity.addresses = data;
      renderAddresses();
    }
  }

  // Add address form handlers
  document.getElementById('show-add-address').addEventListener('click', () => {
    document.getElementById('add-address-form').classList.add('active');
  });
  document.getElementById('cancel-add-address').addEventListener('click', () => {
    document.getElementById('add-address-form').classList.remove('active');
    clearNewAddressForm();
  });
  document.getElementById('save-new-address').addEventListener('click', async () => {
    const label = document.getElementById('new-address-label').value;
    if (!label) { alert('Label is required'); return; }
    const { ok, error } = await apiFetch(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}/addresses`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        address_label: label,
        address: document.getElementById('new-address-street').value.trim() || null,
        city: document.getElementById('new-address-city').value.trim() || null,
        state: document.getElementById('new-address-state').value.trim() || null,
        zip: document.getElementById('new-address-zip').value.trim() || null,
        is_primary: document.getElementById('new-address-primary').checked,
        notes: document.getElementById('new-address-notes').value.trim() || null
      })
    });
    if (ok) {
      document.getElementById('add-address-form').classList.remove('active');
      clearNewAddressForm();
      refreshAddresses();
    } else {
      alert(error || 'Failed to add address');
    }
  });

  function clearNewAddressForm() {
    document.getElementById('new-address-label').value = '';
    document.getElementById('new-address-street').value = '';
    document.getElementById('new-address-city').value = '';
    document.getElementById('new-address-state').value = '';
    document.getElementById('new-address-zip').value = '';
    document.getElementById('new-address-notes').value = '';
    document.getElementById('new-address-primary').checked = false;
  }

  function showEditContactForm(card, contact) {
    const roleOptions = ['', 'decision_maker', 'account_manager', 'billing', 'technical', 'other'];
    const roleLabels = {'': '-- Select Role --', ...ROLE_LABELS};
    card.innerHTML = `
      <div class="contact-edit-form">
        <div class="form-row">
          <div class="form-field">
            <label>Name *</label>
            <input type="text" class="edit-name" value="${esc(contact.contact_name || '')}" placeholder="Full name">
          </div>
          <div class="form-field">
            <label>Title</label>
            <input type="text" class="edit-title" value="${esc(contact.contact_title || '')}" placeholder="Job title">
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label>Email</label>
            <input type="email" class="edit-email" value="${esc(contact.email || '')}" placeholder="email@example.com">
          </div>
          <div class="form-field">
            <label>Phone</label>
            <input type="text" class="edit-phone" value="${esc(contact.phone || '')}" placeholder="(555) 123-4567">
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label>Role</label>
            <select class="edit-role">
              ${roleOptions.map(r => `<option value="${r}" ${r === (contact.contact_role || '') ? 'selected' : ''}>${roleLabels[r] || r}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-cancel edit-cancel">Cancel</button>
          <button class="btn btn-save edit-save">Save</button>
        </div>
      </div>`;
    card.querySelector('.edit-cancel').addEventListener('click', () => renderContacts());
    card.querySelector('.edit-save').addEventListener('click', () => saveContactEdit(card, contact.contact_id));
    card.querySelector('.edit-name').focus();
  }

  async function saveContactEdit(card, contactId) {
    const name = card.querySelector('.edit-name').value.trim();
    if (!name) { alert('Name is required'); return; }
    const { ok, error } = await apiFetch(`/api/contacts/${contactId}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        contact_name: name,
        contact_title: card.querySelector('.edit-title').value.trim(),
        email: card.querySelector('.edit-email').value.trim(),
        phone: card.querySelector('.edit-phone').value.trim(),
        contact_role: card.querySelector('.edit-role').value
      })
    });
    if (ok) {
      const detail = await apiFetch(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}`);
      if (detail.ok) { currentEntity.contacts = detail.data.contacts; renderContacts(); }
    } else {
      alert(error || 'Failed to update contact');
    }
  }

  async function markContacted(contactId) {
    const { ok, error } = await apiFetch(`/api/contacts/${contactId}/touched`, { method: 'POST' });
    if (ok) {
      const detail = await apiFetch(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}`);
      if (detail.ok) { currentEntity.contacts = detail.data.contacts; renderContacts(); }
    } else {
      alert(error || 'Failed to mark as contacted');
    }
  }

  async function setPrimaryContact(contactId) {
    const { ok, error } = await apiFetch(`/api/contacts/${contactId}/primary`, { method: 'POST' });
    if (ok) {
      const detail = await apiFetch(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}`);
      if (detail.ok) { currentEntity.contacts = detail.data.contacts; renderContacts(); }
    } else {
      alert(error || 'Failed to set primary contact');
    }
  }

  async function deleteContact(contactId) {
    const { ok, error } = await apiFetch(`/api/contacts/${contactId}`, { method: 'DELETE' });
    if (ok) {
      currentEntity.contacts = currentEntity.contacts.filter(c => c.contact_id != contactId);
      renderContacts();
    } else {
      alert(error || 'Failed to delete contact');
    }
  }

  // Add contact form
  document.getElementById('show-add-contact').addEventListener('click', () => {
    document.getElementById('add-contact-form').classList.add('active');
    document.getElementById('new-contact-name').focus();
  });
  document.getElementById('cancel-add-contact').addEventListener('click', () => {
    document.getElementById('add-contact-form').classList.remove('active');
    clearNewContactForm();
  });
  document.getElementById('save-new-contact').addEventListener('click', async () => {
    const name = document.getElementById('new-contact-name').value.trim();
    if (!name) { alert('Name is required'); return; }
    const { ok, error } = await apiFetch(`/api/contacts/${currentEntity.entity_type}/${currentEntity.entity_id}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        contact_name: name,
        contact_title: document.getElementById('new-contact-title').value.trim() || null,
        email: document.getElementById('new-contact-email').value.trim() || null,
        phone: document.getElementById('new-contact-phone').value.trim() || null,
        contact_role: document.getElementById('new-contact-role').value || null,
        is_primary: document.getElementById('new-contact-primary').checked
      })
    });
    if (ok) {
      const detail = await apiFetch(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}`);
      if (detail.ok) { currentEntity.contacts = detail.data.contacts; renderContacts(); }
      document.getElementById('add-contact-form').classList.remove('active');
      clearNewContactForm();
    } else {
      alert(error || 'Failed to add contact');
    }
  });

  function clearNewContactForm() {
    document.getElementById('new-contact-name').value = '';
    document.getElementById('new-contact-title').value = '';
    document.getElementById('new-contact-email').value = '';
    document.getElementById('new-contact-phone').value = '';
    document.getElementById('new-contact-role').value = '';
    document.getElementById('new-contact-primary').checked = false;
  }

  // Save changes
  document.getElementById('save-detail').addEventListener('click', async () => {
    const btn = document.getElementById('save-detail');
    const status = document.getElementById('save-status');
    btn.disabled = true;
    btn.textContent = 'Saving...';
    status.textContent = '';
    status.className = 'save-status';

    try {
      const putJson = (url, body) => apiFetch(url, {
        method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
      });

      // Save address + notes in parallel
      const [addrRes, notesRes] = await Promise.all([
        putJson(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}/address`, {
          address: document.getElementById('detail-address').value.trim() || null,
          city: document.getElementById('detail-city').value.trim() || null,
          state: document.getElementById('detail-state').value.trim() || null,
          zip: document.getElementById('detail-zip').value.trim() || null
        }),
        putJson(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}/notes`, {
          notes: document.getElementById('detail-notes').value.trim() || null
        })
      ]);

      // Save customer-specific fields
      if (currentEntity.entity_type === 'customer') {
        await Promise.all([
          putJson(`${API}/customer/${currentEntity.entity_id}/sector`, {
            sector_id: document.getElementById('detail-sector').value || null
          }),
          putJson(`${API}/customer/${currentEntity.entity_id}/agency`, {
            agency_id: document.getElementById('detail-agency').value || null
          })
        ]);
      }

      // Save AE + billing in parallel
      const billingBody = currentEntity.entity_type === 'agency'
        ? { po_number: null, edi_billing: document.getElementById('detail-edi-billing').checked }
        : { po_number: document.getElementById('detail-po-number').value.trim() || null, edi_billing: false, affidavit_required: document.getElementById('detail-affidavit-required').checked };

      await Promise.all([
        putJson(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}/ae`, {
          assigned_ae: document.getElementById('detail-ae').value || null
        }),
        putJson(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}/billing-info`, billingBody)
      ]);

      status.textContent = '‚úì Saved';
      status.className = 'save-status success';
      hasUnsavedChanges = false;
      loadAEHistory();
      loadData();
    } catch (e) {
      status.textContent = '‚úó Error saving';
      status.className = 'save-status error';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Save Changes';
    }
  });

  // Deactivate entity
  document.getElementById('deactivate-entity').addEventListener('click', async () => {
    if (!currentEntity) return;
    const name = currentEntity.entity_name || 'this entity';
    if (!confirm(`Deactivate "${name}"? This will hide it from the default view.`)) return;
    const { ok, data, error } = await apiFetch(`${API}/${currentEntity.entity_type}/${currentEntity.entity_id}/deactivate`, {
      method: 'POST'
    });
    if (ok) {
      alert(data?.message || 'Entity deactivated.');
      hasUnsavedChanges = false;
      closeModal();
      loadData();
    } else {
      alert(error || 'Failed to deactivate entity');
    }
  });

  // Close modal
  function closeModal() {
    if (hasUnsavedChanges && !confirm('You have unsaved changes. Close anyway?')) return;
    modal.classList.remove('active');
    currentEntity = null;
    hasUnsavedChanges = false;
  }
  modal.querySelector('.modal-close').addEventListener('click', closeModal);
  document.getElementById('close-detail').addEventListener('click', closeModal);
  modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

  // Filter handlers
  document.getElementById('search').addEventListener('input', debounce(loadData, 300));
  ['type-filter', 'market-filter', 'ae-filter', 'sector-filter', 'contacts-filter', 'sort-filter'].forEach(id => {
    document.getElementById(id).addEventListener('change', loadData);
  });
  document.getElementById('inactive-filter').addEventListener('change', loadData);
  document.getElementById('refresh').addEventListener('click', loadData);

  function debounce(fn, ms) {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
  }

  // ===== Saved Filters =====
  let savedFiltersData = [];

  async function loadSavedFilters() {
    const { ok, data } = await apiFetch(`${API}/filters`);
    if (!ok) { console.error('Failed to load saved filters'); return; }
    savedFiltersData = data;
    const select = document.getElementById('saved-filter');
    select.innerHTML = '<option value="">Saved Filters...</option>' +
      savedFiltersData.map(f => `<option value="${f.filter_id}">${esc(f.filter_name)}</option>`).join('');
  }

  document.getElementById('saved-filter').addEventListener('change', function() {
    const filterId = this.value;
    if (!filterId) return;
    const filter = savedFiltersData.find(f => f.filter_id == filterId);
    if (!filter) return;
    const cfg = filter.filter_config;
    if (cfg.search) document.getElementById('search').value = cfg.search;
    if (cfg.type) document.getElementById('type-filter').value = cfg.type;
    if (cfg.market) document.getElementById('market-filter').value = cfg.market;
    if (cfg.ae) document.getElementById('ae-filter').value = cfg.ae;
    if (cfg.sector_id) document.getElementById('sector-filter').value = cfg.sector_id;
    if (cfg.has_contacts) document.getElementById('contacts-filter').value = cfg.has_contacts;
    if (cfg.sort) document.getElementById('sort-filter').value = cfg.sort;
    loadData();
  });

  document.getElementById('save-filter').addEventListener('click', async function() {
    const filterName = prompt('Enter a name for this filter:');
    if (!filterName) return;
    const filterConfig = {
      search: document.getElementById('search').value,
      type: document.getElementById('type-filter').value,
      market: document.getElementById('market-filter').value,
      ae: document.getElementById('ae-filter').value,
      sector_id: document.getElementById('sector-filter').value,
      has_contacts: document.getElementById('contacts-filter').value,
      sort: document.getElementById('sort-filter').value
    };
    const { ok, error } = await apiFetch(`${API}/filters`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ filter_name: filterName, filter_config: filterConfig })
    });
    if (ok) {
      alert('Filter saved!');
      loadSavedFilters();
    } else {
      alert(error || 'Failed to save filter');
    }
  });

  // ===== CSV Export =====
  document.getElementById('export-csv').addEventListener('click', function() {
    const params = new URLSearchParams({
      search: document.getElementById('search').value.trim(),
      type: document.getElementById('type-filter').value,
      market: document.getElementById('market-filter').value,
      ae: document.getElementById('ae-filter').value,
      has_contacts: document.getElementById('contacts-filter').value,
      sector_id: document.getElementById('sector-filter').value
    });
    window.location.href = `${API}/export?${params}`;
  });

  // ===== Create Entity Modal =====
  const createModal = document.getElementById('create-modal');
  let createType = 'agency';

  function openCreateModal() {
    createType = 'agency';
    document.querySelectorAll('.create-modal .type-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.create-modal .type-btn.agency').classList.add('active');
    // Reset all fields
    document.getElementById('create-name').value = '';
    document.getElementById('create-notes').value = '';
    document.getElementById('create-po-number').value = '';
    document.getElementById('create-affidavit').checked = false;
    document.getElementById('create-ae').value = '';
    document.getElementById('create-address').value = '';
    document.getElementById('create-city').value = '';
    document.getElementById('create-state').value = '';
    document.getElementById('create-zip').value = '';
    document.getElementById('create-contact-name').value = '';
    document.getElementById('create-contact-title').value = '';
    document.getElementById('create-contact-email').value = '';
    document.getElementById('create-contact-phone').value = '';
    document.getElementById('create-contact-role').value = '';
    // Customer-only fields hidden for agency default
    document.getElementById('create-sector-field').style.display = 'none';
    document.getElementById('create-agency-field').style.display = 'none';
    document.getElementById('create-customer-fields').style.display = 'none';
    const errorEl = document.getElementById('create-error');
    errorEl.classList.remove('active');
    errorEl.textContent = '';
    // Populate dropdowns from already-loaded data
    document.getElementById('create-sector').innerHTML = '<option value="">-- No Sector --</option>' +
      sectorsData.map(s => `<option value="${s.sector_id}">${esc(s.sector_name)}</option>`).join('');
    document.getElementById('create-ae').innerHTML = '<option value="">-- No AE --</option>' +
      aeListData.map(ae => `<option value="${esc(ae)}">${esc(ae)}</option>`).join('');
    const agencies = currentData
      .filter(d => d.entity_type === 'agency' && d.is_active)
      .sort((a, b) => a.entity_name.localeCompare(b.entity_name));
    document.getElementById('create-agency').innerHTML = '<option value="">-- No Agency (Direct) --</option>' +
      agencies.map(a => `<option value="${a.entity_id}">${esc(a.entity_name)}</option>`).join('');
    createModal.classList.add('active');
    document.getElementById('create-name').focus();
  }

  function closeCreateModal() {
    createModal.classList.remove('active');
  }

  document.getElementById('add-new').addEventListener('click', openCreateModal);
  document.getElementById('create-modal-close').addEventListener('click', closeCreateModal);
  document.getElementById('create-cancel').addEventListener('click', closeCreateModal);
  createModal.addEventListener('click', e => { if (e.target === createModal) closeCreateModal(); });

  // Type selector toggle
  document.querySelectorAll('.create-modal .type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      createType = btn.dataset.type;
      document.querySelectorAll('.create-modal .type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const isCustomer = createType === 'customer';
      document.getElementById('create-sector-field').style.display = isCustomer ? 'block' : 'none';
      document.getElementById('create-agency-field').style.display = isCustomer ? 'block' : 'none';
      document.getElementById('create-customer-fields').style.display = isCustomer ? 'grid' : 'none';
    });
  });

  // Submit create
  document.getElementById('create-submit').addEventListener('click', async () => {
    const name = document.getElementById('create-name').value.trim();
    const errorEl = document.getElementById('create-error');
    errorEl.classList.remove('active');

    if (!name) {
      errorEl.textContent = 'Name is required.';
      errorEl.classList.add('active');
      return;
    }

    const btn = document.getElementById('create-submit');
    btn.disabled = true;
    btn.textContent = 'Creating...';

    try {
      const body = { entity_type: createType, name };
      if (createType === 'customer') {
        const sectorVal = document.getElementById('create-sector').value;
        if (sectorVal) body.sector_id = parseInt(sectorVal);
        const agencyVal = document.getElementById('create-agency').value;
        if (agencyVal) body.agency_id = parseInt(agencyVal);
        const poVal = document.getElementById('create-po-number').value.trim();
        if (poVal) body.po_number = poVal;
        body.affidavit_required = document.getElementById('create-affidavit').checked;
      }
      const aeVal = document.getElementById('create-ae').value;
      if (aeVal) body.assigned_ae = aeVal;
      const notesVal = document.getElementById('create-notes').value.trim();
      if (notesVal) body.notes = notesVal;
      // Address
      const addrVal = document.getElementById('create-address').value.trim();
      if (addrVal) body.address = addrVal;
      const cityVal = document.getElementById('create-city').value.trim();
      if (cityVal) body.city = cityVal;
      const stateVal = document.getElementById('create-state').value.trim();
      if (stateVal) body.state = stateVal;
      const zipVal = document.getElementById('create-zip').value.trim();
      if (zipVal) body.zip = zipVal;
      // Contact
      const cName = document.getElementById('create-contact-name').value.trim();
      if (cName) body.contact_name = cName;
      const cTitle = document.getElementById('create-contact-title').value.trim();
      if (cTitle) body.contact_title = cTitle;
      const cEmail = document.getElementById('create-contact-email').value.trim();
      if (cEmail) body.contact_email = cEmail;
      const cPhone = document.getElementById('create-contact-phone').value.trim();
      if (cPhone) body.contact_phone = cPhone;
      const cRole = document.getElementById('create-contact-role').value;
      if (cRole) body.contact_role = cRole;

      const { ok, data: result, error, status } = await apiFetch(`${API}/entities`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });

      if (status === 201) {
        closeCreateModal();
        await loadData();
        openDetail(result.entity_type, result.entity_id);
      } else if (status === 409) {
        errorEl.innerHTML = `${esc(result?.error || error)}. <a onclick="document.getElementById('create-modal').classList.remove('active');openDetail('${createType}',${result?.existing_id})">Open existing?</a>`;
        errorEl.classList.add('active');
      } else {
        errorEl.textContent = error || 'Failed to create entity.';
        errorEl.classList.add('active');
      }
    } catch (e) {
      errorEl.textContent = 'Network error. Please try again.';
      errorEl.classList.add('active');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Create';
    }
  });

  // Enter key submits the create form
  document.getElementById('create-name').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('create-submit').click();
  });

  // Init
  Promise.all([loadSectors(), loadMarkets(), loadAEList(), loadSavedFilters()]).then(() => loadData());
})();
</script>
{% endblock %}
