{% extends "base.html" %}

{% block title %}Entity Resolution - SpotOps{% endblock %}
{% block header_title %}Entity Resolution{% endblock %}
{% block header_subtitle %}Create records for unmatched {{ cfg.label|lower }}s and agencies{% endblock %}

{% block extra_styles %}
<style>
  .tab-bar{display:flex;gap:0;margin-bottom:24px;border-bottom:2px solid #e2e8f0}
  .tab-bar a{padding:12px 24px;font-weight:600;font-size:14px;color:#64748b;text-decoration:none;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s}
  .tab-bar a:hover{color:#334155;background:#f8fafc}
  .tab-bar a.active{color:#0ea5e9;border-bottom-color:#0ea5e9}

  .stats-row{display:flex;gap:16px;margin-bottom:20px}
  .stat{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:14px 18px}
  .stat .val{font-size:24px;font-weight:700}
  .stat .lbl{font-size:12px;color:#64748b;margin-top:2px}
  .stat.good{background:#ecfdf5;border-color:#34d399}
  .stat.warn{background:#fef3c7;border-color:#f59e0b}

  .filter-bar{display:flex;gap:12px;margin-bottom:16px;align-items:center}
  .filter-bar input,.filter-bar select{padding:8px 12px;border:1px solid #cbd5e1;border-radius:6px}
  .filter-bar button{padding:8px 16px;border-radius:6px;cursor:pointer;border:1px solid #e2e8f0;background:#fff}
  .filter-bar button:hover{background:#f8fafc}

  .resolution-table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden}
  .resolution-table th{background:#f8fafc;padding:12px;text-align:left;font-weight:600;font-size:13px;border-bottom:1px solid #e2e8f0}
  .resolution-table td{padding:12px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
  .resolution-table tr:hover{background:#fafafa}
  .resolution-table tr.resolved{opacity:0.4;background:#f0fdf4}

  .raw-code{font-family:ui-monospace,monospace;font-size:13px;color:#334155}
  .normalized{font-size:13px;color:#0f172a}
  .normalized .diff{color:#0ea5e9;font-weight:500}
  .meta{font-size:11px;color:#94a3b8}

  .revenue{font-weight:600;text-align:right}
  .revenue.negative{color:#ef4444}

  .actions{display:flex;gap:6px}
  .actions button{padding:6px 12px;border-radius:5px;font-size:12px;cursor:pointer;border:1px solid}
  .btn-create{background:#0ea5e9;border-color:#0284c7;color:#fff}
  .btn-create:hover{background:#0284c7}
  .btn-link{background:#fff;border-color:#e2e8f0;color:#334155}
  .btn-link:hover{background:#f8fafc}
  .btn-skip{background:transparent;border-color:transparent;color:#94a3b8}

  .link-form{display:none;margin-top:8px}
  .link-form.active{display:flex;gap:8px;align-items:center}
  .link-form input{padding:6px 10px;border:1px solid #cbd5e1;border-radius:5px;font-size:12px;width:200px}
  .normalized-input{padding:4px 8px;border:1px solid #e2e8f0;border-radius:4px;font-size:13px;width:300px}
  .normalized-input:focus{border-color:#0ea5e9;outline:none}
  .empty{text-align:center;padding:40px;color:#64748b}

  .similar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;align-items:center;justify-content:center}
  .similar-overlay.active{display:flex}
  .similar-box{background:#fff;border-radius:10px;padding:24px;max-width:520px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,.18)}
  .similar-box h3{margin:0 0 12px;font-size:16px;color:#0f172a}
  .similar-box .match{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid #e2e8f0;border-radius:6px;margin-bottom:8px;cursor:pointer}
  .similar-box .match:hover{background:#f0f9ff;border-color:#0ea5e9}
  .similar-box .match .name{font-weight:600;font-size:14px}
  .similar-box .match .info{font-size:12px;color:#64748b}
  .similar-box .match .score{font-size:13px;font-weight:600;color:#0ea5e9}
  .similar-box .btns{display:flex;gap:8px;margin-top:16px;justify-content:flex-end}
  .similar-box .btns button{padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;border:1px solid}
  .btn-proceed{background:#f59e0b;border-color:#d97706;color:#fff}
  .btn-proceed:hover{background:#d97706}
  .btn-cancel-similar{background:#fff;border-color:#e2e8f0;color:#334155}
  .btn-cancel-similar:hover{background:#f8fafc}

  /* Info Modal */
  .info-btn{width:28px;height:28px;border-radius:50%;border:1px solid #94a3b8;background:#fff;color:#64748b;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1}
  .info-btn:hover{background:#f0f9ff;border-color:#0ea5e9;color:#0ea5e9}
  .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
  .modal-overlay.active{display:flex}
  .info-modal{background:#fff;border-radius:12px;width:100%;max-width:560px;box-shadow:0 20px 40px rgba(0,0,0,0.25)}
  .info-modal .modal-header{padding:20px 24px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;background:#f0f9ff}
  .info-modal .modal-header h3{margin:0;font-size:18px;color:#0369a1}
  .info-modal .modal-body{padding:24px;max-height:70vh;overflow-y:auto}
  .info-modal .info-section{margin-bottom:20px}
  .info-modal .info-section:last-child{margin-bottom:0}
  .info-modal .info-section h4{margin:0 0 6px;font-size:14px;color:#0f172a;display:flex;align-items:center;gap:8px}
  .info-modal .info-section p{margin:0;font-size:13px;color:#475569;line-height:1.5}
  .info-modal .info-section ul{margin:6px 0 0;padding-left:20px;font-size:13px;color:#475569;line-height:1.7}
  .info-modal .modal-close{background:none;border:none;font-size:24px;color:#94a3b8;cursor:pointer;padding:4px 8px}
  .info-modal .modal-close:hover{color:#334155}
</style>
{% endblock %}

{% block content %}
<div class="tab-bar">
  <a href="/entity-resolution?tab=advertiser" class="{{ 'active' if tab == 'advertiser' }}">Direct Advertisers</a>
  <a href="/entity-resolution?tab=agency" class="{{ 'active' if tab == 'agency' }}">Agencies</a>
</div>

<div class="stats-row" id="stats"></div>

<div class="filter-bar">
  <input type="text" id="search" placeholder="{{ cfg.search_placeholder_resolution }}">
  <select id="min-revenue">
    <option value="0">All revenue</option>
    <option value="100">&ge; $100</option>
    <option value="500" selected>&ge; $500</option>
    <option value="1000">&ge; $1,000</option>
    <option value="5000">&ge; $5,000</option>
  </select>
  <button id="refresh">Refresh</button>
  <a href="{{ cfg.aliases_link }}">{{ cfg.label }} Aliases</a>
  <button class="info-btn" onclick="document.getElementById('info-modal').classList.add('active')" title="About this page">?</button>
</div>

<table class="resolution-table">
  <thead>
    <tr>
      <th style="width:35%">Raw Name &rarr; Normalized Name</th>
      <th style="width:15%">Revenue</th>
      <th style="width:10%">Spots</th>
      <th style="width:15%">Date Range</th>
      <th style="width:25%">Actions</th>
    </tr>
  </thead>
  <tbody id="tbody">
    <tr><td colspan="5" class="empty">Loading...</td></tr>
  </tbody>
</table>

{% if cfg.has_similarity_check %}
<div class="similar-overlay" id="similar-overlay">
  <div class="similar-box">
    <h3>Similar {{ cfg.label|lower }}s found</h3>
    <p style="font-size:13px;color:#64748b;margin:0 0 12px">Did you mean one of these? Click a match to link instead.</p>
    <div id="similar-matches"></div>
    <div class="btns">
      <button class="btn-cancel-similar" id="similar-cancel">Cancel</button>
      <button class="btn-proceed" id="similar-proceed">Create Anyway</button>
    </div>
  </div>
</div>
{% endif %}

<!-- Info Modal -->
<div class="modal-overlay" id="info-modal">
  <div class="info-modal">
    <div class="modal-header">
      <h3>About Entity Resolution</h3>
      <button class="modal-close" onclick="document.getElementById('info-modal').classList.remove('active')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="info-section">
        <h4>What is this page?</h4>
        <p>This page shows raw names from spot data that haven't been matched to a canonical record yet. For each unresolved entry you can:</p>
        <ul>
          <li><strong>Create</strong> &mdash; make a new canonical record and automatically create an alias linking the raw name to it.</li>
          <li><strong>Link</strong> &mdash; search for an existing record and map the raw name as a new alias.</li>
          <li><strong>Skip</strong> &mdash; hide the row for now (it will reappear on refresh).</li>
        </ul>
      </div>
      {% if tab == 'advertiser' %}
      <div class="info-section">
        <h4>Direct Advertisers tab</h4>
        <p>Shows unresolved <strong>bill codes</strong> &mdash; the raw customer identifier from traffic/billing systems. The "Normalized Name" is a cleaned-up version you can edit before creating. A similarity check warns you if a close match already exists, preventing accidental duplicates.</p>
      </div>
      <div class="info-section">
        <h4>Why not all customers?</h4>
        <p>Only bill codes that haven't been linked to any customer record appear here. Once resolved, they move to the <a href="/entity-aliases?tab=advertiser">Entity Aliases</a> page where you can manage them further.</p>
      </div>
      {% else %}
      <div class="info-section">
        <h4>Agencies tab</h4>
        <p>Shows unresolved <strong>agency names</strong> from raw spot data. Unlike advertisers, there is no similarity check &mdash; agency names tend to be more distinct. The workflow is otherwise identical: create a new agency record or link to an existing one.</p>
      </div>
      {% endif %}
      <div class="info-section">
        <h4>Revenue filter</h4>
        <p>Use the revenue dropdown to prioritize high-value unresolved entries. The default (&ge; $500) hides low-revenue noise so you can focus on entries that matter most to reporting accuracy.</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const CFG = {{ cfg | tojson }};
  const API = CFG.api_prefix_resolution;

  async function loadStats() {
    const r = await fetch(`${API}/stats`);
    const s = await r.json();
    document.getElementById('stats').innerHTML = `
      <div class="stat good">
        <div class="val">${s.resolution_rate}%</div>
        <div class="lbl">Resolution rate</div>
      </div>
      <div class="stat">
        <div class="val">${s.resolved.toLocaleString()}</div>
        <div class="lbl">Resolved</div>
      </div>
      <div class="stat warn">
        <div class="val">${s.unresolved.toLocaleString()}</div>
        <div class="lbl">Unresolved</div>
      </div>
      <div class="stat warn">
        <div class="val">$${s.unresolved_revenue.toLocaleString(undefined, {maximumFractionDigits:0})}</div>
        <div class="lbl">Unresolved revenue</div>
      </div>
    `;
  }

  async function loadTable() {
    const minRev = document.getElementById('min-revenue').value;
    const search = document.getElementById('search').value.trim();
    const tbody = document.getElementById('tbody');

    const r = await fetch(`${API}/unresolved?min_revenue=${minRev}`);
    let items = await r.json();

    if (search) {
      const q = search.toLowerCase();
      items = items.filter(i =>
        (i[CFG.raw_field] || '').toLowerCase().includes(q) ||
        (i[CFG.name_field] || i.normalized_name || '').toLowerCase().includes(q)
      );
    }

    if (!items.length) {
      tbody.innerHTML = `<tr><td colspan="5" class="empty">
        <div style="padding:20px">
          <div style="font-size:18px;margin-bottom:8px">${esc(CFG.empty_all_resolved)}</div>
          <div style="color:#64748b;font-size:14px">${esc(CFG.empty_none_found)}</div>
          <div style="margin-top:16px"><a href="${esc(CFG.aliases_link)}" style="color:#0ea5e9">Manage existing ${CFG.label_plural.toLowerCase()} and aliases &rarr;</a></div>
        </div>
      </td></tr>`;
      return;
    }

    tbody.innerHTML = items.map(i => renderRow(i)).join('');
    attachHandlers();
  }

  function renderRow(item) {
    const rawValue = item[CFG.raw_field];
    const nameValue = item[CFG.name_field] || item.normalized_name;
    const normalizedDisplay = `<span class="diff">&rarr;</span> <input type="text" class="normalized-input" value="${esc(nameValue)}">`;
    const revClass = item.revenue < 0 ? 'revenue negative' : 'revenue';

    return `
      <tr data-raw="${esc(rawValue)}" data-normalized="${esc(nameValue)}">
        <td>
          <div class="raw-code">${esc(rawValue)}</div>
          <div class="normalized">${normalizedDisplay}</div>
        </td>
        <td class="${revClass}">$${item.revenue.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
        <td>${item.spot_count}</td>
        <td class="meta">${item.first_seen || '?'} &ndash; ${item.last_seen || '?'}</td>
        <td>
          <div class="actions">
            <button class="btn-create" title="Create ${esc(CFG.label.toLowerCase())} with normalized name">Create ${esc(CFG.label)}</button>
            <button class="btn-link" title="Link to existing ${esc(CFG.label.toLowerCase())}">Link...</button>
            <button class="btn-skip" title="Skip for now">Skip</button>
          </div>
          <div class="link-form">
            <input type="text" placeholder="Search ${CFG.label_plural.toLowerCase()}..." list="dl-${esc(rawValue)}">
            <datalist id="dl-${esc(rawValue)}"></datalist>
            <input type="hidden" class="entity-id">
            <button class="btn-create">Link</button>
            <button class="btn-skip">Cancel</button>
          </div>
        </td>
      </tr>
    `;
  }

  function attachHandlers() {
    // Create button
    document.querySelectorAll('.btn-create').forEach(btn => {
      if (btn.closest('.link-form')) return;
      btn.addEventListener('click', async function() {
        const row = this.closest('tr');
        const rawValue = row.dataset.raw;
        const normalized = row.querySelector('.normalized-input').value.trim();
        if (!normalized) { alert('Normalized name cannot be empty'); return; }
        await createEntity(row, rawValue, normalized);
      });
    });

    // Link button (show form)
    document.querySelectorAll('.btn-link').forEach(btn => {
      btn.addEventListener('click', function() {
        const row = this.closest('tr');
        row.querySelector('.actions').style.display = 'none';
        row.querySelector('.link-form').classList.add('active');
        row.querySelector('.link-form input[type="text"]').focus();
      });
    });

    // Link form search
    document.querySelectorAll('.link-form input[type="text"]').forEach(input => {
      let timeout;
      input.addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(async () => {
          const q = input.value.trim();
          if (q.length < 2) return;
          const r = await fetch(`${API}/search?q=${encodeURIComponent(q)}`);
          const results = await r.json();
          const dl = input.nextElementSibling;
          dl.innerHTML = results.map(c =>
            `<option value="${esc(c[CFG.name_field])}" data-id="${c[CFG.id_field]}">`
          ).join('');
        }, 200);
      });
      input.addEventListener('change', () => {
        const dl = input.nextElementSibling;
        const opt = dl.querySelector(`option[value="${input.value}"]`);
        if (opt) {
          input.closest('.link-form').querySelector('.entity-id').value = opt.dataset.id;
        }
      });
    });

    // Link form submit
    document.querySelectorAll('.link-form .btn-create').forEach(btn => {
      btn.addEventListener('click', async function() {
        const row = this.closest('tr');
        const rawValue = row.dataset.raw;
        const entityId = row.querySelector('.entity-id').value;
        if (!entityId) { alert(`Select a ${CFG.label.toLowerCase()} first`); return; }
        await linkEntity(row, rawValue, parseInt(entityId));
      });
    });

    // Cancel link / Skip
    document.querySelectorAll('.btn-skip').forEach(btn => {
      btn.addEventListener('click', function() {
        const row = this.closest('tr');
        const linkForm = row.querySelector('.link-form');
        if (linkForm.classList.contains('active')) {
          linkForm.classList.remove('active');
          row.querySelector('.actions').style.display = 'flex';
        } else {
          row.style.display = 'none';
        }
      });
    });
  }

  async function createEntity(row, rawValue, normalized) {
    row.style.opacity = '0.5';
    try {
      // Similarity check (advertiser only)
      if (CFG.has_similarity_check) {
        const chk = await fetch(`${API}/check-similar`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ normalized_name: normalized })
        });
        const chkData = await chk.json();

        if (chkData.similar && chkData.similar.length > 0) {
          row.style.opacity = '1';
          const choice = await showSimilarWarning(chkData.similar, rawValue, normalized);
          if (choice === 'cancel') return;
          if (choice && choice !== 'proceed') {
            await linkEntity(row, rawValue, parseInt(choice));
            return;
          }
          row.style.opacity = '0.5';
        }
      }

      // Build create payload based on entity type
      let payload;
      if (CFG.db_entity_type === 'customer') {
        payload = { bill_code: rawValue, normalized_name: normalized };
      } else {
        payload = { agency_raw: rawValue, agency_name: normalized };
      }

      const r = await fetch(`${API}/create`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const result = await r.json();
      if (!r.ok || !result.success) throw new Error(result.error || 'Failed');

      row.classList.add('resolved');
      row.querySelector('.actions').innerHTML = `<span class="meta">Created${result.alias_created ? ' + alias' : ''}</span>`;
      loadStats();
    } catch (e) {
      row.style.opacity = '1';
      alert('Error: ' + e.message);
    }
  }

  {% if cfg.has_similarity_check %}
  function showSimilarWarning(matches, rawValue, normalized) {
    return new Promise(resolve => {
      const overlay = document.getElementById('similar-overlay');
      const container = document.getElementById('similar-matches');
      container.innerHTML = matches.map(m => `
        <div class="match" data-id="${m.customer_id}">
          <div>
            <div class="name">${esc(m.normalized_name)}</div>
            <div class="info">${m.match_type} match &middot; ID ${m.customer_id}</div>
          </div>
          <div class="score">${Math.round(m.score * 100)}%</div>
        </div>
      `).join('');
      overlay.classList.add('active');

      function cleanup() {
        overlay.classList.remove('active');
        document.getElementById('similar-cancel').removeEventListener('click', onCancel);
        document.getElementById('similar-proceed').removeEventListener('click', onProceed);
        container.querySelectorAll('.match').forEach(el => el.removeEventListener('click', onMatch));
      }
      function onCancel() { cleanup(); resolve('cancel'); }
      function onProceed() { cleanup(); resolve('proceed'); }
      function onMatch(e) {
        const id = e.currentTarget.dataset.id;
        cleanup();
        resolve(id);
      }
      document.getElementById('similar-cancel').addEventListener('click', onCancel);
      document.getElementById('similar-proceed').addEventListener('click', onProceed);
      container.querySelectorAll('.match').forEach(el => el.addEventListener('click', onMatch));
    });
  }
  {% endif %}

  async function linkEntity(row, rawValue, entityId) {
    row.style.opacity = '0.5';
    try {
      let payload;
      if (CFG.db_entity_type === 'customer') {
        payload = { bill_code: rawValue, customer_id: entityId };
      } else {
        payload = { agency_raw: rawValue, agency_id: entityId };
      }

      const r = await fetch(`${API}/link`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const result = await r.json();
      if (!r.ok || !result.success) throw new Error(result.error || 'Failed');

      row.classList.add('resolved');
      row.querySelector('.link-form').classList.remove('active');
      row.querySelector('.actions').style.display = 'flex';
      const linkedName = result[CFG.name_field] || result.normalized_name || '';
      row.querySelector('.actions').innerHTML = `<span class="meta">Linked to ${esc(linkedName)}</span>`;
      loadStats();
    } catch (e) {
      row.style.opacity = '1';
      alert('Error: ' + e.message);
    }
  }

  function esc(s) {
    return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  document.getElementById('refresh').addEventListener('click', () => { loadStats(); loadTable(); });
  document.getElementById('min-revenue').addEventListener('change', loadTable);
  document.getElementById('search').addEventListener('input', loadTable);

  loadStats();
  loadTable();

  // Close info modal on overlay click
  document.getElementById('info-modal').addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('active');
  });
})();
</script>
{% endblock %}
