{% extends "base.html" %}

{% block title %}Planning Session - CTV Booked Biz{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">‚Ä∫</span>
<a href="/planning">Planning</a>
<span class="breadcrumb-separator">‚Ä∫</span>
<span class="breadcrumb-current">Planning Session</span>
{% endblock %}

{% block header_title %}Planning Session{% endblock %}
{% block header_subtitle %}Forecast Management and Pipeline Tracking{% endblock %}

{% block extra_styles %}
<style>
/* Clickable booked cells */
.booked-cell {
    cursor: pointer;
    transition: all 0.15s ease;
    position: relative;
}

.booked-cell:hover {
    background: rgba(136, 192, 208, 0.15) !important;
}

.booked-cell:hover::after {
    content: 'üîç';
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    opacity: 0.6;
}

/* Booked Detail Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(46, 52, 64, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
}

.modal-overlay.visible {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    max-width: 700px;
    width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    transform: translateY(20px);
    transition: transform 0.2s ease;
}

.modal-overlay.visible .modal-content {
    transform: translateY(0);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
    color: var(--nord0);
}

.modal-header .subtitle {
    font-size: 13px;
    color: #718096;
    font-weight: normal;
    margin-left: 12px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #718096;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.15s;
}

.modal-close:hover {
    background: var(--nord5);
    color: var(--nord0);
}

.modal-body {
    padding: 0;
    overflow-y: auto;
    flex: 1;
}

.modal-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    padding: 20px 24px;
    background: var(--nord6);
    border-bottom: 1px solid #e2e8f0;
}

.modal-summary-item {
    text-align: center;
}

.modal-summary-item .value {
    font-size: 20px;
    font-weight: 700;
    color: var(--nord0);
}

.modal-summary-item .label {
    font-size: 11px;
    color: #718096;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.modal-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.modal-table th {
    background: var(--nord5);
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #718096;
    position: sticky;
    top: 0;
}

.modal-table th.number {
    text-align: right;
}

.modal-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #f1f5f9;
}

.modal-table td.number {
    text-align: right;
    font-variant-numeric: tabular-nums;
}

.modal-table tr:hover {
    background: rgba(136, 192, 208, 0.05);
}

.modal-table .customer-name {
    font-weight: 500;
    color: var(--nord0);
}

.modal-table .agency-name {
    font-size: 11px;
    color: #718096;
    margin-top: 2px;
}

.modal-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 60px;
    color: #718096;
}

.modal-loading .spinner {
    width: 24px;
    height: 24px;
    border: 3px solid #e2e8f0;
    border-top-color: var(--nord8);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 12px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.modal-empty {
    text-align: center;
    padding: 40px;
    color: #718096;
}

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}
    /* Planning-specific styles */
    .planning-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        background: var(--nord6);
        border-radius: 8px;
        margin-bottom: 24px;
    }
    
    .control-group {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .control-group label {
        font-size: 12px;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .control-group .value {
        font-weight: 600;
        color: var(--nord0);
    }
    
    /* Summary cards */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
        margin-bottom: 32px;
    }
    
    .summary-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border-left: 4px solid var(--nord8);
    }
    
    .summary-card.variance-positive {
        border-left-color: var(--nord14);
    }
    
    .summary-card.variance-negative {
        border-left-color: var(--nord11);
    }
    
    .summary-card .value {
        font-size: 24px;
        font-weight: 700;
        color: var(--nord0);
        margin-bottom: 4px;
    }
    
    .summary-card .label {
        font-size: 11px;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Planning table */
    .planning-table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow-x: auto;
    }
    
    .planning-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        min-width: 1400px;
    }
    
    .planning-table th {
        background: var(--nord0);
        color: var(--nord6);
        padding: 12px 10px;
        text-align: left;
        font-weight: 500;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .planning-table th.number {
        text-align: right;
    }
    
    .planning-table th.month-header {
        min-width: 85px;
    }
    
    .planning-table th.total-header {
        min-width: 100px;
        background: var(--nord1);
    }
    
    .planning-table th.entity-header-col {
        min-width: 180px;
        position: sticky;
        left: 0;
        z-index: 11;
    }
    
    .planning-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .planning-table td.number {
        text-align: right;
        font-variant-numeric: tabular-nums;
    }
    
    .planning-table td.entity-name-cell {
        position: sticky;
        left: 0;
        background: inherit;
        z-index: 5;
    }
    
    /* Quarter separators */
    .planning-table th.q-end,
    .planning-table td.q-end {
        border-right: 2px solid var(--nord3);
    }
    
    /* Active planning window highlight */
    .planning-table th.active-period {
        background: var(--nord10);
    }
    
    .planning-table td.active-period {
        background: rgba(136, 192, 208, 0.08);
    }
    
    /* Entity group styling */
    .entity-header {
        background: var(--nord5);
        font-weight: 600;
    }
    
    .entity-header td {
        padding: 14px 10px;
    }
    
    .entity-header td.entity-name-cell {
        background: var(--nord5);
    }
    
    .entity-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        margin-left: 8px;
    }
    
    .entity-badge.ae {
        background: var(--nord8);
        color: white;
    }
    
    .entity-badge.house {
        background: var(--nord14);
        color: white;
    }
    
    .entity-badge.agency {
        background: var(--nord15);
        color: white;
    }
    
    /* Row types */
    .row-label {
        padding-left: 24px !important;
        color: #718096;
        font-size: 12px;
    }
    
    .row-budget { background: #fafafa; }
    .row-budget td.entity-name-cell { background: #fafafa; }
    .row-booked { background: white; }
    .row-booked td.entity-name-cell { background: white; }
    .row-forecast { background: #f0f9ff; }
    .row-forecast td.entity-name-cell { background: #f0f9ff; }
    .row-pipeline { background: white; }
    .row-pipeline td.entity-name-cell { background: white; }
    .row-variance { background: #f7fafc; }
    .row-variance td.entity-name-cell { background: #f7fafc; }
    
    /* Editable forecast cells */
    .forecast-cell {
        position: relative;
    }
    
    .forecast-input {
        width: 100%;
        padding: 4px 6px;
        border: 2px solid var(--nord8);
        border-radius: 4px;
        font-size: 12px;
        font-variant-numeric: tabular-nums;
        text-align: right;
        background: white;
        transition: all 0.15s;
    }
    
    .forecast-input:focus {
        outline: none;
        border-color: var(--nord10);
        box-shadow: 0 0 0 3px rgba(136, 192, 208, 0.3);
    }
    
    .forecast-input.modified {
        background: #fef3c7;
        border-color: var(--nord13);
    }
    
    .forecast-input.saved {
        background: #d1fae5;
        border-color: var(--nord14);
    }
    
    /* Past months - read only styling */
    .forecast-input.past-month {
        background: #f1f5f9;
        border-color: #cbd5e1;
        color: #64748b;
    }
    
    /* Override indicator */
    .override-indicator {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 6px;
        height: 6px;
        background: var(--nord13);
        border-radius: 50%;
    }
    
    /* Booked exceeds forecast entered - visual indicator */
    .forecast-input.booked-exceeds {
        background: #ecfdf5;
        border-color: var(--nord14);
    }
    
    .booked-exceeds-indicator {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 0;
        height: 0;
        border-left: 8px solid var(--nord14);
        border-bottom: 8px solid transparent;
    }
    
    /* Variance styling */
    .variance-positive {
        color: var(--nord14);
        font-weight: 600;
    }
    
    .variance-negative {
        color: var(--nord11);
        font-weight: 600;
    }
    
    /* Pipeline highlight */
    .pipeline-value {
        font-weight: 600;
        color: var(--nord10);
    }
    
    /* Totals row */
    .totals-row {
        background: var(--nord0) !important;
        color: var(--nord6);
        font-weight: 600;
    }
    
    .totals-row td {
        border-bottom: none;
        padding: 14px 10px;
    }
    
    .totals-row td.entity-name-cell {
        background: var(--nord0);
    }
    
    /* Total column styling */
    .total-col {
        background: rgba(46, 52, 64, 0.05);
        font-weight: 600;
    }
    
    /* Actions */
    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        background: var(--nord6);
        border-top: 1px solid #e2e8f0;
    }
    
    .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.15s;
        border: none;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--nord8) 0%, var(--nord7) 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(136, 192, 208, 0.4);
    }
    
    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-secondary {
        background: white;
        color: var(--nord0);
        border: 1px solid #e2e8f0;
    }
    
    .btn-secondary:hover {
        background: var(--nord5);
    }
    
    /* Status messages */
    .status-message {
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 13px;
        display: none;
    }
    
    .status-message.visible {
        display: block;
    }
    
    .status-message.success {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-message.error {
        background: #fee2e2;
        color: #991b1b;
    }
    
    /* Data notes */
    .data-notes {
        margin-top: 24px;
        padding: 16px;
        background: #f7fafc;
        border-radius: 8px;
        font-size: 12px;
        color: #718096;
    }
    
    .data-notes strong {
        color: var(--nord0);
    }
    
    /* Legend for active window */
    .period-legend {
        display: flex;
        gap: 24px;
        margin-bottom: 16px;
        font-size: 12px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .legend-swatch {
        width: 16px;
        height: 16px;
        border-radius: 3px;
    }
    
    .legend-swatch.active {
        background: var(--nord10);
    }
    
    .legend-swatch.past {
        background: #cbd5e1;
    }
    
    /* =========================================================================
       BURN-DOWN STRIP STYLES
       ========================================================================= */
    
    .burn-down-row {
        background: linear-gradient(180deg, var(--nord1) 0%, var(--nord0) 100%) !important;
    }
    
    .burn-down-row th {
        background: transparent !important;
        padding: 10px 8px !important;
        vertical-align: middle;
        border-bottom: 2px solid var(--nord3);
    }
    
    .burn-down-cell {
        text-align: center !important;
        color: var(--nord6);
        font-size: 11px;
    }
    
    .burn-down-cell.inactive {
        opacity: 0.3;
    }
    
    .burn-down-label {
        font-weight: 600 !important;
        color: var(--nord4) !important;
        font-size: 10px !important;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-align: left !important;
    }
    
    /* Days left */
    .burn-down-days {
        font-size: 10px;
        color: var(--nord4);
        margin-bottom: 2px;
    }
    
    /* Required pace */
    .burn-down-pace {
        font-size: 12px;
        font-weight: 700;
        color: var(--nord6);
        margin-bottom: 4px;
    }
    
    /* Pace bar container */
    .pace-bar-container {
        height: 5px;
        background: var(--nord3);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 3px;
    }
    
    .pace-bar {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
        min-width: 2px;
    }
    /* Gauge: show required pace as a fixed marker, actual pace as the bar */
.pace-bar-container {
    height: 6px;                 /* slightly taller so the marker is readable */
    background: var(--nord3);
    border-radius: 3px;
    overflow: visible;            /* allow marker to poke out */
    margin-bottom: 4px;
    position: relative;
}

/* Required marker (always at 100% of required pace) */
.pace-required-marker {
    position: absolute;
    right: 0;
    top: -3px;
    width: 2px;
    height: 12px;
    background: var(--nord6);
    opacity: 0.85;
    border-radius: 1px;
}

/* Actual bar stays inside */
.pace-bar {
    height: 100%;
    border-radius: 3px;
    transition: width 0.3s ease;
    min-width: 2px;
}

/* Status label becomes "BEHIND ¬∑ +$X/day needed" */
.pace-status-label {
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    gap: 6px;
    align-items: baseline;
}

.pace-delta {
    font-size: 9px;
    font-weight: 800;
    letter-spacing: 0.2px;
    opacity: 0.95;
}

/* Delta colors match status */
.pace-ahead .pace-delta { color: var(--nord14); }
.pace-on-track .pace-delta { color: var(--nord13); }
.pace-behind .pace-delta { color: var(--nord11); }
.pace-complete .pace-delta { color: var(--nord8); }

    /* Pace status colors */
    .pace-ahead .pace-bar {
        background: linear-gradient(90deg, var(--nord14) 0%, #8fbf8b 100%);
    }
    
    .pace-on-track .pace-bar {
        background: linear-gradient(90deg, var(--nord13) 0%, #e9c46a 100%);
    }
    
    .pace-behind .pace-bar {
        background: linear-gradient(90deg, var(--nord11) 0%, #e07a5f 100%);
    }
    
    .pace-complete .pace-bar {
        background: var(--nord8);
        width: 100% !important;
    }
    
    /* Status label */
    .pace-status-label {
        font-size: 9px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .pace-ahead .pace-status-label { color: var(--nord14); }
    .pace-on-track .pace-status-label { color: var(--nord13); }
    .pace-behind .pace-status-label { color: var(--nord11); }
    .pace-complete .pace-status-label { color: var(--nord8); }
    
    /* Tooltip on hover */
    .burn-down-cell[data-tooltip] {
        position: relative;
        cursor: help;
    }
    
    .burn-down-cell[data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--nord0);
        color: var(--nord6);
        padding: 10px 14px;
        border-radius: 6px;
        font-size: 11px;
        white-space: pre-line;
        z-index: 1000;
        min-width: 200px;
        text-align: left;
        box-shadow: 0 4px 16px rgba(0,0,0,0.4);
        margin-top: 6px;
        line-height: 1.5;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
        .summary-cards {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .summary-cards {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .planning-controls {
            flex-direction: column;
            gap: 16px;
        }
    }

.modal-sort-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding: 8px 0;
}

.sort-btn {
    padding: 4px 12px;
    border: 1px solid var(--nord4);
    background: white;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.sort-btn:hover {
    background: var(--nord5);
}

.sort-btn.active {
    background: var(--nord8);
    color: white;
    border-color: var(--nord8);
}

.sector-group-header td {
    border-top: 2px solid var(--nord4);
}

.sector-subtotal td {
    border-bottom: 2px solid var(--nord4);
    background: #f8f9fa;
}

.sector-cell {
    font-size: 12px;
    color: #4a5568;
}
</style>
{% endblock %}

{% block content %}
<!-- Planning Controls -->
<div class="planning-controls">
    <div class="control-group">
        <div>
            <label>Planning Year</label>
            <div class="value">{{ planning_year }}</div>
        </div>
        <div>
            <label>Active Planning Window</label>
            <div class="value">
                {{ active_periods[0].display }} ‚Äì {{ active_periods[-1].display }}
            </div>
        </div>
    </div>
    <div class="control-group">
        <div>
            <label>Session Date</label>
            <div class="value">{{ current_date }}</div>
        </div>
        <button class="btn btn-secondary" onclick="exportCSV()">
            Export CSV
        </button>
    </div>
</div>

<!-- Period Legend -->
<div class="period-legend">
    <div class="legend-item">
        <div class="legend-swatch active"></div>
        <span>Active Planning Window</span>
    </div>
    <div class="legend-item">
        <div class="legend-swatch past"></div>
        <span>Closed/Historical Months</span>
    </div>
</div>

<!-- Summary Cards -->
<div class="summary-cards">
    <div class="summary-card">
        <div class="value">${{ "{:,.0f}".format(company.total_budget.amount) }}</div>
        <div class="label">Total Budget</div>
    </div>
    <div class="summary-card">
        <div class="value">${{ "{:,.0f}".format(company.total_booked.amount) }}</div>
        <div class="label">Total Booked</div>
    </div>
    <div class="summary-card">
        <div class="value">${{ "{:,.0f}".format(company.total_forecast.amount) }}</div>
        <div class="label">Total Forecast</div>
    </div>
    <div class="summary-card">
        <div class="value">${{ "{:,.0f}".format(company.total_pipeline.amount) }}</div>
        <div class="label">Total Pipeline</div>
    </div>
    <div class="summary-card {% if company.total_variance.amount >= 0 %}variance-positive{% else %}variance-negative{% endif %}">
        <div class="value">{{ company.total_variance.formatted_with_sign }}</div>
        <div class="label">vs Budget</div>
    </div>
</div>

<!-- Planning Table -->
<div class="planning-table-container">
    <table class="planning-table" id="planningTable">
        <thead>
            <!-- Burn-Down Strip Row -->
            <tr class="burn-down-row">
                <th class="burn-down-label entity-header-col">Booking Pace</th>
                {% for period in all_periods %}
                {% set bd = burn_down.get(period) if burn_down else None %}
                {% set is_active = period in active_periods %}
                <th class="burn-down-cell {% if not is_active %}inactive{% endif %} {% if bd %}{{ bd.pace_status.css_class }}{% endif %} {% if period.month in [3, 6, 9, 12] %}q-end{% endif %}"
                    {% if bd and is_active %}
data-tooltip="Forecast: {{ bd.forecast_total.formatted }}&#10;
Booked: {{ bd.booked_total.formatted }}&#10;
Remaining: {{ bd.remaining_to_forecast.formatted }}&#10;
&#10;
Days elapsed: {{ bd.sellable_days_elapsed }}&#10;
Days left: {{ bd.sellable_days_remaining }}{% if bd.adjustment != 0 %}&#10;
Adjustment: {{ bd.adjustment }} ({{ bd.adjustment_reason or 'manual' }}){% endif %}&#10;
Required: {{ bd.required_pace_formatted }}&#10;
Actual: {{ bd.actual_pace_formatted }}{% if bd.pace_delta_per_day is defined %}&#10;
Delta: +${{ "{:,.1f}".format(bd.pace_delta_per_day/1000) }}k/day needed{% endif %}&#10;
To hit forecast by end of period."

                    {% endif %}>
                    {% if is_active and bd %}
                        <div class="burn-down-days">{{ bd.days_left_text }}</div>
                        <div class="burn-down-pace">{{ bd.required_pace_formatted }}</div>

                        <div class="pace-bar-container">
                            {# Actual pace bar (width is actual/required capped at 100) #}
                            <div class="pace-bar" style="width: {{ bd.pace_bar_percent }}%;"></div>
                            {# Required marker at the far right (100% of required) #}
                            <div class="pace-required-marker" title="Required pace"></div>
                        </div>

                        <div class="pace-status-label">
                            <span>{{ bd.pace_status.label }}</span>

                            {# Operational delta: how much more per day is needed #}
                            {% if bd.pace_status.css_class == 'pace-behind' %}
                                {# Preferred: backend provides bd.pace_delta_per_day (numeric) #}
                                {% if bd.pace_delta_per_day is defined %}
                                    <span class="pace-delta">+${{ "{:,.1f}".format(bd.pace_delta_per_day/1000) }}k/day needed</span>
                                {% elif bd.required_pace is defined and bd.actual_pace is defined %}
                                    {# Fallback: if backend provides numeric required_pace & actual_pace #}
                                    {% set delta = (bd.required_pace - bd.actual_pace) %}
                                    {% if delta > 0 %}
                                        <span class="pace-delta">+${{ "{:,.1f}".format(delta/1000) }}k/day needed</span>
                                    {% endif %}
                                {% endif %}
                            {% elif bd.pace_status.css_class == 'pace-ahead' %}
                                {# Optional: show surplus per day (same numeric requirements as above) #}
                                {% if bd.required_pace is defined and bd.actual_pace is defined %}
                                    {% set surplus = (bd.actual_pace - bd.required_pace) %}
                                    {% if surplus > 0 %}
                                        <span class="pace-delta">+${{ "{:,.1f}".format(surplus/1000) }}k/day ahead</span>
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="burn-down-days" style="opacity: 0.4;">‚Äî</div>
                    {% endif %}

                </th>
                {% endfor %}
                <th class="burn-down-cell total-header" style="opacity: 0.4;">‚Äî</th>
            </tr>
            
            <!-- Month Headers Row -->
            <tr>
                <th class="entity-header-col">AE / Metric</th>
                {% for period in all_periods %}
                <th class="number month-header {% if period.month in [3, 6, 9, 12] %}q-end{% endif %} {% if period in active_periods %}active-period{% endif %}">
                    {{ period.display }}
                </th>
                {% endfor %}
                <th class="number total-header">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for ed in entity_data %}
            <!-- Entity Header -->
            <tr class="entity-header {% if ed.entity.entity_name == 'WorldLink' %}no-sectors{% endif %}" 
                data-entity="{{ ed.entity.entity_name }}"
                onclick="{% if ed.entity.entity_name != 'WorldLink' %}toggleSectorDetail('{{ ed.entity.entity_name }}', {{ planning_year }}){% endif %}">
                <td colspan="1" class="entity-name-cell">
                    <span class="expand-icon">‚ñ∂</span>
                    {{ ed.entity.entity_name }}
                    <span class="entity-badge {{ ed.entity.entity_type }}">{{ ed.entity.entity_type|upper }}</span>
                    <span class="sector-summary-indicator" id="sector-summary-{{ ed.entity.entity_name|replace(' ', '-') }}"></span>
                </td>
                {% for period in all_periods %}
                <td class="number {% if period.month in [3, 6, 9, 12] %}q-end{% endif %} {% if period in active_periods %}active-period{% endif %}"></td>
                {% endfor %}
                <td class="number total-col"></td>
            </tr>
            
            <!-- Budget Row -->
            <tr class="row-budget">
                <td class="row-label entity-name-cell">Budget</td>
                {% for period in all_periods %}
                {% set row = ed.rows_by_period.get(period.key) %}
                <td class="number {% if period.month in [3, 6, 9, 12] %}q-end{% endif %} {% if period in active_periods %}active-period{% endif %}">
                    ${{ "{:,.0f}".format(row.budget.amount if row else 0) }}
                </td>
                {% endfor %}
                <td class="number total-col">${{ "{:,.0f}".format(ed.total_budget.amount) }}</td>
            </tr>
            
            <!-- Booked Row -->
            <tr class="row-booked">
                <td class="row-label entity-name-cell">Booked</td>
                {% for period in all_periods %}
                {% set row = ed.rows_by_period.get(period.key) %}
                {% set booked_amount = row.booked.amount if row else 0 %}
                <td class="number booked-cell {% if period.month in [3, 6, 9, 12] %}q-end{% endif %} {% if period in active_periods %}active-period{% endif %}"
                    {% if booked_amount > 0 %}
                    onclick="showBookedDetail('{{ ed.entity.entity_name }}', {{ period.year }}, {{ period.month }})"
                    title="Click to see customer breakdown"
                    {% endif %}
                    style="{% if booked_amount == 0 %}cursor: default;{% endif %}">
                    ${{ "{:,.0f}".format(booked_amount) }}
                </td>
                {% endfor %}
                <td class="number total-col">${{ "{:,.0f}".format(ed.total_booked.amount) }}</td>
            </tr>

            
            <!-- Forecast Row (Editable) -->
            <tr class="row-forecast">
                <td class="row-label entity-name-cell">Forecast</td>
                {% for period in all_periods %}
                {% set row = ed.rows_by_period.get(period.key) %}
                {% set is_active = period in active_periods %}
                {% set is_past = period in past_periods %}
                {% set booked_exceeds = row and row.is_booked_exceeds_forecast_entered %}
                <td class="number forecast-cell {% if period.month in [3, 6, 9, 12] %}q-end{% endif %} {% if is_active %}active-period{% endif %}">
                    <input type="text" 
                           class="forecast-input {% if row and row.is_forecast_overridden %}modified{% endif %} {% if is_past %}past-month{% endif %} {% if booked_exceeds %}booked-exceeds{% endif %}"
                           data-ae="{{ ed.entity.entity_name }}"
                           data-year="{{ period.year }}"
                           data-month="{{ period.month }}"
                           data-original="{{ row.forecast_entered.amount if row else 0 }}"
                           data-booked="{{ row.booked.amount if row else 0 }}"
                           data-is-past="{{ 'true' if is_past else 'false' }}"
                           value="{{ "{:,.0f}".format(row.forecast.amount if row else 0) }}"
                           {% if is_past %}readonly title="Past month - read only"{% endif %}
                           {% if booked_exceeds %}title="Booked (${{ "{:,.0f}".format(row.booked.amount) }}) exceeds entered forecast. Consider updating."{% endif %}
                           onchange="markModified(this)"
                           onkeydown="handleKeydown(event, this)">
                    {% if row and row.is_forecast_overridden %}
                    <span class="override-indicator" title="Modified from budget"></span>
                    {% endif %}
                    {% if booked_exceeds %}
                    <span class="booked-exceeds-indicator" title="Booked exceeds entered forecast"></span>
                    {% endif %}
                </td>
                {% endfor %}
                <td class="number total-col" id="total-forecast-{{ ed.entity.entity_name|replace(' ', '-') }}">
                    ${{ "{:,.0f}".format(ed.total_forecast.amount) }}
                </td>
            </tr>
            
            <!-- Pipeline Row -->
            <tr class="row-pipeline">
                <td class="row-label entity-name-cell">Pipeline</td>
                {% for period in all_periods %}
                {% set row = ed.rows_by_period.get(period.key) %}
                <td class="number pipeline-value {% if period.month in [3, 6, 9, 12] %}q-end{% endif %} {% if period in active_periods %}active-period{% endif %}">
                    ${{ "{:,.0f}".format(row.pipeline.amount if row else 0) }}
                </td>
                {% endfor %}
                <td class="number total-col pipeline-value">${{ "{:,.0f}".format(ed.total_pipeline.amount) }}</td>
            </tr>
            
            <!-- Variance Row -->
            <tr class="row-variance">
                <td class="row-label entity-name-cell">vs Budget</td>
                {% for period in all_periods %}
                {% set row = ed.rows_by_period.get(period.key) %}
                {% set variance = row.variance_to_budget.amount if row else 0 %}
                <td class="number {% if variance >= 0 %}variance-positive{% else %}variance-negative{% endif %} {% if period.month in [3, 6, 9, 12] %}q-end{% endif %} {% if period in active_periods %}active-period{% endif %}">
                    {{ row.variance_to_budget.formatted_with_sign if row else '+$0' }}
                </td>
                {% endfor %}
                <td class="number total-col {% if ed.total_variance.amount >= 0 %}variance-positive{% else %}variance-negative{% endif %}">
                    {{ ed.total_variance.formatted_with_sign }}
                </td>
            </tr>
            <tbody class="sector-detail-container" id="sector-detail-{{ ed.entity.entity_name|replace(' ', '-') }}">
    <!-- Content loaded via AJAX -->
            </tbody>
            {% endfor %}
            
            <!-- Company Totals -->
            <tr class="totals-row">
                <td class="entity-name-cell">TOTAL</td>
                {% for period in all_periods %}
                {% set p = company.periods_by_key.get(period.key) %}
                <td class="number {% if period.month in [3, 6, 9, 12] %}q-end{% endif %}">
                    ${{ "{:,.0f}".format(p.forecast.amount if p else 0) }}
                </td>
                {% endfor %}
                <td class="number total-col">${{ "{:,.0f}".format(company.total_forecast.amount) }}</td>
            </tr>
        </tbody>
    </table>
    
    <!-- Action Bar -->
    <div class="action-bar">
        <div>
            <span class="status-message" id="statusMessage"></span>
        </div>
        <div class="control-group">
            <span id="changeCount" style="color: #718096; font-size: 13px;"></span>
            <button class="btn btn-secondary" onclick="resetChanges()" id="resetBtn" disabled>
                Reset
            </button>
            <button class="btn btn-primary" onclick="saveChanges()" id="saveBtn" disabled>
                Save All Changes
            </button>
        </div>
    </div>
</div>

<!-- Data Notes -->
<div class="data-notes">
    <strong>Data Notes:</strong> 
    Booked = gross_rate from spots table. 
    Pipeline = Forecast minus Booked. 
    Forecast defaults to Budget until adjusted; auto-floors to Booked if Booked exceeds entered value.
    Yellow highlight indicates modified forecasts.
    Green highlight indicates Booked exceeds entered forecast.
    Blue highlighted columns are the active planning window.
    Grey inputs are closed months (read-only).
    Burn Rate shows required daily pace to hit forecast for active months.
</div>
<!-- Booked Detail Modal -->
<div class="modal-overlay" id="bookedDetailModal" onclick="closeModalOnOverlay(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>
                <span id="modalEntityName">-</span>
                <span class="subtitle" id="modalPeriod">-</span>
            </h3>
            <button class="modal-close" onclick="closeBookedModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <div class="modal-loading">
                <div class="spinner"></div>
                Loading...
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeBookedModal()">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Track changes
const changes = new Map();
const originalValues = new Map();

// Initialize original values
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.forecast-input').forEach(input => {
        const key = getKey(input);
        // Store the entered value (from data-original), not the displayed effective value
        originalValues.set(key, parseNumber(input.dataset.original));
    });
});

function getKey(input) {
    return `${input.dataset.ae}-${input.dataset.year}-${input.dataset.month}`;
}

function parseNumber(str) {
    if (str === null || str === undefined) return 0;
    return parseFloat(String(str).replace(/[$,]/g, '')) || 0;
}

function formatNumber(num) {
    return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
}

function markModified(input) {
    // Don't allow changes to past months
    if (input.dataset.isPast === 'true') {
        return;
    }
    
    const key = getKey(input);
    const enteredValue = parseNumber(input.value);
    const bookedValue = parseNumber(input.dataset.booked || '0');
    const original = originalValues.get(key);
    
    // Effective forecast is max of entered and booked
    // You can't expect less than what you already have
    const effectiveValue = Math.max(enteredValue, bookedValue);
    
    // Display the effective value
    input.value = formatNumber(effectiveValue);
    
    // Track whether booked exceeds what user entered
    if (bookedValue > enteredValue) {
        input.classList.add('booked-exceeds');
        input.title = `Booked ($${formatNumber(bookedValue)}) exceeds entered forecast. Consider updating.`;
    } else {
        input.classList.remove('booked-exceeds');
        input.title = '';
    }
    
    // Compare entered value (not effective) to original for change tracking
    if (enteredValue !== original) {
        input.classList.add('modified');
        input.classList.remove('saved');
        changes.set(key, {
            ae_name: input.dataset.ae,
            year: parseInt(input.dataset.year),
            month: parseInt(input.dataset.month),
            amount: enteredValue  // Save the entered value, not effective
        });
    } else {
        input.classList.remove('modified');
        changes.delete(key);
    }
    
    updateChangeCount();
    recalculateTotals();
}

function handleKeydown(event, input) {
    // Don't allow changes to past months
    if (input.dataset.isPast === 'true') {
        return;
    }
    
    if (event.key === 'Enter') {
        event.preventDefault();
        markModified(input);
        
        // Move to next editable input
        const inputs = Array.from(document.querySelectorAll('.forecast-input:not([readonly])'));
        const currentIndex = inputs.indexOf(input);
        if (currentIndex < inputs.length - 1) {
            inputs[currentIndex + 1].focus();
            inputs[currentIndex + 1].select();
        }
    } else if (event.key === 'Escape') {
        const key = getKey(input);
        const original = originalValues.get(key);
        const bookedValue = parseNumber(input.dataset.booked || '0');
        // Display effective value (max of original entered and booked)
        input.value = formatNumber(Math.max(original, bookedValue));
        input.classList.remove('modified');
        changes.delete(key);
        updateChangeCount();
        recalculateTotals();
    }
}

function updateChangeCount() {
    const count = changes.size;
    const countEl = document.getElementById('changeCount');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    
    if (count > 0) {
        countEl.textContent = `${count} unsaved change${count > 1 ? 's' : ''}`;
        saveBtn.disabled = false;
        resetBtn.disabled = false;
    } else {
        countEl.textContent = '';
        saveBtn.disabled = true;
        resetBtn.disabled = true;
    }
}

function recalculateTotals() {
    // Recalculate entity totals and variances
    document.querySelectorAll('.entity-header').forEach(header => {
        const entityName = header.dataset.entity;
        const inputs = document.querySelectorAll(`.forecast-input[data-ae="${entityName}"]`);
        let totalForecast = 0;
        
        inputs.forEach(input => {
            const displayedValue = parseNumber(input.value);
            const bookedValue = parseNumber(input.dataset.booked || '0');
            totalForecast += Math.max(displayedValue, bookedValue);
            
            // Update variance for this cell
            const budgetCell = input.closest('tr').previousElementSibling.previousElementSibling.previousElementSibling;
            const periodIndex = Array.from(input.closest('td').parentNode.children).indexOf(input.closest('td'));
            
            // Find the variance row and cell for this period
            let varianceRow = input.closest('tr').nextElementSibling.nextElementSibling; // skip pipeline row
            if (varianceRow && varianceRow.classList.contains('row-variance')) {
                const varianceCell = varianceRow.children[periodIndex];
                const budgetRow = input.closest('tr').previousElementSibling.previousElementSibling; // budget is 2 rows up
                const budgetCell = budgetRow.children[periodIndex];
                
                if (varianceCell && budgetCell) {
                    const budgetValue = parseNumber(budgetCell.textContent);
                    const forecastValue = Math.max(displayedValue, bookedValue);
                    const variance = forecastValue - budgetValue;
                    
                    // Update variance display
                    varianceCell.textContent = (variance >= 0 ? '+$' : '-$') + formatNumber(Math.abs(variance));
                    varianceCell.classList.remove('variance-positive', 'variance-negative');
                    varianceCell.classList.add(variance >= 0 ? 'variance-positive' : 'variance-negative');
                }
            }
        });
        
        const totalEl = document.getElementById(`total-forecast-${entityName.replace(/ /g, '-')}`);
        if (totalEl) {
            totalEl.textContent = '$' + formatNumber(totalForecast);
        }
    });
    
    // Recalculate grand total
    let grandTotal = 0;
    document.querySelectorAll('.forecast-input').forEach(input => {
        const displayedValue = parseNumber(input.value);
        const bookedValue = parseNumber(input.dataset.booked || '0');
        grandTotal += Math.max(displayedValue, bookedValue);
    });
}

function resetChanges() {
    changes.forEach((value, key) => {
        const [ae, year, month] = key.split('-');
        const input = document.querySelector(
            `.forecast-input[data-ae="${ae}"][data-year="${year}"][data-month="${month}"]`
        );
        if (input) {
            const original = originalValues.get(key);
            const bookedValue = parseNumber(input.dataset.booked || '0');
            // Display effective value (max of original and booked)
            input.value = formatNumber(Math.max(original, bookedValue));
            input.classList.remove('modified');
            
            // Re-check booked exceeds status
            if (bookedValue > original) {
                input.classList.add('booked-exceeds');
                input.title = `Booked ($${formatNumber(bookedValue)}) exceeds entered forecast. Consider updating.`;
            } else {
                input.classList.remove('booked-exceeds');
                input.title = '';
            }
        }
    });
    
    changes.clear();
    updateChangeCount();
    recalculateTotals();
    showStatus('Changes reset', 'success');
}

async function saveChanges() {
    if (changes.size === 0) return;
    
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
    
    const updates = Array.from(changes.values());
    
    try {
        const response = await fetch('/planning/api/forecast/bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                updates: updates,
                updated_by: 'Planning Session',
                session_notes: `Planning session ${new Date().toISOString().split('T')[0]}`
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Mark all as saved and update original values
            changes.forEach((value, key) => {
                const [ae, year, month] = key.split('-');
                const input = document.querySelector(
                    `.forecast-input[data-ae="${ae}"][data-year="${year}"][data-month="${month}"]`
                );
                if (input) {
                    input.classList.remove('modified');
                    input.classList.add('saved');
                    // Update original to the new entered value
                    originalValues.set(key, value.amount);
                    
                    // Re-check booked exceeds with new value
                    const bookedValue = parseNumber(input.dataset.booked || '0');
                    if (bookedValue > value.amount) {
                        input.classList.add('booked-exceeds');
                        input.title = `Booked ($${formatNumber(bookedValue)}) exceeds entered forecast. Consider updating.`;
                    } else {
                        input.classList.remove('booked-exceeds');
                        input.title = '';
                    }
                }
            });
            
            changes.clear();
            updateChangeCount();
            showStatus(`${updates.length} forecast${updates.length > 1 ? 's' : ''} saved successfully`, 'success');
            
            // Remove saved class after animation
            setTimeout(() => {
                document.querySelectorAll('.forecast-input.saved').forEach(input => {
                    input.classList.remove('saved');
                });
            }, 2000);
        } else {
            showStatus(result.error || 'Failed to save changes', 'error');
        }
    } catch (error) {
        console.error('Save error:', error);
        showStatus('Network error - please try again', 'error');
    } finally {
        saveBtn.disabled = changes.size === 0;
        saveBtn.textContent = 'Save All Changes';
    }
}

function showStatus(message, type) {
    const statusEl = document.getElementById('statusMessage');
    statusEl.textContent = message;
    statusEl.className = `status-message visible ${type}`;
    
    setTimeout(() => {
        statusEl.classList.remove('visible');
    }, 4000);
}

function exportCSV() {
    // Build CSV from current table state
    const table = document.getElementById('planningTable');
    const rows = table.querySelectorAll('tr');
    let csv = [];
    
    rows.forEach(row => {
        // Skip burn-down row in export
        if (row.classList.contains('burn-down-row')) return;
        
        const cells = row.querySelectorAll('th, td');
        const rowData = [];
        cells.forEach(cell => {
            let text = cell.textContent.trim();
            // Handle inputs - get the displayed (effective) value
            const input = cell.querySelector('input');
            if (input) {
                text = input.value;
            }
            // Escape quotes and wrap in quotes if contains comma
            if (text.includes(',') || text.includes('"')) {
                text = '"' + text.replace(/"/g, '""') + '"';
            }
            rowData.push(text);
        });
        csv.push(rowData.join(','));
    });
    
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `planning_session_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (changes.size > 0) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// =========================================================================
// Booked Detail Modal Functions
// =========================================================================

async function showBookedDetail(entityName, year, month) {
    const modal = document.getElementById('bookedDetailModal');
    const modalBody = document.getElementById('modalBody');
    
    // Show modal with loading state
    modal.classList.add('visible');
    document.getElementById('modalEntityName').textContent = entityName;
    document.getElementById('modalPeriod').textContent = 'Loading...';
    modalBody.innerHTML = `
        <div class="modal-loading">
            <div class="spinner"></div>
            Loading customer breakdown...
        </div>
    `;
    
    try {
        const response = await fetch(
    `/reports/planning/api/booked-detail?entity=${encodeURIComponent(entityName)}&year=${year}&month=${month}`
    );
        const result = await response.json();
        
        if (result.success && result.data) {
            renderBookedDetail(result.data);
        } else {
            modalBody.innerHTML = `
                <div class="modal-empty">
                    <p>Unable to load data: ${result.error || 'Unknown error'}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error fetching booked detail:', error);
        modalBody.innerHTML = `
            <div class="modal-empty">
                <p>Network error - please try again</p>
            </div>
        `;
    }
}

let bookedDetailData = null;
let bookedDetailSort = 'customer'; // 'customer' or 'sector'

function renderBookedDetail(data) {
    // Store data for re-sorting
    bookedDetailData = data;
    
    document.getElementById('modalPeriod').textContent = data.period.display;
    const modalBody = document.getElementById('modalBody');
    
    if (data.customers.length === 0) {
        modalBody.innerHTML = `
            <div class="modal-empty">
                <p>No booked revenue for this period</p>
            </div>
        `;
        return;
    }
    
    // Sort customers based on current sort setting
    const sortedCustomers = [...data.customers].sort((a, b) => {
        if (bookedDetailSort === 'sector') {
            // Sort by sector name (nulls last), then by revenue desc
            const sectorA = a.sector_name || 'zzz';
            const sectorB = b.sector_name || 'zzz';
            if (sectorA !== sectorB) return sectorA.localeCompare(sectorB);
            return b.revenue - a.revenue;
        } else {
            // Sort by customer name
            return (a.customer_name || '').localeCompare(b.customer_name || '');
        }
    });
    
    // Build the summary and table
    let html = `
        <div class="modal-summary">
            <div class="modal-summary-item">
                <div class="value">$${formatNumber(data.total_revenue)}</div>
                <div class="label">Total Revenue</div>
            </div>
            <div class="modal-summary-item">
                <div class="value">${data.customer_count}</div>
                <div class="label">Customers</div>
            </div>
            <div class="modal-summary-item">
                <div class="value">${data.total_spots}</div>
                <div class="label">Spots</div>
            </div>
        </div>
        <div class="modal-sort-controls">
            <span style="color: #718096; font-size: 12px;">Sort by:</span>
            <button class="sort-btn ${bookedDetailSort === 'customer' ? 'active' : ''}" onclick="sortBookedDetail('customer')">Customer</button>
            <button class="sort-btn ${bookedDetailSort === 'sector' ? 'active' : ''}" onclick="sortBookedDetail('sector')">Sector</button>
        </div>
        <table class="modal-table">
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Sector</th>
                    <th class="number">Revenue</th>
                    <th class="number">Spots</th>
                    <th class="number">% of Total</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let currentSector = null;
    sortedCustomers.forEach(customer => {
        const pct = data.total_revenue > 0 
            ? (customer.revenue / data.total_revenue * 100).toFixed(1) 
            : 0;
        
        // Add sector subtotal header when sorting by sector
        if (bookedDetailSort === 'sector' && customer.sector_name !== currentSector) {
            if (currentSector !== null) {
                // Add subtotal for previous sector
                const sectorTotal = sortedCustomers
                    .filter(c => c.sector_name === currentSector)
                    .reduce((sum, c) => sum + c.revenue, 0);
                html += `
                    <tr class="sector-subtotal">
                        <td colspan="2" style="text-align: right; font-weight: 600;">Subtotal:</td>
                        <td class="number" style="font-weight: 600;">$${formatNumber(sectorTotal)}</td>
                        <td colspan="2"></td>
                    </tr>
                `;
            }
            currentSector = customer.sector_name;
            html += `
                <tr class="sector-group-header">
                    <td colspan="5" style="background: var(--nord5); font-weight: 600; padding: 8px 12px;">
                        ${customer.sector_name || 'Unassigned'}
                    </td>
                </tr>
            `;
        }
        
        html += `
            <tr>
                <td>
                    <div class="customer-name">${escapeHtml(customer.customer_name)}</div>
                    ${customer.agency_name ? `<div class="agency-name">${escapeHtml(customer.agency_name)}</div>` : ''}
                </td>
                <td class="sector-cell">${customer.sector_name ? escapeHtml(customer.sector_name) : '<span style="color: #999;">‚Äî</span>'}</td>
                <td class="number">$${formatNumber(customer.revenue)}</td>
                <td class="number">${customer.spot_count}</td>
                <td class="number">${pct}%</td>
            </tr>
        `;
    });
    
    // Final subtotal if sorting by sector
    if (bookedDetailSort === 'sector' && currentSector !== null) {
        const sectorTotal = sortedCustomers
            .filter(c => c.sector_name === currentSector)
            .reduce((sum, c) => sum + c.revenue, 0);
        html += `
            <tr class="sector-subtotal">
                <td colspan="2" style="text-align: right; font-weight: 600;">Subtotal:</td>
                <td class="number" style="font-weight: 600;">$${formatNumber(sectorTotal)}</td>
                <td colspan="2"></td>
            </tr>
        `;
    }
    
    html += `
            </tbody>
        </table>
    `;
    
    modalBody.innerHTML = html;
}

function sortBookedDetail(sortBy) {
    bookedDetailSort = sortBy;
    if (bookedDetailData) {
        renderBookedDetail(bookedDetailData);
    }
}

function closeBookedModal() {
    const modal = document.getElementById('bookedDetailModal');
    modal.classList.remove('visible');
}

function closeModalOnOverlay(event) {
    if (event.target === event.currentTarget) {
        closeBookedModal();
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeBookedModal();
    }
});
// Track expanded state and cached data
const sectorDetailCache = {};
const expandedEntities = new Set();

function toggleSectorDetail(entityName, year) {
    const entityKey = entityName.replace(/ /g, '-');
    const container = document.getElementById(`sector-detail-${entityKey}`);
    const header = document.querySelector(`.entity-header[data-entity="${entityName}"]`);
    
    if (!container || !header) return;
    
    if (expandedEntities.has(entityName)) {
        // Collapse
        container.classList.remove('expanded');
        header.classList.remove('expanded');
        expandedEntities.delete(entityName);
    } else {
        // Expand
        header.classList.add('expanded');
        expandedEntities.add(entityName);
        
        // Check cache first
        if (sectorDetailCache[entityName]) {
            renderSectorDetail(entityName, sectorDetailCache[entityName]);
            container.classList.add('expanded');
        } else {
            // Show loading state
            container.innerHTML = `
                <tr class="sector-detail-row">
                    <td colspan="${document.querySelectorAll('.planning-table thead th').length}" class="sector-loading">
                        Loading sector detail
                    </td>
                </tr>
            `;
            container.classList.add('expanded');
            
            // Fetch data
            fetchSectorDetail(entityName, year);
        }
    }
}

async function fetchSectorDetail(entityName, year) {
    try {
        const response = await fetch(`/planning/api/sector-detail/${encodeURIComponent(entityName)}/${year}`);
        const result = await response.json();
        
        if (result.success) {
            sectorDetailCache[entityName] = result.data;
            renderSectorDetail(entityName, result.data);
        } else {
            renderSectorError(entityName, result.error || 'Failed to load sector data');
        }
    } catch (error) {
        renderSectorError(entityName, 'Network error loading sector data');
    }
}

function renderSectorDetail(entityName, data) {
    const entityKey = entityName.replace(/ /g, '-');
    const container = document.getElementById(`sector-detail-${entityKey}`);
    if (!container) return;
    
    // Get the month columns from the main table header
    const periods = Array.from(document.querySelectorAll('.planning-table thead th'))
        .slice(1, -1) // Remove first (entity) and last (total) columns
        .map((th, idx) => idx + 1); // 1-12 for months
    
    let html = '';
    
    // Header row
    html += `
        <tr class="sector-detail-row sector-detail-header">
            <td class="sector-name-cell">Sector Breakdown</td>
            ${periods.map(m => `<td class="number">Expected / Booked</td>`).join('')}
            <td class="number total-col">Total Gap</td>
        </tr>
    `;
    
    if (!data.has_sector_expectations && data.sectors.length === 0) {
        html += `
            <tr class="sector-detail-row">
                <td colspan="${periods.length + 2}" style="text-align: center; padding: 16px; color: #718096;">
                    No sector expectations or booked revenue by sector
                </td>
            </tr>
        `;
    } else if (!data.has_sector_expectations) {
        html += `
            <tr class="sector-detail-row">
                <td colspan="${periods.length + 2}" style="text-align: center; padding: 16px; color: #718096;">
                    No sector expectations defined - showing booked revenue only
                </td>
            </tr>
        `;
    }
    
    // Sector rows
    data.sectors.forEach(sector => {
        const gapClass = sector.total_gap > 0 ? 'gap-positive' : 
                        sector.total_gap < 0 ? 'gap-negative' : 'gap-neutral';
        const gapSign = sector.total_gap >= 0 ? '+' : '';
        
        html += `
            <tr class="sector-detail-row">
                <td class="sector-name-cell">${sector.sector_name}</td>
                ${periods.map(m => {
                    const monthData = sector.months[m] || { expected: 0, booked: 0, gap: 0 };
                    const cellGapClass = monthData.gap > 0 ? 'gap-positive' : 
                                        monthData.gap < 0 ? 'gap-negative' : 'gap-neutral';
                    return `
                        <td class="number">
                            <span style="color: #718096;">$${formatNumber(monthData.expected)}</span>
                            <span style="margin: 0 4px;">/</span>
                            <span class="${cellGapClass}">$${formatNumber(monthData.booked)}</span>
                        </td>
                    `;
                }).join('')}
                <td class="number total-col ${gapClass}">
                    ${gapSign}$${formatNumber(Math.abs(sector.total_gap))}
                </td>
            </tr>
        `;
    });
    
    // Total row
    if (data.sectors.length > 0) {
        const totalGapClass = data.total_gap > 0 ? 'gap-positive' : 
                             data.total_gap < 0 ? 'gap-negative' : 'gap-neutral';
        const totalGapSign = data.total_gap >= 0 ? '+' : '';
        
        html += `
            <tr class="sector-detail-row" style="background: var(--nord5); font-weight: 600;">
                <td class="sector-name-cell">Total</td>
                ${periods.map(m => {
                    let monthExpected = 0, monthBooked = 0;
                    data.sectors.forEach(s => {
                        const md = s.months[m] || { expected: 0, booked: 0 };
                        monthExpected += md.expected;
                        monthBooked += md.booked;
                    });
                    return `
                        <td class="number">
                            <span style="color: #718096;">$${formatNumber(monthExpected)}</span>
                            <span style="margin: 0 4px;">/</span>
                            <span>$${formatNumber(monthBooked)}</span>
                        </td>
                    `;
                }).join('')}
                <td class="number total-col ${totalGapClass}">
                    ${totalGapSign}$${formatNumber(Math.abs(data.total_gap))}
                </td>
            </tr>
        `;
    }
    
    container.innerHTML = html;
}

function renderSectorError(entityName, message) {
    const entityKey = entityName.replace(/ /g, '-');
    const container = document.getElementById(`sector-detail-${entityKey}`);
    if (!container) return;
    
    container.innerHTML = `
        <tr class="sector-detail-row">
            <td colspan="${document.querySelectorAll('.planning-table thead th').length}" 
                style="text-align: center; padding: 16px; color: var(--nord11);">
                ${message}
            </td>
        </tr>
    `;
}

// Load sector summaries on page load
async function loadSectorSummaries(year) {
    try {
        const response = await fetch(`/planning/api/sector-summary/${year}`);
        const result = await response.json();
        
        if (result.success) {
            Object.entries(result.summaries).forEach(([ae, summary]) => {
                const el = document.getElementById(`sector-summary-${ae.replace(/ /g, '-')}`);
                if (el && summary) {
                    el.innerHTML = `<span class="gap-indicator">${summary}</span>`;
                }
            });
        }
    } catch (error) {
        console.error('Failed to load sector summaries:', error);
    }
}

// Call on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSectorSummaries({{ planning_year }});
});
</script>
{% endblock %}